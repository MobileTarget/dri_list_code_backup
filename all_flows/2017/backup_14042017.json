[
    {
        "id": "662b971b.e02a68",
        "type": "tab",
        "label": "User Screen"
    },
    {
        "id": "30b56e49.7dc182",
        "type": "tab",
        "label": "Location Screen"
    },
    {
        "id": "7d73ba45.c80ab4",
        "type": "tab",
        "label": "Template Screen"
    },
    {
        "id": "d9e3488f.8f93b8",
        "type": "tab",
        "label": "Task Screen"
    },
    {
        "id": "57a35ec7.3182f",
        "type": "tab",
        "label": "Timeout Screen"
    },
    {
        "id": "7fce52ea.7e640c",
        "type": "tab",
        "label": "Big Record Table"
    },
    {
        "id": "a164a1e3.d69",
        "type": "tab",
        "label": "Detail Screen"
    },
    {
        "id": "3b9a3280.9d537e",
        "type": "tab",
        "label": "Details -- actual"
    },
    {
        "id": "b36c2dc1.25c34",
        "type": "tab",
        "label": "Genernal Api's"
    },
    {
        "id": "c80a9dd2.e75c1",
        "type": "tab",
        "label": "2. Get Page -- niklas"
    },
    {
        "id": "b36c258c.f48c68",
        "type": "tab",
        "label": "Get token-Niklas"
    },
    {
        "id": "505a09c5.621328",
        "type": "tab",
        "label": "1. Login API --niklas"
    },
    {
        "id": "f92f7e23.5ef5b",
        "type": "tab",
        "label": "Central Api"
    },
    {
        "id": "a38007c3.b0ee68",
        "type": "subflow",
        "name": "F to C",
        "info": "",
        "in": [
            {
                "x": 44,
                "y": 63,
                "wires": [
                    {
                        "id": "2eb2b368.8322ec"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 309,
                "y": 57,
                "wires": [
                    {
                        "id": "2eb2b368.8322ec",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "a4a278a8.fe0848",
        "type": "subflow",
        "name": "dimmer to switch",
        "info": "",
        "in": [
            {
                "x": 25,
                "y": 86,
                "wires": [
                    {
                        "id": "f7272181.dd58e"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 437,
                "y": 83,
                "wires": [
                    {
                        "id": "f7272181.dd58e",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "61a5aa7a.4c84c4",
        "type": "subflow",
        "name": "currState to payload",
        "info": "",
        "in": [
            {
                "x": 139,
                "y": 133,
                "wires": [
                    {
                        "id": "e6a2312.44f20d"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 448,
                "y": 131,
                "wires": [
                    {
                        "id": "e6a2312.44f20d",
                        "port": 0
                    }
                ]
            }
        ]
    },
    {
        "id": "75b71eb6.4ae56",
        "type": "websocket-listener",
        "z": "",
        "path": "",
        "wholemsg": "false"
    },
    {
        "id": "c4fcd744.cdabe8",
        "type": "twilio-api",
        "z": "",
        "sid": "AC909f1981261f4461abbc7985bd202897",
        "from": "+15103067839",
        "name": "Twilio Chatbot1"
    },
    {
        "id": "df85784.deb9a88",
        "type": "twilio-api",
        "z": "",
        "sid": "AC909f1981261f4461abbc7985bd202897",
        "from": "+15103067839",
        "name": "Twilio Chatbot1"
    },
    {
        "id": "8256f452.e40578",
        "type": "twilio-api",
        "z": "",
        "sid": "AC909f1981261f4461abbc7985bd202897",
        "from": "+15103067839",
        "name": "Twilio Chatbot1"
    },
    {
        "id": "f21375e6.0c0388",
        "type": "websocket-listener",
        "z": "",
        "path": "/ws/chat",
        "wholemsg": "false"
    },
    {
        "id": "b1b06246.0977a",
        "type": "ui_base",
        "theme": {
            "name": "theme-dark",
            "lightTheme": {
                "default": "#0094CE",
                "baseColor": "#0094CE",
                "baseFont": "Helvetica Neue",
                "edited": true,
                "reset": false
            },
            "darkTheme": {
                "default": "#097479",
                "baseColor": "#097479",
                "baseFont": "Helvetica Neue",
                "edited": true,
                "reset": false
            },
            "customTheme": {
                "name": "Untitled Theme 1",
                "default": "#4B7930",
                "baseColor": "#4B7930",
                "baseFont": "Helvetica Neue"
            },
            "themeState": {
                "base-color": {
                    "default": "#097479",
                    "value": "#097479",
                    "edited": false
                },
                "page-titlebar-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "page-backgroundColor": {
                    "value": "#111111",
                    "edited": false
                },
                "page-sidebar-backgroundColor": {
                    "value": "#000000",
                    "edited": false
                },
                "group-textColor": {
                    "value": "#10cfd8",
                    "edited": false
                },
                "group-borderColor": {
                    "value": "#555555",
                    "edited": false
                },
                "group-backgroundColor": {
                    "value": "#333333",
                    "edited": false
                },
                "widget-textColor": {
                    "value": "#eeeeee",
                    "edited": false
                },
                "widget-backgroundColor": {
                    "value": "#097479",
                    "edited": false
                },
                "widget-borderColor": {
                    "value": "#333333",
                    "edited": false
                }
            }
        },
        "site": {
            "name": "Node-RED Dashboard",
            "hideToolbar": "false",
            "allowSwipe": "false",
            "dateFormat": "DD/MM/YYYY",
            "sizes": {
                "sx": 48,
                "sy": 48,
                "gx": 6,
                "gy": 6,
                "cx": 6,
                "cy": 6,
                "px": 0,
                "py": 0
            }
        }
    },
    {
        "id": "1bd51bb9.ae7d24",
        "type": "ui_tab",
        "z": "",
        "name": "User Form Tab",
        "icon": "dashboard",
        "order": 1
    },
    {
        "id": "c9b5c240.9166e",
        "type": "ui_group",
        "z": "662b971b.e02a68",
        "name": "Form",
        "tab": "1bd51bb9.ae7d24",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "5fa0db32.5a8624",
        "type": "ui_group",
        "z": "30b56e49.7dc182",
        "name": "Location Form",
        "tab": "",
        "disp": false,
        "width": "9"
    },
    {
        "id": "7b59d779.f66738",
        "type": "ui_tab",
        "z": "30b56e49.7dc182",
        "name": "Location Form",
        "icon": "dashboard",
        "order": 2
    },
    {
        "id": "9245592b.d1e4f8",
        "type": "ui_group",
        "z": "30b56e49.7dc182",
        "name": "Location",
        "tab": "7b59d779.f66738",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "b2135a9e.4c9988",
        "type": "ui_tab",
        "z": "",
        "name": "Template Form",
        "icon": "dashboard",
        "order": 3
    },
    {
        "id": "4d3cad8b.f40864",
        "type": "ui_group",
        "z": "7d73ba45.c80ab4",
        "name": "Template",
        "tab": "b2135a9e.4c9988",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "d0242660.cf9398",
        "type": "ui_group",
        "z": "d9e3488f.8f93b8",
        "name": "Task",
        "tab": "",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "b192884e.b0a068",
        "type": "ui_group",
        "z": "",
        "name": "Task",
        "tab": "",
        "order": 1,
        "disp": true,
        "width": "6"
    },
    {
        "id": "8f59afc3.dc37b",
        "type": "ui_tab",
        "z": "",
        "name": "Timeout Screen",
        "icon": "dashboard",
        "order": 5
    },
    {
        "id": "e90a8654.6407c8",
        "type": "ui_group",
        "z": "57a35ec7.3182f",
        "name": "Timeout",
        "tab": "8f59afc3.dc37b",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "f004ae97.62a33",
        "type": "ui_tab",
        "z": "",
        "name": "Detail Screen",
        "icon": "dashboard",
        "order": 6
    },
    {
        "id": "e8b5a7d3.af2da8",
        "type": "ui_group",
        "z": "a164a1e3.d69",
        "name": "Detail",
        "tab": "f004ae97.62a33",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "9a9b7181.f3ccf",
        "type": "ui_tab",
        "z": "",
        "name": "Big record table",
        "icon": "dashboard",
        "order": 7
    },
    {
        "id": "605089c4.c715b8",
        "type": "ui_group",
        "z": "7fce52ea.7e640c",
        "name": "Big record table",
        "tab": "9a9b7181.f3ccf",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "d173f1a2.6f3b7",
        "type": "ui_group",
        "z": "d9e3488f.8f93b8",
        "name": "Task",
        "tab": "11c817eb.e94a08",
        "order": 1,
        "disp": false,
        "width": "9"
    },
    {
        "id": "11c817eb.e94a08",
        "type": "ui_tab",
        "z": "",
        "name": "Task Screen",
        "icon": "dashboard",
        "order": 4
    },
    {
        "id": "1aee3610.c8baea",
        "type": "mqtt-broker",
        "z": "",
        "broker": "test.mosquitto.com",
        "port": "8883",
        "clientid": "",
        "usetls": true,
        "verifyservercert": true,
        "compatmode": false,
        "keepalive": "15",
        "cleansession": true,
        "willTopic": "",
        "willQos": "0",
        "willRetain": null,
        "willPayload": "",
        "birthTopic": "",
        "birthQos": "0",
        "birthRetain": null,
        "birthPayload": ""
    },
    {
        "id": "5281de41.649f",
        "type": "cloudant",
        "z": "",
        "host": "http://127.0.0.1",
        "name": "timeout-api-cloudantNoSQLDB"
    },
    {
        "id": "76512216.4472ac",
        "type": "cloudant",
        "z": "",
        "host": "http://127.0.0.1",
        "name": "timeout-api-cloudantNoSQLDB"
    },
    {
        "id": "9cf87311.0014a",
        "type": "twilio-api",
        "z": "",
        "sid": "AC71948e10a2402ce138d9b46e789254b2",
        "from": "12317146495",
        "name": "Twilio SMS NoteToSelf"
    },
    {
        "id": "5e923e83.d5527",
        "type": "cloudant",
        "z": "",
        "host": "http://127.0.0.1",
        "name": "timeout-api-cloudantNoSQLDB"
    },
    {
        "id": "fb3b3fd8.2739",
        "type": "ui_form",
        "z": "662b971b.e02a68",
        "name": "User Form",
        "label": "",
        "group": "c9b5c240.9166e",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "First Name",
                "value": "f_name",
                "type": "text",
                "required": false
            },
            {
                "label": "Last Name",
                "value": "l_name",
                "type": "text",
                "required": false
            },
            {
                "label": "Email",
                "value": "email",
                "type": "email",
                "required": true
            },
            {
                "label": "Phone",
                "value": "phone",
                "type": "number",
                "required": true
            },
            {
                "label": "Password",
                "value": "password",
                "type": "password",
                "required": true
            }
        ],
        "formValue": {
            "_id": "",
            "f_name": "",
            "l_name": "",
            "email": "",
            "phone": "",
            "password": ""
        },
        "payload": "",
        "topic": "user_form_data",
        "x": 95,
        "y": 71,
        "wires": [
            [
                "5cd0ae1f.4dd47"
            ]
        ]
    },
    {
        "id": "5cd0ae1f.4dd47",
        "type": "change",
        "z": "662b971b.e02a68",
        "name": "Move to User_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "user_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 202,
        "y": 298,
        "wires": [
            [
                "19bac9c9.70f2f6"
            ]
        ]
    },
    {
        "id": "19bac9c9.70f2f6",
        "type": "function",
        "z": "662b971b.e02a68",
        "name": "Merge",
        "func": "\nif(msg.user_data){\n    if(msg.user_data._id){\n        msg.status = \"find_from_db\";\n        msg.payload = {\"_id\": msg.user_data._id};\n    }else{\n        msg.status = \"save_into_db\";\n        msg.payload = {\n            long_url            : null,\n            access_token        : access_token(),\n            security_level      : msg.user_data.security_level || 0,\n            virtual_phone       : msg.user_data.phone,\n            email               : msg.user_data.email,\n            converstation_id    : null,\n            first_name          : msg.user_data.f_name,\n            last_name           : msg.user_data.l_name,\n            code                : null,\n            password            : msg.user_data.password,\n            image               : msg.user_data.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\"\n        };\n    }\n}\n\nreturn msg;\n\nfunction rand() {\n    return Math.random().toString(36).substr(2); // remove `0.`\n}\n\nfunction time() {\n    //return new Date().getTime().toString(36);\n    return new Date().getTime();\n}\n\nfunction access_token() {\n    return time()+'.'+rand(); // to make it longer\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 336,
        "y": 166,
        "wires": [
            [
                "472d2dc8.9e7c94"
            ]
        ]
    },
    {
        "id": "472d2dc8.9e7c94",
        "type": "switch",
        "z": "662b971b.e02a68",
        "name": "Switch",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "find_from_db",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "save_into_db",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 437,
        "y": 297,
        "wires": [
            [
                "10385e2f.abcb02"
            ],
            [
                "a05e2317.d1831"
            ]
        ]
    },
    {
        "id": "a05e2317.d1831",
        "type": "cloudant out",
        "z": "662b971b.e02a68",
        "name": "Save User to database",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 733,
        "y": 393,
        "wires": []
    },
    {
        "id": "10385e2f.abcb02",
        "type": "cloudant in",
        "z": "662b971b.e02a68",
        "name": "Get user by Id",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 565,
        "y": 166,
        "wires": [
            [
                "41d2efbd.820e5"
            ]
        ]
    },
    {
        "id": "41d2efbd.820e5",
        "type": "change",
        "z": "662b971b.e02a68",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 727,
        "y": 64,
        "wires": [
            [
                "35dc3ff9.b4b05"
            ]
        ]
    },
    {
        "id": "35dc3ff9.b4b05",
        "type": "function",
        "z": "662b971b.e02a68",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output, form_data = msg.user_data, payload = {};\n\nif(check_obj(db_data) > 0){\n    payload = {\n        _id : db_data._id,\n        _rev : db_data._rev,\n        long_url : form_data.long_url || db_data.long_url,\n        access_token : access_token(),\n        security_level : form_data.security_level || db_data.security_level,\n        virtual_phone: form_data.phone || db_data.phone,\n        email: form_data.email || db_data.email,\n        converstation_id : form_data.converstation_id || db_data.converstation_id,\n        first_name : form_data.f_name || db_data.first_name,\n        last_name: form_data.l_name || db_data.last_name ,\n        code: form_data.code || db_data.code ,\n        password: form_data.password || db_data.password,\n        type: {\"public\": \"public\"},\n        image: form_data.image || \"img/default.png\"\n    };\n}else{\n    payload = {\n        long_url : form_data.long_url ,\n        access_token : access_token(),\n        security_level : 1,\n        virtual_phone: form_data.phone,\n        email: form_data.email,\n        converstation_id : form_data.converstation_id,\n        first_name : form_data.f_name,\n        last_name: form_data.l_name,\n        code: form_data.code,\n        password: form_data.password,\n        type: {\"public\": \"public\"},\n        image: form_data.image || \"img/default.png\"\n    };\n}\n\nmsg.payload = payload ;\nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\nfunction rand() {\n    return Math.random().toString(36).substr(2); // remove `0.`\n}\n\nfunction time() {\n    //return new Date().getTime().toString(36);\n    return new Date().getTime();\n}\n\nfunction access_token() {\n    return time()+'.'+rand(); // to make it longer\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 737,
        "y": 294,
        "wires": [
            [
                "a05e2317.d1831"
            ]
        ]
    },
    {
        "id": "edf0f2a0.91cdb",
        "type": "ui_form",
        "z": "30b56e49.7dc182",
        "name": "Location Form ",
        "label": "",
        "group": "9245592b.d1e4f8",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Name",
                "value": "name",
                "type": "text",
                "required": true
            },
            {
                "label": "Type",
                "value": "type",
                "type": "text",
                "required": true
            },
            {
                "label": "Latitude",
                "value": "lat",
                "type": "text",
                "required": true
            },
            {
                "label": "Longitutude",
                "value": "lon",
                "type": "text",
                "required": true
            },
            {
                "label": "Distance",
                "value": "dist",
                "type": "number",
                "required": false
            },
            {
                "label": "Web Url",
                "value": "web",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "name": "",
            "type": "",
            "lat": "",
            "lon": "",
            "dist": "",
            "web": ""
        },
        "payload": "",
        "topic": "location_from_data",
        "x": 94,
        "y": 64,
        "wires": [
            [
                "e50e51f9.a80fb"
            ]
        ]
    },
    {
        "id": "e50e51f9.a80fb",
        "type": "change",
        "z": "30b56e49.7dc182",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "location_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 192,
        "y": 218,
        "wires": [
            [
                "9206f563.2f9c48"
            ]
        ]
    },
    {
        "id": "9206f563.2f9c48",
        "type": "function",
        "z": "30b56e49.7dc182",
        "name": "Merge",
        "func": "if(msg.location_data){\n    if(msg.location_data._id){\n        msg.status = \"find_from_db\";\n        msg.payload = {\"_id\": msg.location_data._id};\n    }else{\n        msg.status = \"save_into_db\";\n        msg.payload = {\n            location_name : msg.location_data.name,\n            location_type : msg.location_data.type,\n            location_data : {\n                lat : msg.location_data.lat ? Number(msg.location_data.lat) : 0,\n                lon : msg.location_data.lon ? Number(msg.location_data.lon) : 0,\n                dist: msg.location_data.dist ? Number(msg.location_data.dist) : 0,\n                web: msg.location_data.web\n            }\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 327,
        "y": 135,
        "wires": [
            [
                "9007f34d.96a0e"
            ]
        ]
    },
    {
        "id": "9007f34d.96a0e",
        "type": "switch",
        "z": "30b56e49.7dc182",
        "name": "Switch",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "find_from_db",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "save_into_db",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 421,
        "y": 278,
        "wires": [
            [
                "9bd84e9d.8d399"
            ],
            [
                "12b05c4.51a23a4"
            ]
        ]
    },
    {
        "id": "12b05c4.51a23a4",
        "type": "cloudant out",
        "z": "30b56e49.7dc182",
        "name": "Save to Database",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 717,
        "y": 510,
        "wires": []
    },
    {
        "id": "9bd84e9d.8d399",
        "type": "cloudant in",
        "z": "30b56e49.7dc182",
        "name": "Get Loation by Id",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 539,
        "y": 145,
        "wires": [
            [
                "33360866.80edb8"
            ]
        ]
    },
    {
        "id": "33360866.80edb8",
        "type": "change",
        "z": "30b56e49.7dc182",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 714,
        "y": 55,
        "wires": [
            [
                "1f9f7129.cf579f"
            ]
        ]
    },
    {
        "id": "1f9f7129.cf579f",
        "type": "function",
        "z": "30b56e49.7dc182",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output, form_data = msg.location_data, payload = {};\n\nif(check_obj(db_data) > 0){\n    payload = {\n        _id : db_data._id,\n        _rev : db_data._rev,\n        location_name : form_data.name || db_data.location_name,\n        location_type : form_data.type || db_data.location_type,\n        location_data : {\n            lat : form_data.lat || db_data.location_data.lat,\n            lon : form_data.lon || db_data.location_data.lon,\n            dist: form_data.dist || db_data.location_data.dist,\n            web: form_data.web || db_data.location_data.web\n        }\n    };\n}else{\n    payload = {\n        location_name : form_data.name,\n        location_type : form_data.type,\n        location_data : {\n            lat : form_data.lat,\n            lon : form_data.lon,\n            dist: form_data.dist,\n            web: form_data.web\n        }\n    };\n}\n\nmsg.payload = payload ;\nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 672,
        "y": 237,
        "wires": [
            [
                "12b05c4.51a23a4"
            ]
        ]
    },
    {
        "id": "d72e917a.2ead1",
        "type": "ui_form",
        "z": "7d73ba45.c80ab4",
        "name": "Template Form",
        "label": "",
        "group": "4d3cad8b.f40864",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Name",
                "value": "name",
                "type": "text",
                "required": true
            },
            {
                "label": "HTML",
                "value": "html",
                "type": "text",
                "required": false
            },
            {
                "label": "Js",
                "value": "js",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "name": "",
            "html": "",
            "js": ""
        },
        "payload": "",
        "topic": "template_form_data",
        "x": 95,
        "y": 150,
        "wires": [
            [
                "7f2f58c9.0f13d8"
            ]
        ]
    },
    {
        "id": "7f2f58c9.0f13d8",
        "type": "change",
        "z": "7d73ba45.c80ab4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "template_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 166,
        "y": 247,
        "wires": [
            [
                "8576d2b2.a4046"
            ]
        ]
    },
    {
        "id": "8576d2b2.a4046",
        "type": "function",
        "z": "7d73ba45.c80ab4",
        "name": "Merge",
        "func": "if(msg.template_data){\n    if(msg.template_data._id){\n        msg.status = \"find_from_db\";\n        msg.payload = {\"_id\": msg.template_data._id};\n    }else{\n        msg.status = \"save_into_db\";\n        msg.payload = {\n            name        : msg.template_data.name || \"\",\n            html        : msg.template_data.html || \"\",\n            js          : msg.template_data.js   || \"\"\n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 306,
        "y": 90,
        "wires": [
            [
                "f477ee9d.10865"
            ]
        ]
    },
    {
        "id": "f477ee9d.10865",
        "type": "switch",
        "z": "7d73ba45.c80ab4",
        "name": "Switch",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "find_from_db",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "save_into_db",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 404,
        "y": 246,
        "wires": [
            [
                "e8918fe4.7a611"
            ],
            [
                "fc25bd10.3588e"
            ]
        ]
    },
    {
        "id": "fc25bd10.3588e",
        "type": "cloudant out",
        "z": "7d73ba45.c80ab4",
        "name": "Save to Database",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 770,
        "y": 458,
        "wires": []
    },
    {
        "id": "e8918fe4.7a611",
        "type": "cloudant in",
        "z": "7d73ba45.c80ab4",
        "name": "Get Template by Id",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 508,
        "y": 148,
        "wires": [
            [
                "3609659.cbe2e9a"
            ]
        ]
    },
    {
        "id": "3609659.cbe2e9a",
        "type": "change",
        "z": "7d73ba45.c80ab4",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 672,
        "y": 47,
        "wires": [
            [
                "e140c976.105978"
            ]
        ]
    },
    {
        "id": "e140c976.105978",
        "type": "function",
        "z": "7d73ba45.c80ab4",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output, form_data = msg.template_data, payload = {};\n\nif(check_obj(db_data) > 0){\n    payload = {\n        _id : db_data._id,\n        _rev : db_data._rev,\n        template_id : form_data.template_id || db_data.template_id,\n        name        : form_data.name || db_data.name,\n        html        : form_data.html || db_data.html,\n        js          : form_data.js   || db_data.js\n    };\n}else{\n    payload = {\n        template_id : form_data.template_id,\n        name        : form_data.name,\n        html        : form_data.html,\n        js          : form_data.js \n    };\n}\n\nmsg.payload = payload ;\nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 663,
        "y": 243,
        "wires": [
            [
                "fc25bd10.3588e"
            ]
        ]
    },
    {
        "id": "8246f8b3.60a1a8",
        "type": "ui_form",
        "z": "57a35ec7.3182f",
        "name": "Timeout Screen",
        "label": "",
        "group": "e90a8654.6407c8",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Name",
                "value": "name",
                "type": "text",
                "required": true
            },
            {
                "label": "Delivery Count",
                "value": "delivery_count",
                "type": "number",
                "required": false
            },
            {
                "label": "Delivery Status",
                "value": "delivery_status",
                "type": "text",
                "required": false
            },
            {
                "label": "Delivery Due",
                "value": "delivery_due",
                "type": "text",
                "required": false
            },
            {
                "label": "Delivery User Id",
                "value": "delivery_user_ids",
                "type": "text",
                "required": false
            },
            {
                "label": "Delivery Via",
                "value": "delivery_via",
                "type": "text",
                "required": false
            },
            {
                "label": "Delivery Task Id",
                "value": "delivery_task_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Message Id",
                "value": "message_id",
                "type": "text",
                "required": false
            },
            {
                "label": "From User",
                "value": "from_user_id",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "name": "",
            "delivery_count": "",
            "delivery_status": "",
            "delivery_due": "",
            "delivery_user_ids": "",
            "delivery_via": "",
            "delivery_task_id": "",
            "message_id": "",
            "from_user_id": ""
        },
        "payload": "",
        "topic": "timeout_data",
        "x": 101,
        "y": 107,
        "wires": [
            [
                "aa7e5fdb.c0f59"
            ]
        ]
    },
    {
        "id": "aa7e5fdb.c0f59",
        "type": "change",
        "z": "57a35ec7.3182f",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "timeout_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 195,
        "y": 185,
        "wires": [
            [
                "be144762.cf97b8"
            ]
        ]
    },
    {
        "id": "be144762.cf97b8",
        "type": "function",
        "z": "57a35ec7.3182f",
        "name": "Merge",
        "func": "if(msg.timeout_data){\n    if(msg.timeout_data._id){\n        msg.status = \"find_from_db\";\n        msg.payload = {_id: msg.timeout_data._id};\n    }else{\n        msg.status = \"save_into_db\";\n        msg.payload = {\n            name: msg.timeout_data.name || null,\n            timeout_list: create_delivery_obj(msg) \n        };\n    }\n}\n\nreturn msg;\n\nfunction create_delivery_obj(msg){\n    var obj = {};\n    var user_id = msg.timeout_data.delivery_user_ids ? msg.timeout_data.delivery_user_ids.split(',') : null;\n    \n    for(var i=0; i < msg.timeout_data.delivery_count; i++){\n        obj[i] = {\n            delivery_count      : i , \n            delivery_status     : msg.timeout_data.delivery_status || false, \n            delivery_due        : msg.timeout_data.delivery_due || new Date.toJSON(),\n            delivery_user_ids   : user_id[i] ? user_id[i] : msg.timeout_data.delivery_user_ids,\n            delivery_via        : msg.timeout_data.delivery_via || null,\n            delivery_task_id    : msg.timeout_data.delivery_task_id || null,\n            delivery_task_name  : msg.timeout_data.delivery_task_name || null, \n            message_id          : msg.timeout_data.message_id || null,\n            from_user_id        : msg.timeout_data.from_user_id || null\n        };\n    }\n    return obj ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 327,
        "y": 87,
        "wires": [
            [
                "29b6e122.4b2bce"
            ]
        ]
    },
    {
        "id": "29b6e122.4b2bce",
        "type": "switch",
        "z": "57a35ec7.3182f",
        "name": "Switch",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "find_from_db",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "save_into_db",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 372,
        "y": 244,
        "wires": [
            [
                "e4d4e90f.c5d258"
            ],
            [
                "a1ed3625.da5a58",
                "d572bac9.90a018"
            ]
        ]
    },
    {
        "id": "e4d4e90f.c5d258",
        "type": "cloudant in",
        "z": "57a35ec7.3182f",
        "name": "Get Timeout by Id",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 534,
        "y": 56,
        "wires": [
            [
                "b91b17f7.643568"
            ]
        ]
    },
    {
        "id": "b91b17f7.643568",
        "type": "change",
        "z": "57a35ec7.3182f",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 658,
        "y": 133,
        "wires": [
            [
                "a7cfdad4.e6cec8"
            ]
        ]
    },
    {
        "id": "a7cfdad4.e6cec8",
        "type": "function",
        "z": "57a35ec7.3182f",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output, form_data = msg.timeout_data, payload = {};\n\nif(check_obj(db_data) > 0){\n    payload = {\n        _id : db_data._id,\n        _rev : db_data._rev,\n        name: form_data.name || db_data.name,\n        timeout_list: create_delivery_obj(msg) \n    };\n}else{\n    payload = {\n        name: form_data.name ,\n        timeout_list: create_delivery_obj(msg) \n    };\n    \n}\n\nmsg.payload = payload ;\nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\n\nfunction create_delivery_obj(msg){\n    var obj = {};\n    var user_id = msg.timeout_data.delivery_user_ids.split(',') ;\n    \n    for(var i=0; i < msg.timeout_data.delivery_count; i++){\n        obj[i] = {\n            delivery_count      : i , \n            delivery_status     : msg.timeout_data.delivery_status, \n            delivery_due        : msg.timeout_data.delivery_due,\n            delivery_user_ids   : user_id[i] ? user_id[i] : msg.timeout_data.delivery_user_ids,\n            delivery_via        : msg.timeout_data.delivery_via,\n            delivery_task_id    : msg.timeout_data.delivery_task_id,\n            delivery_task_name  : msg.timeout_data.delivery_task_name, \n            message_id          : msg.timeout_data.message_id,\n            from_user_id        : msg.timeout_data.from_user_id  \n        };\n    }\n    \n    return obj ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 643,
        "y": 234,
        "wires": [
            [
                "d572bac9.90a018"
            ]
        ]
    },
    {
        "id": "d572bac9.90a018",
        "type": "cloudant out",
        "z": "57a35ec7.3182f",
        "name": "Save to Database",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 763,
        "y": 392,
        "wires": []
    },
    {
        "id": "8dc4d9aa.6f1bd8",
        "type": "ui_form",
        "z": "a164a1e3.d69",
        "name": "Detail Screen",
        "label": "",
        "group": "e8b5a7d3.af2da8",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Task Id",
                "value": "task_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Child Task Id",
                "value": "child_task_id",
                "type": "text",
                "required": false
            },
            {
                "label": "User Id",
                "value": "user_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Page Id",
                "value": "page_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Synchronized",
                "value": "synchronized",
                "type": "text",
                "required": false
            },
            {
                "label": "Processed",
                "value": "processed",
                "type": "text",
                "required": false
            },
            {
                "label": "Status",
                "value": "status",
                "type": "text",
                "required": false
            },
            {
                "label": "Read",
                "value": "read",
                "type": "text",
                "required": false
            },
            {
                "label": "Display If Empty",
                "value": "display_if_empty",
                "type": "text",
                "required": false
            },
            {
                "label": "Due Date",
                "value": "due_date",
                "type": "text",
                "required": false
            },
            {
                "label": "Offline Expiration Seconds",
                "value": "offline_expiration_seconds",
                "type": "number",
                "required": false
            },
            {
                "label": "Priority",
                "value": "priority",
                "type": "number",
                "required": false
            },
            {
                "label": "Message",
                "value": "message",
                "type": "text",
                "required": false
            },
            {
                "label": "Template Id",
                "value": "template_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Timeout Id",
                "value": "timeout_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Location  Ids (add multiple ids seprated by comma)",
                "value": "location_id",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "task_id": "",
            "child_task_id": "",
            "user_id": "",
            "page_id": "",
            "synchronized": "",
            "processed": "",
            "status": "",
            "read": "",
            "display_if_empty": "",
            "due_date": "",
            "offline_expiration_seconds": "",
            "priority": "",
            "message": "",
            "template_id": "",
            "timeout_id": "",
            "location_id": ""
        },
        "payload": "",
        "topic": "details_data",
        "x": 92,
        "y": 50,
        "wires": [
            [
                "d2244926.36ea98"
            ]
        ]
    },
    {
        "id": "d2244926.36ea98",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "Splitter",
        "func": "var payload = {};\n\nif(msg.payload){\n    \n    if(msg.payload._id){\n        msg.event_type = \"update_record_db\";\n        msg.form_data = {\n            detail_id: msg.payload.detail_id,\n            task_id: msg.payload.task_id,\n            child_task_id: msg.payload.child_task_id,\n            user_id: msg.payload.user_id,\n            page_id: msg.payload.page_id,\n            synchronized: msg.payload.synchronized,\n            processed: msg.payload.processed,\n            status: msg.payload.status,\n            read: msg.payload.read,\n            display_if_empty: msg.payload.display_if_empty,\n            due_date: msg.payload.due_date,\n            offline_expiration_seconds: msg.payload.offline_expiration_seconds,\n            priority: msg.payload.priority,\n            message: msg.payload.message,\n        };\n        payload = {\n            _id : msg.payload._id \n        };\n    }else{\n        payload = {\n            detail_id: msg.payload.detail_id,\n            task_id: msg.payload.task_id,\n            child_task_id: msg.payload.child_task_id,\n            user_id: msg.payload.user_id,\n            page_id: msg.payload.page_id,\n            synchronized: msg.payload.synchronized,\n            processed: msg.payload.processed,\n            status: msg.payload.status,\n            read: msg.payload.read,\n            display_if_empty: msg.payload.display_if_empty,\n            due_date: msg.payload.due_date,\n            offline_expiration_seconds: msg.payload.offline_expiration_seconds,\n            priority: msg.payload.priority,\n            message: msg.payload.message,\n        };\n    }\n\n\n    if(msg.payload.user_id){\n    \tmsg.payload_user_id =  {_id : msg.payload.user_id };\n    }\n    \n    if(msg.payload.template_id){\n    \tmsg.payload_template_id =  {_id: msg.payload.template_id};\n    }\n    \n    if(msg.payload.timeout_id){\n    \tmsg.payload_timeout_id =  {_id: msg.payload.timeout_id};\n    }\n    \n    if(msg.payload.location_id){\n    \tmsg.payload_location_id =  msg.payload.location_id;\n    }\n}\n\nmsg.payload = payload ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 139,
        "y": 156,
        "wires": [
            [
                "ea650efc.159a3"
            ]
        ]
    },
    {
        "id": "de6c3f71.58e29",
        "type": "change",
        "z": "a164a1e3.d69",
        "name": "msg.detail_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 442,
        "y": 172,
        "wires": [
            [
                "1175339a.ee85ec"
            ]
        ]
    },
    {
        "id": "d95bbacc.b798d8",
        "type": "cloudant in",
        "z": "a164a1e3.d69",
        "name": "Users",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 539,
        "y": 327,
        "wires": [
            [
                "34f33d78.c46b52"
            ]
        ]
    },
    {
        "id": "2bbd7671.dae3aa",
        "type": "cloudant in",
        "z": "a164a1e3.d69",
        "name": "Template",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 556,
        "y": 394,
        "wires": [
            [
                "f9b13825.4e29c8"
            ]
        ]
    },
    {
        "id": "884eda73.21f2a8",
        "type": "cloudant in",
        "z": "a164a1e3.d69",
        "name": "Timeout",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 583,
        "y": 466,
        "wires": [
            [
                "453a28f9.dbe308"
            ]
        ]
    },
    {
        "id": "89eb874e.849e78",
        "type": "cloudant in",
        "z": "a164a1e3.d69",
        "name": "Location",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 384,
        "y": 514,
        "wires": [
            [
                "21b85110.acff7e"
            ]
        ]
    },
    {
        "id": "a3d45d79.bdf0c",
        "type": "cloudant in",
        "z": "a164a1e3.d69",
        "name": "Update",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 420,
        "y": 97,
        "wires": [
            [
                "c483d6a5.f78598"
            ]
        ]
    },
    {
        "id": "6de5773f.ed5508",
        "type": "change",
        "z": "a164a1e3.d69",
        "name": "User",
        "rules": [
            {
                "t": "move",
                "p": "payload_user_id",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 391,
        "y": 325,
        "wires": [
            [
                "d95bbacc.b798d8"
            ]
        ]
    },
    {
        "id": "7988c5c.a6c213c",
        "type": "change",
        "z": "a164a1e3.d69",
        "name": "Template",
        "rules": [
            {
                "t": "move",
                "p": "payload_template_id",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 393,
        "y": 392,
        "wires": [
            [
                "2bbd7671.dae3aa"
            ]
        ]
    },
    {
        "id": "9c7fa3e0.5e32e",
        "type": "change",
        "z": "a164a1e3.d69",
        "name": "Timeout",
        "rules": [
            {
                "t": "move",
                "p": "payload_timeout_id",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 385,
        "y": 464,
        "wires": [
            [
                "884eda73.21f2a8"
            ]
        ]
    },
    {
        "id": "8ca1a712.78c698",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "Merge",
        "func": "var payload         = {detail_id: null,task_id: null,child_task_id: null,user_id: null,page_id: null,synchronized: null,\n        processed: null,status: null,read: null,display_if_empty: null,\n        due_date: null,offline_expiration_seconds: null,priority: null,\n        user_incoming : {},watson_incoming: {},message: null,template: {detail: {}},\n        timeout: {},user_calculated: {timeout: {},user: {},template: {}},location: {},defaults: {parent : null,all_children : null} } ;\n \nvar user_obj        = global.get('user_obj'),\n    template_obj    = global.get('template_obj'),\n    timeout_obj     = global.get('timeout_obj'),\n    location_obj    = global.get('location_obj'),\n    watson_obj      = global.get('watson_obj'),\n    detail_obj      = msg.detail_data ;\n\n\tpayload = {\n\t\ttask_id: detail_obj.task_id,\n\t\tchild_task_id: detail_obj.child_task_id,\n\t\tuser_id: detail_obj.user_id,\n\t\tpage_id: detail_obj.page_id || false ,\n\t\tsynchronized: detail_obj.synchronized || false,\n\t\tprocessed: detail_obj.processed || true,\n\t\tstatus: detail_obj.status || true,\n\t\tread: detail_obj.read || false,\n\t\tdisplay_if_empty: detail_obj.display_if_empty || true,\n\t\tdate_created : new Date().toJSON() , \n\t\tdue_date: detail_obj.due_date || new Date().toJSON(),\n\t\toffline_expiration_seconds: detail_obj.offline_expiration_seconds || 0,\n\t\tpriority: detail_obj.priority || 1,\n\t\tuser_incoming : user_obj || {},\n\t\twatson_incoming: watson_obj || {},\n\t\tmessage: detail_obj.message || null,\n\t\ttemplate: {\n\t\t\tdetail: template_obj || {}\n\t\t},\n\t\ttimeout: create_timeout_obj(timeout_obj, user_obj, template_obj),\n\t\tuser_calculated: {\n\t\t\ttimeout: create_timeout_obj(timeout_obj, user_obj, template_obj),\n\t\t\ttemplate: template_obj || {}\n\t\t},\n\t\tlocation: location_obj,\n\t\tdefaults: {\n\t\t\tparent          : null,\n\t\t\tall_children    : null\n\t\t}\n\t};\n\nmsg.payload = payload ;   \nreturn msg;\n\n\nfunction create_timeout_obj(timeout_obj, user_obj, template_obj){\n\tvar timeout_list = timeout_obj.timeout_list ; \n\tfor(var key in timeout_list){\n\t\tif(key){\n\t\t\ttimeout_list[key].users = create_user_obj(user_obj);\n\t\t\ttimeout_list[key].template = {\n        \t    message : template_obj,\n        \t    from    : template_obj\n        \t};\n\t\t}\n\t}\n\treturn timeout_obj ;\n}\n\nfunction create_user_obj(user_obj){\n\tvar obj = {};\n\tif(user_obj){\n\t    obj[user_obj._id] = user_obj ;\n\t    return obj ;\n\t}else{\n\t    return obj ;\n\t}\n\t\n}\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 157,
        "wires": [
            [
                "734e559b.c5b63c",
                "68308415.478efc",
                "4bf154d5.8ba0fc"
            ]
        ]
    },
    {
        "id": "ea650efc.159a3",
        "type": "switch",
        "z": "a164a1e3.d69",
        "name": "",
        "property": "event_type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "update_record_db",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 173,
        "y": 270,
        "wires": [
            [
                "a3d45d79.bdf0c",
                "6de5773f.ed5508",
                "7988c5c.a6c213c",
                "9c7fa3e0.5e32e",
                "89eb874e.849e78",
                "b7df372d.911348"
            ],
            [
                "6de5773f.ed5508",
                "7988c5c.a6c213c",
                "9c7fa3e0.5e32e",
                "de6c3f71.58e29",
                "89eb874e.849e78",
                "b7df372d.911348"
            ]
        ]
    },
    {
        "id": "34f33d78.c46b52",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "user",
        "func": "global.set('user_obj', \"\");\nglobal.set('user_obj', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 739,
        "y": 324,
        "wires": [
            [
                "1796c3c1.417b9c"
            ]
        ]
    },
    {
        "id": "f9b13825.4e29c8",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "template",
        "func": "global.set('template_obj', \"\");\nglobal.set('template_obj', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 737,
        "y": 392,
        "wires": [
            [
                "5a2fbb26.9e8d04"
            ]
        ]
    },
    {
        "id": "453a28f9.dbe308",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "timeout",
        "func": "global.set('timeout_obj', \"\");\nglobal.set('timeout_obj', msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 757,
        "y": 452,
        "wires": [
            [
                "aaa2998.0107868"
            ]
        ]
    },
    {
        "id": "21b85110.acff7e",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "location",
        "func": "var locationArr     = msg.payload ;\n    locations       = [] ;\n    location_ids    = msg.payload_location_id ? sanitizeString(msg.payload_location_id) : null;    \n\n    for(var i=0; i< locationArr.length; i++){\n        if(location_ids !== null){\n            if(location_ids.indexOf(locationArr[i]._id) > -1 ) {\n                locations.push(locationArr[i]);\n            }\n        }\n    }\n\nglobal.set('location_obj', \"\");\nglobal.set('location_obj', create_location_obj(locations));\nreturn msg;\n\nfunction sanitizeString(str){\n    if(str || str !== undefined){\n        var arr = str.split(',');\n        for(var i=0; i< arr.length; i++){\n            arr[i] = arr[i].trim();\n        }\n        return arr ;\n    }else{\n        return false ;\n    }\n}\n\nfunction create_location_obj(locations){\n    var obj = {} ;\n    \n    for(var i=0; i< location.length; i++){\n        if(location[i]._id){\n            obj[location[i]._id] = location[i] ;\n        }\n    }\n    \n    return obj ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 767,
        "y": 530,
        "wires": [
            [
                "8b215049.3db0e"
            ]
        ]
    },
    {
        "id": "734e559b.c5b63c",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "Merge Log",
        "active": true,
        "console": "true",
        "complete": "payload",
        "x": 1119,
        "y": 252,
        "wires": []
    },
    {
        "id": "2a9f0d4c.d721a2",
        "type": "cloudant out",
        "z": "a164a1e3.d69",
        "name": "Save Details into db",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1143,
        "y": 66,
        "wires": []
    },
    {
        "id": "1175339a.ee85ec",
        "type": "delay",
        "z": "a164a1e3.d69",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 659,
        "y": 169,
        "wires": [
            [
                "8ca1a712.78c698"
            ]
        ]
    },
    {
        "id": "a870d7d6.07ae98",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "Update merge",
        "func": "var payload         = {detail_id: null,task_id: null,child_task_id: null,user_id: null,page_id: null,synchronized: null,\n        processed: null,status: null,read: null,display_if_empty: null,\n        due_date: null,offline_expiration_seconds: null,priority: null,\n        user_incoming : {},watson_incoming: {},message: null,template: {detail: {}},\n        timeout: {},user_calculated: {timeout: {},user: {},template: {}},location: {},defaults: {parent : null,all_children : null} } ;\n \nvar user_obj        = global.get('user_obj'),\n    template_obj    = global.get('template_obj'),\n    timeout_obj     = global.get('timeout_obj'),\n    location_obj    = global.get('location_obj'),\n    watson_obj      = global.get('watson_obj'),\n    detail_obj      = msg.form_data ,\n    update_obj      = msg.payload;\n\n    if(update_obj){\n       \n        payload = {\n            _id                         : update_obj._id,\n            _rev                        : update_obj._rev,\n    \t\tdetail_id                   : detail_obj.detail_id                  || update_obj.detail_id,\n    \t\ttask_id                     : detail_obj.task_id                    || update_obj.task_id,\n    \t\tchild_task_id               : detail_obj.child_task_id              || update_obj.child_task_id,\n    \t\tuser_id                     : detail_obj.user_id                    || update_obj.user_id,\n    \t\tpage_id                     : detail_obj.page_id                    || update_obj.page_id,\n    \t\tsynchronized                : detail_obj.synchronized               || update_obj.synchronized,\n    \t\tprocessed                   : detail_obj.processed                  || update_obj.processed,\n    \t\tstatus                      : detail_obj.status                     || update_obj.status,\n\t        read                        : detail_obj.read                       || update_obj.read,\n    \t\tdisplay_if_empty            : detail_obj.display_if_empty           || update_obj.display_if_empty,    \n\t\t    due_date                    : detail_obj.due_date                   || update_obj.due_date,                \n    \t\toffline_expiration_seconds  : detail_obj.offline_expiration_seconds || update_obj.offline_expiration_seconds,      \n    \t\tpriority                    : detail_obj.priority                   || update_obj.priority,    \n    \t\tuser_incoming               : user_obj || {},                              \n    \t\twatson_incoming             : watson_obj || {},\n    \t\tmessage                     : detail_obj.message                    || update_obj.message,    \n    \t\ttemplate                    : {\n    \t\t\t                            detail: template_obj || {}                 \n\t\t                                  },\n    \t\ttimeout                     : create_timeout_obj(timeout_obj, user_obj, template_obj),\n\t\t    user_calculated             :{\n    \t\t\t                            timeout: create_timeout_obj(timeout_obj, user_obj, template_obj),                \n                                \t\t\ttemplate: template_obj || {}             \n\t\t                                },\n    \t\tlocation                    : location_obj || {},                          \n    \t\tdefaults                    : {\n                                \t\t\tparent          : null,\n                                \t\t\tall_children    : null\n    \t\t                            }\n    \t};\n    }else{\n        payload = {\n    \t\tdetail_id: detail_obj.detail_id,\n    \t\ttask_id: detail_obj.task_id,\n    \t\tchild_task_id: detail_obj.child_task_id,\n    \t\tuser_id: detail_obj.user_id,\n    \t\tpage_id: detail_obj.page_id,\n    \t\tsynchronized: detail_obj.synchronized,\n    \t\tprocessed: detail_obj.processed,\n    \t\tstatus: detail_obj.status,\n    \t\tread: detail_obj.read,\n    \t\tdisplay_if_empty: detail_obj.display_if_empty,\n    \t\tdue_date: detail_obj.due_date,\n    \t\toffline_expiration_seconds: detail_obj.offline_expiration_seconds,\n    \t\tpriority: detail_obj.priority,\n    \t\tuser_incoming : user_obj || {},\n    \t\twatson_incoming: watson_obj || {},\n    \t\tmessage: detail_obj.message,\n    \t\ttemplate: {\n    \t\t\tdetail: template_obj || {}\n    \t\t},\n    \t\ttimeout: create_timeout_obj(timeout_obj, user_obj, template_obj),\n    \t\tuser_calculated: {\n    \t\t\ttimeout: create_timeout_obj(timeout_obj, user_obj, template_obj),\n    \t\t\ttemplate: template_obj || {}\n    \t\t},\n    \t\tlocation: location_obj || {},\n    \t\tdefaults: {\n    \t\t\tparent          : null,\n    \t\t\tall_children    : null\n    \t\t}\n    \t};\n    }\nmsg.payload = payload ;    \nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    if(typeof obj == 'object'){\n        for(var keys in obj){\n            count++ ;\n        }\n    }\n    return count ;\n}\n\n\nfunction create_timeout_obj(timeout_obj, user_obj){\n\tvar timeout_list = timeout_obj.timeout_list ; \n\tfor(var key in timeout_list){\n\t\tif(key){\n\t\t\ttimeout_list[key].users = create_user_obj(user_obj);\n\t\t\ttimeout_list[key].template = {\n\t\t\t    message: template_obj,\n\t\t\t    from   : template_obj\n\t\t\t};\n\t\t}\n\t}\n\treturn timeout_obj ;\n}\n\nfunction create_user_obj(user_obj){\n\tvar obj = {};\n\tif(user_obj){\n\t    obj[user_obj._id] = user_obj ;\n\t    return obj ;\n\t}else{\n\t    return obj ;\n\t}\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 865,
        "y": 62,
        "wires": [
            [
                "2a9f0d4c.d721a2",
                "f44ab8da.c70c28",
                "10f93335.5607ed"
            ]
        ]
    },
    {
        "id": "f44ab8da.c70c28",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1113,
        "y": 108,
        "wires": []
    },
    {
        "id": "4bf154d5.8ba0fc",
        "type": "cloudant out",
        "z": "a164a1e3.d69",
        "name": "Save Details into db",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1150,
        "y": 214,
        "wires": []
    },
    {
        "id": "68308415.478efc",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "reset",
        "func": "global.set('user_obj', \"\");\nglobal.set('template_obj', \"\");\nglobal.set('timeout_obj', \"\");\nglobal.set('location_obj', \"\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1098,
        "y": 167,
        "wires": [
            []
        ]
    },
    {
        "id": "c483d6a5.f78598",
        "type": "delay",
        "z": "a164a1e3.d69",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 645,
        "y": 84,
        "wires": [
            [
                "a870d7d6.07ae98"
            ]
        ]
    },
    {
        "id": "10f93335.5607ed",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "reset",
        "func": "global.set('user_obj', \"\");\nglobal.set('template_obj', \"\");\nglobal.set('timeout_obj', \"\");\nglobal.set('location_obj', \"\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1094,
        "y": 29,
        "wires": [
            []
        ]
    },
    {
        "id": "a1ed3625.da5a58",
        "type": "debug",
        "z": "57a35ec7.3182f",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 592,
        "y": 490,
        "wires": []
    },
    {
        "id": "8b215049.3db0e",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 924,
        "y": 530,
        "wires": []
    },
    {
        "id": "aaa2998.0107868",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 940,
        "y": 455,
        "wires": []
    },
    {
        "id": "5a2fbb26.9e8d04",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 918,
        "y": 400,
        "wires": []
    },
    {
        "id": "1796c3c1.417b9c",
        "type": "debug",
        "z": "a164a1e3.d69",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 957,
        "y": 328,
        "wires": []
    },
    {
        "id": "b7df372d.911348",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "build_watson_data",
        "func": "msg = {\n  payload : \"The Lean\" ,\n  params : {\n    workspace_id : \"42015e53-bdb9-4a23-87b5-f382d5e12dbb\",\n    username     : \"4db58c57-6d89-4382-9d34-c4044b5fce11\",\n    password     : \"eG0ctZRJO42s\"\n  }\n};\nmsg.user = msg.payload_user_id;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 585,
        "wires": [
            [
                "e3942d2a.7c15d"
            ]
        ]
    },
    {
        "id": "e3942d2a.7c15d",
        "type": "watson-conversation-v1",
        "z": "a164a1e3.d69",
        "name": "",
        "workspaceid": "",
        "multiuser": true,
        "context": true,
        "x": 628,
        "y": 599,
        "wires": [
            [
                "8b798794.66a778"
            ]
        ]
    },
    {
        "id": "8b798794.66a778",
        "type": "function",
        "z": "a164a1e3.d69",
        "name": "Watson",
        "func": "global.set('watson_obj', \"\");\nglobal.set('watson_obj', msg);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 819,
        "y": 604,
        "wires": [
            []
        ]
    },
    {
        "id": "33fb9251.e043ae",
        "type": "change",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 325,
        "y": 114,
        "wires": [
            [
                "ec78be59.3849f"
            ]
        ]
    },
    {
        "id": "ec78be59.3849f",
        "type": "cloudant in",
        "z": "d9e3488f.8f93b8",
        "name": "Locations",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 125,
        "y": 208,
        "wires": [
            [
                "1d35a4de.414d5b"
            ]
        ]
    },
    {
        "id": "1d35a4de.414d5b",
        "type": "change",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "location_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 328,
        "y": 206,
        "wires": [
            [
                "69ddc3eb.30f08c"
            ]
        ]
    },
    {
        "id": "69ddc3eb.30f08c",
        "type": "function",
        "z": "d9e3488f.8f93b8",
        "name": "Merge",
        "func": "if(msg.task_data){\n    if(msg.task_data._id){\n        msg.type_status = \"find_from_db\";\n        msg.payload = {\"_id\": msg.task_data._id};\n    }else{\n        msg.type_status = \"save_into_db\";\n        var page_id = generate_page_id(6);\n        \n        msg.payload = {\n            task_name               : msg.task_data.name || null, \n            page_id                 : page_id, \n            from_page_id            : page_id,\n            parent_id               : page_id, \n            user_id                 : msg.task_data.user_id || null,\n            header_template_id      : msg.task_data.header_template_id || null,\n            detail_template_id      : msg.task_data.details_template_id || null,\n            footer_template_id      : msg.task_data.footer_template_id || null,\n            timeout_id              : msg.task_data.timeout_id || null,\n            location_id             : msg.task_data.location_id ? create_location_obj(msg.task_data.location_id, msg.location_arr) : null,\n            child_default_task_id   : msg.task_data.child_defaults_task_id || null,\n            child_default_task_name : msg.task_data.child_default_task_name || null,\n            date_created            : msg.task_data.date_created || new Date().toJSON(),\n            status                  : msg.task_data.status || false,\n            category                : msg.task_data.category || null,\n            additional_data_fn      : msg.task_data.additional_data_fn || null,\n            optional_data           : msg.task_data.optional_data || {},\n            required_data           : msg.task_data.required_data || {},\n            offline_expiration_time : msg.task_data.offline_expiration_time || 0,\n            display_if_empty        : msg.task_data.display_if_empty || true ,\n            type                    : {\n                public              : msg.task_data.type  || \"public\"\n            },\n            image                   : msg.task_data.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\",\n            defaults                : {\n                parent              : null,\n                next_child          : null,\n                all_children        : null,\n                user                : msg.task_data.user_id\n            }\n            \n        };\n    }\n}\n\nreturn msg;\n\n\nfunction create_location_obj(loc_str, loc_arr){\n    var locations       = {} ;\n        location_ids    = loc_str ? sanitizeString(loc_str) : null;    \n    \n        for(var i=0; i< loc_arr.length; i++){\n            if(location_ids !== null){\n                if(location_ids.indexOf(loc_arr[i]._id) > -1 ) {\n                    locations[loc_arr[i]._id] = loc_arr[i] ;\n                }    \n            }\n        }\n    \n    return locations ;\n}\n\nfunction sanitizeString(str){\n    if(str || str !== undefined){\n        var arr = str.split(',');\n        for(var i=0; i< arr.length; i++){\n            arr[i] = arr[i].trim();\n        }\n        return arr ;\n    }else{\n        return false ;\n    }\n}\n\nfunction generate_page_id(length) {\n    return new Date().getTime();\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 518,
        "y": 222,
        "wires": [
            [
                "fac660c4.d29f1"
            ]
        ]
    },
    {
        "id": "fac660c4.d29f1",
        "type": "switch",
        "z": "d9e3488f.8f93b8",
        "name": "Switch",
        "property": "type_status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "find_from_db",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "save_into_db",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 149,
        "y": 296,
        "wires": [
            [
                "3393ecb0.bb4964"
            ],
            [
                "f9c68f40.b350d",
                "b2123a08.b67888",
                "5d5a3b7.c20e2c4"
            ]
        ]
    },
    {
        "id": "3393ecb0.bb4964",
        "type": "cloudant in",
        "z": "d9e3488f.8f93b8",
        "name": "Get task by Id",
        "cloudant": "",
        "database": "task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 362,
        "y": 292,
        "wires": [
            [
                "2d83c0c6.bca0a"
            ]
        ]
    },
    {
        "id": "2d83c0c6.bca0a",
        "type": "change",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 604,
        "y": 285,
        "wires": [
            [
                "fc370234.6a6cc"
            ]
        ]
    },
    {
        "id": "fc370234.6a6cc",
        "type": "function",
        "z": "d9e3488f.8f93b8",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output, form_data = msg.task_data, payload = {};\n\nif(check_obj(db_data) > 0){\n    payload = {\n        _id : db_data._id,\n        _rev : db_data._rev,\n        user_id: form_data.user_id || db_data.user_id,\n        task_id: form_data.task_id || db_data.task_id,\n        page_id: db_data.page_id || generate_page_id(6),\n        header_template_id: form_data.header_template_id || db_data.header_template_id,\n        details_template_id: form_data.details_template_id || db_data.details_template_id,\n        footer_template_id: form_data.footer_template_id || db_data.footer_template_id,\n        timeout_id: form_data.timeout_id || db_data.timeout_id,\n        location_id: form_data.location_id ? create_location_obj(form_data.location_id, msg.location_arr) : db_data.location_id,\n        child_default_task_id: form_data.child_defaults_task_id || db_data.child_defaults_task_id,\n        date_created: form_data.date_created || db_data.date_created,\n        status: form_data.status || db_data.status,\n        category: form_data.category || db_data.category,\n        additional_data_fn: form_data.additional_data_fn || db_data.additional_data_fn,\n        optional_data: form_data.optional_data || db_data.optional_data,        \n        required_data: form_data.required_data || db_data.required_data,\n        offline_expiration_time: form_data.offline_expiration_time || db_data.offline_expiration_time,     \n        display_if_empty: form_data.display_if_empty || db_data.display_if_empty,\n        type: form_data.type || \"public\",\n        image: form_data.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\",\n        defaults                : {\n            parent              : null,\n            next_child          : null,\n            all_children        : null,\n            user                : form_data.user_id || db_data.user_id\n        }\n    };\n}else{\n    payload = {\n        user_id: form_data.user_id,\n        task_id: form_data.task_id,\n        page_id: generate_page_id(6),\n        header_template_id: form_data.header_template_id,\n        details_template_id: form_data.details_template_id,\n        footer_template_id: form_data.footer_template_id,\n        timeout_id: form_data.timeout_id,\n        location_id: create_location_obj(form_data.location_id, msg.location_arr),\n        child_default_task_id: form_data.child_defaults_task_id,\n        date_created: form_data.date_created,\n        status: form_data.status,\n        category: form_data.category,\n        additional_data_fn: form_data.additional_data_fn,\n        optional_data: form_data.optional_data,\n        required_data: form_data.required_data,\n        offline_expiration_time: form_data.offline_expiration_time,\n        display_if_empty: form_data.display_if_empty,\n        type: form_data.type || \"public\",\n        image: form_data.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\",\n        defaults                : {\n            parent              : null,\n            next_child          : null,\n            all_children        : null,\n            user                : form_data.user_id || db_data.user_id\n        }\n    };\n}\n\nmsg.payload = payload ;\nreturn msg;\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\nfunction create_location_obj(loc_str, loc_arr){\n    var locations       = [] ;\n        location_ids    = loc_str ? sanitizeString(loc_str) : null;    \n    \n        for(var i=0; i< loc_arr.length; i++){\n            if(location_ids !== null){\n                if(location_ids.indexOf(loc_arr[i]._id) > -1 ) {\n                    locations.push(loc_arr[i]);\n                }    \n            }\n        }\n    \n    return locations ;\n}\n\nfunction sanitizeString(str){\n    if(str || str !== undefined){\n        var arr = str.split(',');\n        for(var i=0; i< arr.length; i++){\n            arr[i] = arr[i].trim();\n        }\n        return arr ;\n    }else{\n        return false ;\n    }\n}\n\nfunction generate_page_id(length) {\n    return new Date().getTime();\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 406,
        "y": 365,
        "wires": [
            [
                "f24c00c3.9ec8d",
                "f9c68f40.b350d"
            ]
        ]
    },
    {
        "id": "f9c68f40.b350d",
        "type": "cloudant out",
        "z": "d9e3488f.8f93b8",
        "name": "Save to Database",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 395,
        "y": 452,
        "wires": []
    },
    {
        "id": "c5826cfe.425e4",
        "type": "ui_form",
        "z": "d9e3488f.8f93b8",
        "name": "Task Screen",
        "label": "",
        "group": "d173f1a2.6f3b7",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Name",
                "value": "name",
                "type": "text",
                "required": false
            },
            {
                "label": "User Id",
                "value": "user_id",
                "type": "text",
                "required": true
            },
            {
                "label": "Header Template Id",
                "value": "header_template_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Detail Template Id",
                "value": "details_template_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Footer Template Id",
                "value": "footer_template_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Timeout Id",
                "value": "timeout_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Location Id",
                "value": "location_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Child Deafult Task Id",
                "value": "child_default_task_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Child default task name",
                "value": "child_default_task_name",
                "type": "text",
                "required": false
            },
            {
                "label": "Date created",
                "value": "date_created",
                "type": "text",
                "required": false
            },
            {
                "label": "Status",
                "value": "status",
                "type": "text",
                "required": true
            },
            {
                "label": "Category",
                "value": "category",
                "type": "text",
                "required": true
            },
            {
                "label": "Additional_data_fn",
                "value": "additional_data_fn",
                "type": "text",
                "required": false
            },
            {
                "label": "Optional data",
                "value": "optional_data",
                "type": "text",
                "required": false
            },
            {
                "label": "Required data",
                "value": "required_data",
                "type": "text",
                "required": false
            },
            {
                "label": "Offline expiration time",
                "value": "offline_expiration_time",
                "type": "number",
                "required": false
            },
            {
                "label": "Display If empty",
                "value": "display_if_empty",
                "type": "text",
                "required": false
            },
            {
                "label": "Type",
                "value": "type",
                "type": "text",
                "required": false
            },
            {
                "label": "Image",
                "value": "image",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "name": "",
            "user_id": "",
            "header_template_id": "",
            "details_template_id": "",
            "footer_template_id": "",
            "timeout_id": "",
            "location_id": "",
            "child_default_task_id": "",
            "child_default_task_name": "",
            "date_created": "",
            "status": "",
            "category": "",
            "additional_data_fn": "",
            "optional_data": "",
            "required_data": "",
            "offline_expiration_time": "",
            "display_if_empty": "",
            "type": "",
            "image": ""
        },
        "payload": "",
        "topic": "",
        "x": 111,
        "y": 28,
        "wires": [
            [
                "33fb9251.e043ae"
            ]
        ]
    },
    {
        "id": "f24c00c3.9ec8d",
        "type": "debug",
        "z": "d9e3488f.8f93b8",
        "name": "Update Log",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 585,
        "y": 446,
        "wires": []
    },
    {
        "id": "891b5b75.f3cfe8",
        "type": "function",
        "z": "b36c258c.f48c68",
        "name": "1. login page and ac",
        "func": "var login_page = {\n        \"_id\": \"page_login\",\n        \"page_id\": \"page_login\",\n        \"task\": {\n            \"template\": {\n                \"header\": {\n                    \"name\": \"title\",\n                    \"html\": \"\"\n                },\n                \"detail\": {\n                    \"name\": \"login form\",\n                    \"html\": \"<ion-content padding=\\\"true\\\">\\r\\n\\t<div class=\\\"wbox\\\" style=\\\"padding:30px;\\\">\\r\\n\\t\\t<form>\\r\\n\\t\\t\\t<h1 style=\\\"text-align:center;\\\">{{title}}<\\/h1>\\r\\n\\t\\t\\t<ion-list style=\\\"\\\">\\r\\n\\t\\t\\t\\t<label class=\\\"item item-input\\\">\\r\\n\\t\\t\\t\\t\\t<input type=\\\"text\\\" id=\\\"phone\\\" ng-model=\\\"user.phone\\\" placeholder=\\\"Phone\\\">\\r\\n\\t\\t\\t\\t<\\/label>\\r\\n\\t\\t\\t\\t<label class=\\\"item item-input\\\">\\r\\n\\t\\t\\t\\t\\t<input type=\\\"password\\\" id=\\\"pass\\\" ng-model=\\\"user.pass\\\" placeholder=\\\"Password\\\">\\r\\n\\t\\t\\t\\t<\\/label>\\r\\n\\t\\t\\t<\\/ion-list>\\r\\n\\t\\t\\t<div style=\\\"height: 40px;\\\" class=\\\"spacer\\\"><\\/div>\\r\\n\\t\\t\\t<button class=\\\"button button-stable button-block\\\" id=\\\"login-button\\\" ng-click=\\\"login(user)\\\">NEXT<\\/button>\\r\\n\\t\\t<\\/form>\\r\\n\\t<\\/div>\\r\\n<\\/ion-content>\"\n                },\n                \"footer\": {\n                    \"name\": \"\",\n                    \"html\": \"\"\n                },\n                \"js\": \"$scope.title = \\\"Login\\\";\\r\\n\\r\\n$scope.login = function(user){\\r\\n\\t$scope.to_id = 2;\\r\\n\\tphone = $.trim($(\\\"#phone\\\").val());\\r\\n\\tpass = $.trim($(\\\"#pass\\\").val());\\r\\n\\t\\r\\n\\tif(phone==''){\\r\\n\\t\\tutilityService.msg(\\\"Please enter Phone number\\\");\\r\\n\\t\\t$(\\\"#phone\\\").focus();\\r\\n\\t\\treturn false;\\r\\n\\t}\\r\\n\\tif(pass==''){\\r\\n\\t\\tutilityService.msg(\\\"Please enter Password\\\");\\r\\n\\t\\treturn false;\\r\\n\\t}\\r\\n\\t\\r\\n\\tvar users = [{\\\"id\\\":1,\\\"name\\\":\\\"Adam\\\"},{\\\"id\\\":2,\\\"name\\\":\\\"Ben\\\"},{\\\"id\\\":3,\\\"name\\\":\\\"Clemens\\\"},{\\\"id\\\":4,\\\"name\\\":\\\"Roger\\\"},{\\\"id\\\":5,\\\"name\\\":\\\"Jess\\\"}];\\r\\n\\tif(typeof localStorage.user == \\\"undefined\\\"){\\r\\n\\t\\tuser.id=users[0].id;\\r\\n\\t\\tuser.name=users[0].name;\\r\\n\\t}\\r\\n\\telse{\\r\\n\\t\\tu = JSON.parse(localStorage.user);\\r\\n\\t\\tuser.id = u.id + 1;\\r\\n\\t\\tif(user.id>5) user.id = 1;\\r\\n\\t\\tuser.name=users[user.id-1].name;\\r\\n\\t}\\r\\n\\tlocalStorage.user = JSON.stringify(user);\\r\\n\\t$scope.myId = user.id;\\r\\n\\t$scope.myName = user.name;\\r\\n\\tpopTxt = \\\"user id=\\\"+user.id+\\\", name=\\\"+user.name+\\\",<br> phone=\\\"+user.phone;\\r\\n\\tutilityService.confirmPopup(popTxt,\\\"Accept new phone!\\\")\\r\\n\\t\\t.then(function(res) {\\r\\n\\t\\tif(res){\\r\\n\\t\\t\\t$scope.goPage($scope.to_id);\\r\\n\\t\\t}\\r\\n\\t});\\r\\n};\"\n            },\n            \"from_id\": 0,\n            \"to_id\": 2,\n            \"date_created\": \"1/26/2017 5:05 PM\"\n        },\n        \"detail\": [\n        ]\n    };\n\nglobal.set('login_page', \"\");\nglobal.set('login_page', login_page);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 319,
        "y": 201,
        "wires": [
            [
                "7cc53007.60934"
            ]
        ]
    },
    {
        "id": "497bac23.baa094",
        "type": "http response",
        "z": "b36c258c.f48c68",
        "name": "API Result",
        "x": 843,
        "y": 194,
        "wires": []
    },
    {
        "id": "770e7d7b.80ba94",
        "type": "debug",
        "z": "b36c258c.f48c68",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 846,
        "y": 110,
        "wires": []
    },
    {
        "id": "6aa45583.ef1c4c",
        "type": "function",
        "z": "b36c258c.f48c68",
        "name": "return login page & ac",
        "func": "//node.warn(JSON.stringify(msg.payload.page_id));\n//node.warn(msg.req.query.page_id);\n\nvar page_id = \"page_login\";\nvar apiResult = global.get('login_page');\nvar access_token = global.get('access_token');\n\nvar response = {};\nresponse = apiResult;\nresponse.access_token = access_token;\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 623,
        "y": 200,
        "wires": [
            [
                "497bac23.baa094",
                "770e7d7b.80ba94"
            ]
        ]
    },
    {
        "id": "5245c16.7b26b4",
        "type": "http in",
        "z": "b36c258c.f48c68",
        "name": "",
        "url": "/api/gettoken",
        "method": "get",
        "swaggerDoc": "",
        "x": 95,
        "y": 201,
        "wires": [
            [
                "891b5b75.f3cfe8"
            ]
        ]
    },
    {
        "id": "7cc53007.60934",
        "type": "function",
        "z": "b36c258c.f48c68",
        "name": "generate ac",
        "func": "var access_token = \"\";\nvar rand = function() {\n    return Math.random().toString(36).substr(2); // remove `0.`\n};\nvar time = function() {\n    //return new Date().getTime().toString(36);\n    return new Date().getTime();\n};\n\nvar token = function() {\n    return time()+'.'+rand(); // to make it longer\n};\n\naccess_token = token();\nnode.warn(access_token);\nglobal.set('access_token', access_token);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 492,
        "y": 94,
        "wires": [
            [
                "6aa45583.ef1c4c"
            ]
        ]
    },
    {
        "id": "e3e5cf88.d4568",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "",
        "url": "/auth/user",
        "method": "post",
        "swaggerDoc": "",
        "x": 110,
        "y": 125,
        "wires": [
            [
                "ddbf1178.8968a",
                "41a79280.b3214c"
            ]
        ]
    },
    {
        "id": "ddbf1178.8968a",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "Auth",
        "func": "var body = msg.payload ;\n\nif(check_obj(body)){\n    if(has_key(body, 'access_token')){\n        if(body.access_token === \"1488979858724.yv76fk01o41gu8fr\"){\n            msg.payload = { \n                \"_id\": \"5f490c0ae2ee7321dc891a3e59bd64c6\",\n                \"_rev\": \"2-c9ffd4c38b354a276870e7407cb0c9b7\",\n                \"long_url\": null,\n                \"access_token\": \"1488979858724.yv76fk01o41gu8fr\",\n                \"security_level\": 1,\n                \"virtual_phone\": 15103067789,\n                \"email\": \"test@bot.com\",\n                \"converstation_id\": null,\n                \"first_name\": \"test\",\n                \"last_name\": \"bot\",\n                \"code\": null,\n                \"password\": \"Admin123#\"\n            } ;\n        }else{\n            msg.payload = response(400, true, \"validation error\", \"Token doesn't exists, Please check this again.\");\n        }    \n    }else{\n        msg.payload = response(400, true, \"validation error\", \"Access token is required.\");\n    }\n}else{\n    msg.payload = response(400, true, \"validation error\", \"Empty request body not going to trated.\");\n}\nreturn msg;\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}\n\nfunction has_key(obj, key){\n    return obj[key] ? true : false ;\n}\n\n\nfunction response(code, err, type, msg){\n    return {status: code, err: err ? true : false , type: type, msg: msg} ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 303,
        "y": 145,
        "wires": [
            [
                "e7cbcfaf.a646f"
            ]
        ]
    },
    {
        "id": "e7cbcfaf.a646f",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 451,
        "y": 145,
        "wires": []
    },
    {
        "id": "41a79280.b3214c",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 320,
        "y": 80,
        "wires": []
    },
    {
        "id": "d915338.f85d3d",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "form_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "form_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 270,
        "y": 88,
        "wires": [
            [
                "4c63cd35.b61c74"
            ]
        ]
    },
    {
        "id": "4c63cd35.b61c74",
        "type": "cloudant in",
        "z": "7fce52ea.7e640c",
        "name": "Users",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 406,
        "y": 89,
        "wires": [
            [
                "ba394890.7ec3a8"
            ]
        ]
    },
    {
        "id": "ba394890.7ec3a8",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "users_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "users_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 555,
        "y": 89,
        "wires": [
            [
                "328a25c.c9973da"
            ]
        ]
    },
    {
        "id": "328a25c.c9973da",
        "type": "cloudant in",
        "z": "7fce52ea.7e640c",
        "name": "templates",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 706,
        "y": 89,
        "wires": [
            [
                "e4015841.1edc68"
            ]
        ]
    },
    {
        "id": "e4015841.1edc68",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "templates",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "all_templates",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 99,
        "y": 157,
        "wires": [
            [
                "fdc81203.40114"
            ]
        ]
    },
    {
        "id": "fdc81203.40114",
        "type": "function",
        "z": "7fce52ea.7e640c",
        "name": "timeout_id",
        "func": "if(msg.form_data){\n    if(msg.form_data.timeout_id){\n        msg.payload = {\n            _id : msg.form_data.timeout_id\n        };\n    }else{\n        msg.payload = {\n            _id : \"\"\n        };\n    }\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 263,
        "y": 156,
        "wires": [
            [
                "f010f10b.e9fb"
            ]
        ]
    },
    {
        "id": "f010f10b.e9fb",
        "type": "cloudant in",
        "z": "7fce52ea.7e640c",
        "name": "TimeoutById",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 424,
        "y": 155,
        "wires": [
            [
                "184d3b84.b8f144"
            ]
        ]
    },
    {
        "id": "184d3b84.b8f144",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "timeout_obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "timeout_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 589,
        "y": 153,
        "wires": [
            [
                "3b6efaa5.71ed46"
            ]
        ]
    },
    {
        "id": "3b6efaa5.71ed46",
        "type": "cloudant in",
        "z": "7fce52ea.7e640c",
        "name": "locations",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 743,
        "y": 154,
        "wires": [
            [
                "37614730.9995b8"
            ]
        ]
    },
    {
        "id": "37614730.9995b8",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "locationArr",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "location_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 103,
        "y": 219,
        "wires": [
            [
                "54cba0d5.0fb27"
            ]
        ]
    },
    {
        "id": "9e13f329.594eb",
        "type": "cloudant in",
        "z": "7fce52ea.7e640c",
        "name": "by task name",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getTask",
        "index": "searchTask",
        "x": 425,
        "y": 219,
        "wires": [
            [
                "5f12ee44.297d"
            ]
        ]
    },
    {
        "id": "54cba0d5.0fb27",
        "type": "function",
        "z": "7fce52ea.7e640c",
        "name": "task name",
        "func": "if(msg.form_data){\n    if(msg.form_data.task_name){\n        msg.payload = {\n            query : \"task_name:\" + msg.form_data.task_name\n        } ;\n    }else{\n        msg.payload = {\n            query: \"\" \n        };\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 262,
        "y": 219,
        "wires": [
            [
                "9e13f329.594eb"
            ]
        ]
    },
    {
        "id": "5f12ee44.297d",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "taskByName",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_by_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 591,
        "y": 217,
        "wires": [
            [
                "6bdf6385.1f5e3c"
            ]
        ]
    },
    {
        "id": "5e11b2f2.297cbc",
        "type": "inject",
        "z": "7fce52ea.7e640c",
        "name": "start",
        "topic": "start",
        "payload": "{ \"user_id\": \"5f490c0ae2ee7321dc891a3e59bd64c6\", \"task_name\": \"task_w_create_task\", \"from_user_id\": \"23d5c58422026c68269cd6e9ac22ca4a\", \"note\": \"the lean statup\" }",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 91,
        "y": 109,
        "wires": [
            [
                "d915338.f85d3d"
            ]
        ]
    },
    {
        "id": "7027bf3c.45267",
        "type": "function",
        "z": "7fce52ea.7e640c",
        "name": "big_record",
        "func": "var form_data       = msg.form_data ,\n    user_obj        = get_obj(form_data.user_id, msg.users_data),\n    templates       = msg.all_templates,\n    timeout         = msg.timeout_obj,\n    locations       = msg.location_arr ,\n    task_arr        = msg.task_by_name ,\n    watson_output   = msg.watson_output,\n    big_record      = {},\n    page_id         = generate_page_id(6);\n    \nif(form_data._id){\n    //from the below code is working for the update case.\n    big_record._id              = form_data._id ;\n    big_record.page_id          = page_id ;\n    big_record.task_name        = form_data.task_name;\n    big_record.user_id          = user_obj._id;\n    big_record.phone            = user_obj.virtual_phone;\n    big_record.access_token     = user_obj.access_token;\n    big_record.note             = form_data.note || \"the lean startup\" ;\n    big_record.task             = create_task_obj(form_data, msg.users_data, templates, locations, task_arr, watson_output);\n}else{\n    //from the below code is working for the create record case.\n    big_record.task_name        = form_data.task_name;\n    big_record.page_id          = page_id ;\n    big_record.user_id          = user_obj._id;\n    big_record.phone            = user_obj.virtual_phone;\n    big_record.access_token     = user_obj.access_token;\n    big_record.note             = form_data.note || \"the lean startup\" ;\n    big_record.task             = create_task_obj(form_data, msg.users_data, templates, locations, task_arr, timeout, watson_output);\n\n}\nmsg.payload = big_record ;\nreturn msg;\n\nfunction create_task_obj(form, users_arr, templates, locations, task_arr, timeout, watson_output){\n    var task_obj = get_task_from_arr(task_arr);\n    var task ={\n        task_id                     : task_obj._id ,\n        user_id                     : task_obj.user_id ,\n        task_name                   : task_obj.name ,\n        header_template_id          : get_obj(task_obj.header_template_id, templates) ,\n        detail_template_id          : get_obj(task_obj.details_template_id, templates) ,\n        footer_template_id          : get_obj(task_obj.footer_template_id, templates) ,\n        timeout_id                  : task_obj.timeout_id ,\n        location_ids                : task_obj.location_ids ? get_all_loc_obj(task_obj.location_ids) : null,\n        child_defaults_task_id      : task_obj.child_default_task_id || null ,\n        child_default_task_name     : task_obj.child_default_task_name || null, \n        date_created                : task_obj.date_created || new Date().toJSON() ,\n        category                    : task_obj.category || null ,\n        status                      : task_obj.status || null ,\n        additional_data_fn          : task_obj.additional_data_fn || null,\n        optional_data               : task_obj.optional_data || {},\n        required_data               : task_obj.required_data || {} ,\n        offline_expiration_seconds  : task_obj.offline_expiration_time || 0,\n        display_if_empty            : task_obj.display_if_empty || true ,\n        type                        : {\n            public                  : task_obj.type || \"public\"\n        },\n        image                       : task_obj.image || form.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\" ,\n        child_defaults_task         : form.child_defaults_task || null ,\n        template                    : {\n            header                  : get_obj(task_obj.header_template_id, templates),\n            detail                  : get_obj(task_obj.details_template_id, templates),\n            footer                  : get_obj(task_obj.footer_template_id, templates)\n        } ,\n        detail                      : create_detail_obj(form, users_arr, templates, locations, task_obj, timeout, watson_output)\n    } ;\n    return task ;\n}\n\nfunction create_detail_obj(form, users, templates, locations, task_obj, timeout, watson_output){\n    var detail = {\n        task_id                     : task_obj._id,\n        child_task_id               : task_obj.child_default_task_id,\n        user_id                     : get_obj(form.user_id, users), \n        from_user_id                : get_obj(form.from_user_id, users),\n        page_id                     : page_id,\n        synchronized                : true,\n        processed                   : true,\n        status                      : \"active\",\n        read                        : true,\n        display_if_empty            : true,\n        date_created                : new Date().toJSON(),\n        due_date                    : new Date().toJSON(),\n        offline_expiration_seconds  : 0,\n        priority                    : 1,\n        user_incoming               : {\n            note                    : form.note || \"the lean startup\"\n        },\n        watson_incoming             : {\n            message                 : \"watson_response_to: \" + form.note ,\n            output                  : watson_output.output\n        },\n        timeout                     : create_timeout_obj(timeout, users),\n        location                    : task_obj.location_ids ? get_all_loc_obj(task_obj.location_ids) : null,\n        defaults: {\n            parent                  : {},\n            next_child              : {},\n            children                : {}\n        }\n    };\n    return detail ;\n}\n\nfunction get_obj(id, arr){\n    var obj = {} ;\n    if(id && arr.length){\n        for(var i=0; i<arr.length; i++){\n            if(sanitize(id) === sanitize(arr[i]._id)){\n                obj = arr[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction get_task_from_arr(arr){\n    if(arr !== null){\n        if(arr.length){\n            return arr[arr.length - 1];\n        }else{\n            return arr ;\n        }    \n    }\n}\n\nfunction get_all_loc_obj(arr){\n    var obj = {};\n    if(arr !== null){\n        for(var i=0; i< arr.length; i++){\n            if(arr[i]){\n                obj[arr[i]._id] = arr[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction create_timeout_obj(timeout_obj, users){\n    if(check_obj(timeout_obj.timeout_list) > 0){\n        for(var list in timeout_obj.timeout_list){\n            if(timeout_obj.timeout_list[list]){\n                timeout_obj.timeout_list[list].users = get_delivery_user_ids(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                timeout_obj.timeout_list[list].delivery_user_ids = get_delivery_user_ids(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                timeout_obj.timeout_list[list].template = {\n                    message: {},\n                    from   : {}\n                };\n                timeout_obj.timeout_list[list].defaults = {\n                    parent                  : {},\n                    next_child              : {},\n                    children                : {}\n                };\n            }\n        }\n        return timeout_obj ;   \n    }else{\n        return {} ;\n    }\n}\n\nfunction get_delivery_user_ids(ids, users){\n    var obj = {};\n    if(ids !== null){\n        ids = ids.split(',');\n    }\n    \n    if(users.length){\n        for(var i=0; i< users.length; i++){\n            if(ids.indexOf(users[i]._id) > -1 ){\n                delete users[i].password ;\n                obj[users[i]._id] = users[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        if(obj[keys]){\n            count++ ;\n        }\n    }\n    return count ;\n}\n\nfunction sanitize(data){\n    if(data){\n        return data.trim().toString();\n    }\n}\n\nfunction generate_page_id(length) {\n    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 456,
        "y": 287,
        "wires": [
            [
                "addc1beb.7297f8",
                "4dedc89e.9da2d8"
            ]
        ]
    },
    {
        "id": "addc1beb.7297f8",
        "type": "debug",
        "z": "7fce52ea.7e640c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 648,
        "y": 389,
        "wires": []
    },
    {
        "id": "6bdf6385.1f5e3c",
        "type": "function",
        "z": "7fce52ea.7e640c",
        "name": "input",
        "func": "msg.payload  = msg.form_data.note || \"the lean startup\" ;\nmsg.params = {\n    workspace_id : \"42015e53-bdb9-4a23-87b5-f382d5e12dbb\",\n    username     : \"4db58c57-6d89-4382-9d34-c4044b5fce11\",\n    password     : \"eG0ctZRJO42s\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 742,
        "y": 218,
        "wires": [
            [
                "20c99b1e.68bd94"
            ]
        ]
    },
    {
        "id": "20c99b1e.68bd94",
        "type": "watson-conversation-v1",
        "z": "7fce52ea.7e640c",
        "name": "Watson",
        "workspaceid": "42015e53-bdb9-4a23-87b5-f382d5e12dbb",
        "multiuser": false,
        "context": true,
        "x": 96,
        "y": 285,
        "wires": [
            [
                "f7f2e56c.5c4158"
            ]
        ]
    },
    {
        "id": "f7f2e56c.5c4158",
        "type": "change",
        "z": "7fce52ea.7e640c",
        "name": "watson_payload",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "watson_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 267,
        "y": 285,
        "wires": [
            [
                "7027bf3c.45267"
            ]
        ]
    },
    {
        "id": "bda60a90.46f698",
        "type": "cloudant out",
        "z": "7fce52ea.7e640c",
        "name": "Save Obj",
        "cloudant": "",
        "database": "big_record_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 634,
        "y": 288,
        "wires": []
    },
    {
        "id": "4dedc89e.9da2d8",
        "type": "http response",
        "z": "7fce52ea.7e640c",
        "name": "",
        "x": 628,
        "y": 336,
        "wires": []
    },
    {
        "id": "5de2de5d.a5ff9",
        "type": "http in",
        "z": "7fce52ea.7e640c",
        "name": "Big record",
        "url": "/create_big_record",
        "method": "post",
        "swaggerDoc": "",
        "x": 82,
        "y": 64,
        "wires": [
            [
                "d915338.f85d3d"
            ]
        ]
    },
    {
        "id": "b7a9302f.262bb",
        "type": "debug",
        "z": "7fce52ea.7e640c",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 320,
        "y": 38,
        "wires": []
    },
    {
        "id": "88eefbac.c3c3b8",
        "type": "ui_form",
        "z": "7fce52ea.7e640c",
        "name": "Big record table",
        "label": "",
        "group": "605089c4.c715b8",
        "order": 0,
        "width": 0,
        "height": 0,
        "options": [
            {
                "label": "Id",
                "value": "_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Assign user",
                "value": "user_id",
                "type": "text",
                "required": false
            },
            {
                "label": "Task name",
                "value": "task_name",
                "type": "text",
                "required": false
            },
            {
                "label": "From user ",
                "value": "from_user_id",
                "type": "text",
                "required": false
            }
        ],
        "formValue": {
            "_id": "",
            "user_id": "",
            "task_name": "",
            "from_user_id": ""
        },
        "payload": "",
        "topic": "big_record_table",
        "x": 101,
        "y": 22,
        "wires": [
            [
                "d915338.f85d3d",
                "b7a9302f.262bb"
            ]
        ]
    },
    {
        "id": "e6da2739.c08068",
        "type": "inject",
        "z": "d9e3488f.8f93b8",
        "name": "Start",
        "topic": "Start",
        "payload": "{ \t\"name\": \"test_task\", \t\"user_id\": \"5f490c0ae2ee7321dc891a3e59bd64c6\", \t\"header_template_id\": \"108ac1779a89aaf68db2fa7db81e2cab\", \t\"details_template_id\": \"e2d9ea9b31fd26126d3a782e29b60657\", \t\"footer_template_id\": \"52fcded5701e1d38fe92e748059fcbb7\", \t\"timeout_id\": \"\", \t\"location_id\": \"\", \t\"child_default_task_id\": \"\", \t\"child_default_task_name\": \"\", \t\"date_created\": \"\", \t\"status\": \"active\", \t\"category\": \"book\", \t\"additional_data_fn\": \"\", \t\"optional_data\": \"\", \t\"required_data\": \"\", \t\"offline_expiration_time\": 0, \t\"display_if_empty\": \"true\", \t\"type\": \"public\", \t\"image\": \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\" }",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 111,
        "y": 117,
        "wires": [
            [
                "33fb9251.e043ae"
            ]
        ]
    },
    {
        "id": "fa5b152c.505728",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Templates",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 319,
        "y": 297,
        "wires": [
            [
                "c044651d.cc7628"
            ]
        ]
    },
    {
        "id": "89c4da2f.3f4e68",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "setup",
        "func": "if(msg.payload === null || msg.payload === undefined){\n    msg.flow_status = \"API_RESPONSE\";\n    msg.payload = {status: 400, error: true, type: \"Validation error\", msg: \"Please provide valid json object as api request body.\"};\n    return msg;\n}else if(msg.payload.access_token === null || msg.payload.access_token === undefined || msg.payload.access_token === \"\"){\n    msg.flow_status = \"API_RESPONSE\";\n    msg.payload = {status: 400, error: true, type: \"Validation error\", msg: \"Please provide `access_token` in api request body\"};\n    return msg;\n}else if(msg.payload.note === null || msg.payload.note === undefined || msg.payload.note === \"\"){\n    msg.flow_status = \"API_RESPONSE\";\n    msg.payload = {status: 400, error: true, type: \"Validation error\", msg: \"Please provide `note` in api request body\"};\n    return msg;\n}else if(msg.payload.page_id === null || msg.payload.page_id === undefined || msg.payload.page_id === \"\"){\n    msg.flow_status = \"API_RESPONSE\";\n    msg.payload = {status: 400, error: true, type: \"Validation error\", msg: \"Please provide `page_id` in api request body\"};\n    return msg;\n}else if(msg.payload.from_page_id === null || msg.payload.from_page_id === undefined ){\n    msg.flow_status = \"API_RESPONSE\";\n    msg.payload = {status: 400, error: true, type: \"Validation error\", msg: \"Please provide `from_page_id` in api request body\"};\n    return msg;\n}else{\n    msg.form_data    = msg.payload ;\n    msg.task_payload = {query : \"task_name:\" + msg.payload.task_name } ;\n    return msg;\n}\n\n\nfunction check_number(n){\n    if(!isNaN(parseInt(n))){\n        return parseInt(n);\n    }else{\n        return n ;\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 212,
        "y": 63,
        "wires": [
            [
                "fd001b8a.3c2e28"
            ]
        ]
    },
    {
        "id": "ce10d70a.553b78",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "db_user",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 431,
        "y": 156,
        "wires": [
            [
                "8fef5107.4f42b"
            ]
        ]
    },
    {
        "id": "d202018e.aa9e6",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "details",
        "func": "var big_record_tables   = {} , \n    details             = {},\n    details_arr         = msg.details_obj,\n    users_arr           = msg.user_obj ,\n    form_data           = msg.form_data ;\n    \nbig_record_tables.user  = msg.db_user ;\nbig_record_tables.task  = msg.task_obj_by_name[0] ;\n\n//setting up some obj from big_record_tables\nbig_record_tables.task.child_default = big_record_tables.task.child_default_task_id ? get_obj_from_array(big_record_tables.task.child_default_task_id, msg.task_obj) : null;\n\nbig_record_tables.task.details = {\n    timeout : create_timeout_list_obj(msg.timeout_obj, msg.templates, msg.user_obj, \"timeout\") ,\n    user_calculated: create_timeout_list_obj(msg.timeout_obj, msg.templates, msg.user_obj, \"user_calculated\"),\n    location : get_location_obj(msg.task_obj_by_name[0].location_id) \n} ;\n\n//creating the details obj\ndetails.task_id                         = msg.task_obj_by_name[0]._id || null;\ndetails.child_task_id                   = msg.task_obj_by_name[0].child_default_task_id || null;\ndetails.user_id                         = msg.db_user._id || null;\ndetails.from_user_id                    = form_data.from_user_id || null ;\n\n//this code is suggested by @niklas flow so right now no need of this. if required them un-comment\n// details.page_id                         = msg.task_obj_by_name[0].page_id ;\n// details.from_page_id                    = msg.task_obj_by_name[0].from_page_id || \"\";\n// details.to_page_id                      = msg.task_obj_by_name[0].to_page_id || \"\";\n\ndetails.page_id                         = check_number(form_data.page_id) || calculate_page_id(msg.task_obj_by_name[0], details_arr) ;\ndetails.from_page_id                    = check_number(msg.task_obj_by_name[0].from_page_id) || calculate_from_page_id(msg.task_obj_by_name[0], details_arr);\ndetails.to_page_id                      = check_number(msg.task_obj_by_name[0].to_page_id) || calculate_to_page_id(msg.task_obj_by_name[0], details_arr) ;\n\ndetails.synchronized                    = false ;\ndetails.processed                       = false ;\ndetails.status                          = false ;\ndetails.read                            = false ;\ndetails.display_if_empty                = msg.task_obj_by_name[0].display_if_empty || true;\ndetails.date_created                    = new Date().toJSON() ;\ndetails.due_date                        = big_record_tables.task.details.user_calculated.delivery_due;\ndetails.offline_expiration_seconds      = msg.task_obj_by_name[0].offline_expiration_time ;\ndetails.priority                        = 1;\ndetails.type                            = {\n                                            \"public\" : msg.task_obj_by_name[0].type || \"public\"\n                                        };\ndetails.image                           = msg.task_obj_by_name[0].image ;\ndetails.from_user                       = get_from_user(form_data.from_user_id, users_arr);\ndetails.user_incoming                   = {\n                                            note    :   form_data.note ,\n                                            message :   form_data.note\n                                        } ;\n\ndetails.watson_incoming                 = {\n                                            message :   \"Watson response to : \" + form_data.note,\n                                            response : {},\n                                            \n                                        } ;\ndetails.template                        = {\n                                            details : get_template(msg.task_obj_by_name[0].details_template_id, msg.templates)\n                                        };\n\ndetails.timeout                         = big_record_tables.task.details.timeout ;\ndetails.user_calculate                  = big_record_tables.task.details.user_calculated ;\ndetails.location                        = big_record_tables.task.details.location ;\ndetails.default                         = {\n                                            parent : null,\n                                            allchildren: null\n                                        };\ndetails.createdAt                       = Number(new Date().getTime()) ;\n\nif(check_timeout_obj(msg.task_obj_by_name)){\n    msg.default_child_task_id = msg.task_obj_by_name[0].child_default_task_id ;\n    msg.payload = details ;\n    return msg;    \n}else{\n    msg.payload = details ;\n    return msg;    \n}\n\nfunction check_timeout_obj(task_obj){\n    //msg.task_obj_by_name[0].child_default_name\n    \n    if(task_obj !== null || task_obj !== undefined){\n        if(task_obj.length){\n            return true ;\n        }else{\n            return false ;\n        }\n    }else{\n        return false ;\n    }\n}\n\nfunction create_timeout_list_obj(timeout_obj, templates, users, type){\n    if(timeout_obj.name === undefined || timeout_obj.name === null){\n        return {};\n    }\n    \n    switch(type){\n        case \"timeout\" : {\n            if(check_obj(timeout_obj.timeout_list) > 1){\n                var update_obj = JSON.parse(JSON.stringify(timeout_obj)) ;\n                \n                for(var list in timeout_obj.timeout_list){\n                    if(list !== getAttributeByIndex(timeout_obj.timeout_list, 0)){\n                        update_obj.timeout_list[list].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                        update_obj.timeout_list[list].message = timeout_obj.timeout_list[list].message_id ? get_template(timeout_obj.timeout_list[list].message_id, templates) : null;\n                        update_obj.timeout_list[list].from = timeout_obj.timeout_list[list].from_id ? get_template(timeout_obj.timeout_list[list].from_id, templates) : null;\n                    }\n                }\n                delete update_obj.timeout_list[getAttributeByIndex(timeout_obj.timeout_list, 0)];\n\n                return update_obj ;   \n            }else{\n                return {} ;\n            }\n            break;\n        }\n        \n        case \"user_calculated\" : {\n\n            if(timeout_obj.timeout_list){\n                for(var key in timeout_obj.timeout_list){\n                    if(key == getAttributeByIndex(timeout_obj.timeout_list, 0)){\n                        timeout_obj.timeout_list[key].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[key].delivery_user_ids, users);\n                        timeout_obj.timeout_list[key].template = {\n                            message : timeout_obj.timeout_list[key].message_id ? get_template(timeout_obj.timeout_list[key].message_id, templates) : null ,\n                            from    : timeout_obj.timeout_list[key].from_id ? get_template(timeout_obj.timeout_list[key].from_id, templates) : null\n                        };\n                    }\n                }\n\n                return timeout_obj.timeout_list[getAttributeByIndex(timeout_obj.timeout_list, 0)] ; \n            }else{\n                return {} ; \n            }\n            break;\n        }\n        \n        default: {\n            return {};\n        }\n    }\n}\n\nfunction calculate_page_id(task_obj, details_arr){\n    var page_id = false ;\n    if(task_obj !== null && details_arr !== undefined){\n        var task_id = task_obj._id ;\n        if(details_arr.length){\n            for(var i=0; i < details.length; i++){\n                if(details[i].task_id === task_id){\n                  page_id = details[i].page_id ;\n                }\n            }\n            if(!page_id){\n              return generate_page_id(6);\n            }else{\n              return page_id;\n            }\n        }else{\n            page_id = task_obj.page_id ;\n        }\n    }else{\n        return generate_page_id(6);\n    }\n}\n\nfunction calculate_from_page_id(task_obj, details_arr){\n    var page_id = false ;\n    if(task_obj !== null && details_arr !== undefined){\n        var task_id = task_obj._id ;\n        if(details_arr.length){\n            for(var i=0; i < details.length; i++){\n                if(details[i].task_id === task_id){\n                  page_id = details[i].from_page_id ;\n                }\n            }\n            if(!page_id){\n              return generate_page_id(6);\n            }else{\n              return page_id;\n            }\n        }else{\n            page_id = task_obj.page_id ;\n        }\n    }else{\n        return generate_page_id(6);\n    }\n}\n\nfunction calculate_to_page_id(task_obj, details_arr){\n    var page_id = false ;\n    if(task_obj !== null && details_arr !== undefined){\n        var task_id = task_obj._id ;\n        if(details_arr.length){\n            for(var i=0; i < details.length; i++){\n                if(details[i].task_id === task_id){\n                  page_id = details[i].to_page_id ;\n                }\n            }\n            if(!page_id){\n              return generate_page_id(6);\n            }else{\n              return page_id;\n            }\n        }else{\n            page_id = task_obj.page_id ;\n        }\n    }else{\n        return generate_page_id(6);\n    }\n}\n\nfunction get_location_obj(locations){\n    if(locations === undefined || locations === null){\n        return {};\n    }\n    var obj = {};\n\n    if(locations !== null && locations !== undefined && locations.length){\n        for(var i=0; i< locations.length; i++){\n            if(locations[i]){\n                obj[locations[i]._id] = locations[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_template(id, template){\n    var obj = {} ;\n    if(template !== null){\n        for(var i=0; i< template.length; i++){\n            if(id === template[i]._id){\n                obj = template[i] ;\n            }\n        }    \n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_obj_from_array(id, arr){\n    var obj = {} ;\n\n    if(arr !== null && arr !== undefined && arr.length){\n        for(var i=0; i< arr.length; i++){\n            if(arr[i]._id === id){\n                obj[arr[i]._id] = arr[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}\n\nfunction generate_page_id(length) {\n    return new Date().getTime();\n}\n\nfunction get_from_user(id, user_arr){\n    var obj = {};\n    if(id !== null && user_arr !== null){\n        for(var i=0; i<user_arr.length; i++){\n            if(id === user_arr[i]._id){\n                delete user_arr[i].access_token ;\n                delete user_arr[i].security_level;\n                delete user_arr[i].converstation_id ;\n                delete user_arr[i].password ;\n                delete user_arr[i].code ;\n                obj[user_arr[i]._id] = user_arr[i];\n            }\n        }\n    }else{\n        return obj ;\n    }\n    \n    return obj;\n}\n\nfunction getAttributeByIndex(obj, index){\n  var i = 0;\n  for (var attr in obj){\n    if (index === i){\n      return attr;\n    }\n    i++;\n  }\n  return null;\n}\n\n\nfunction check_number(n){\n    if(typeof n === \"string\" && n !== \"\"){\n        return parseInt(n);\n    }else{\n        return n ;\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 442,
        "y": 421,
        "wires": [
            [
                "dcd29eda.dbf69",
                "afb043c.18d09c",
                "f41c87a4.8fc5c8",
                "65595459.47cbdc",
                "c2821303.e3abb",
                "86859bf3.c76ff8"
            ]
        ]
    },
    {
        "id": "8fef5107.4f42b",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "db_user",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "all_users",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 572,
        "y": 157,
        "wires": [
            [
                "b1a8676a.a88a68"
            ]
        ]
    },
    {
        "id": "c4e12bed.db4da8",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "task_payload",
        "rules": [
            {
                "t": "move",
                "p": "task_payload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 109,
        "y": 214,
        "wires": [
            [
                "562468c3.e382a8"
            ]
        ]
    },
    {
        "id": "562468c3.e382a8",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "by task name",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getTask",
        "index": "searchTask",
        "x": 290,
        "y": 209,
        "wires": [
            [
                "2943b32c.cff1fc"
            ]
        ]
    },
    {
        "id": "2943b32c.cff1fc",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "task",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_obj_by_name",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 441,
        "y": 208,
        "wires": [
            [
                "219cfedf.7e4f12"
            ]
        ]
    },
    {
        "id": "219cfedf.7e4f12",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "timeout id",
        "func": "\nif(check_timeout_obj(msg.task_obj_by_name) !== null && check_timeout_obj(msg.task_obj_by_name) !== \"\"){\n    msg.db_req_obj_timeout = {_id : check_timeout_obj(msg.task_obj_by_name)};\n    return msg;   \n}else{\n    return msg ;\n}\n\nfunction check_timeout_obj(task_obj){\n    if(task_obj !== null){\n        if(task_obj.length){\n            return msg.task_obj_by_name[0].timeout_id ;\n        }else{\n            return \"\" ;\n        }\n    }else{\n        return \"\" ;\n    }\n}\n\n//msg.task_obj_by_name ? msg.task_obj_by_name[0].timeout_id: \"\"",
        "outputs": 1,
        "noerr": 0,
        "x": 598,
        "y": 203,
        "wires": [
            [
                "883c996b.34ef48"
            ]
        ]
    },
    {
        "id": "883c996b.34ef48",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "timeout",
        "rules": [
            {
                "t": "move",
                "p": "db_req_obj_timeout",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 756,
        "y": 202,
        "wires": [
            [
                "f5884722.8bb178"
            ]
        ]
    },
    {
        "id": "f5884722.8bb178",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "db_timeout",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 96,
        "y": 280,
        "wires": [
            [
                "4802cc2a.f0e894"
            ]
        ]
    },
    {
        "id": "4802cc2a.f0e894",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "timeout_obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "timeout_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 284,
        "y": 278,
        "wires": [
            [
                "83e4ce60.00e92"
            ]
        ]
    },
    {
        "id": "83e4ce60.00e92",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "templates",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 459,
        "y": 275,
        "wires": [
            [
                "f6ce4c82.ce29e"
            ]
        ]
    },
    {
        "id": "f6ce4c82.ce29e",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "temp obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "templates",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 619,
        "y": 273,
        "wires": [
            [
                "91176fc8.ffbe1"
            ]
        ]
    },
    {
        "id": "91176fc8.ffbe1",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "user",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 766,
        "y": 270,
        "wires": [
            [
                "8653b3de.e08a2"
            ]
        ]
    },
    {
        "id": "8653b3de.e08a2",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "user obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "user_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 83,
        "y": 347,
        "wires": [
            [
                "1d23c3db.02034c"
            ]
        ]
    },
    {
        "id": "1d23c3db.02034c",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 263,
        "y": 344,
        "wires": [
            [
                "ca779d76.0f6fc"
            ]
        ]
    },
    {
        "id": "ca779d76.0f6fc",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "task_obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "all_task_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 446,
        "y": 338,
        "wires": [
            [
                "d202018e.aa9e6"
            ]
        ]
    },
    {
        "id": "a8615336.c6996",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "input",
        "func": "msg.payload  = \"the lean startup\" ;\nmsg.params = {\n    workspace_id : \"42015e53-bdb9-4a23-87b5-f382d5e12dbb\",\n    username     : \"4db58c57-6d89-4382-9d34-c4044b5fce11\",\n    password     : \"eG0ctZRJO42s\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 596,
        "y": 339,
        "wires": [
            [
                "4874347.c143dcc"
            ]
        ]
    },
    {
        "id": "4874347.c143dcc",
        "type": "watson-conversation-v1",
        "z": "3b9a3280.9d537e",
        "name": "Watson",
        "workspaceid": "42015e53-bdb9-4a23-87b5-f382d5e12dbb",
        "multiuser": false,
        "context": true,
        "x": 743,
        "y": 338,
        "wires": [
            [
                "70aa59d6.600068"
            ]
        ]
    },
    {
        "id": "70aa59d6.600068",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "watson_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 247,
        "y": 404,
        "wires": [
            []
        ]
    },
    {
        "id": "8f4addc2.a5347",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "create_optional_task",
        "func": "msg.recent_detail = msg.payload ;\nmsg.optional_task = create_optonal_task(msg.payload, msg.all_task_obj, msg.default_child_task_id);\nreturn msg ;\n\n\nfunction create_optonal_task(details, task_obj, default_child_task_id){\n    var default_task = get_task_by_name(task_obj, default_child_task_id);\n        current_task = get_current_task(task_obj, details.task_id) ;\n        task_obj = {} ;\n    \n    if(check_obj(default_task) > 0){\n        task_obj = {\n            task_name               : details.user_incoming.message , \n            user_id                 : default_task.user_id || current_task.user_id,\n            \n            page_id                 : details.to_page_id, \n            from_page_id            : details.from_page_id,\n            parent_id               : details.task_id, \n            // from_page_id            : parseInt(details.page_id),\n            // parent_id               : parseInt(details.from_page_id),\n\n            header_template_id      : default_task.header_template_id || current_task.header_template_id,\n            detail_template_id      : default_task.detail_template_id || current_task.detail_template_id,\n            footer_template_id      : default_task.footer_template_id || current_task.footer_template_id,\n            timeout_id              : default_task.timeout_id || current_task.timeout_id,\n            location_id             : default_task.location_id || current_task.location_id,\n            child_default_task_id   : default_task.child_default_task_id || current_task.child_default_task_id,\n            child_default_task_name : default_task.child_default_task_name || current_task.child_default_task_name,\n            date_created            : new Date().toJSON(),\n            type                    : default_task.type || current_task.type,\n            status                  : default_task.status || current_task.status,\n            category                : default_task.category || current_task.category,\n            additional_data_fn      : default_task.additional_data_fn || current_task.additional_data_fn,\n            optional_data           : default_task.optional_data || current_task.optional_data,\n            required_data           : default_task.required_data || current_task.required_data,\n            offline_expiration_time : default_task.offline_expiration_time || current_task.offline_expiration_time,\n            display_if_empty        : default_task.display_if_empty || current_task.display_if_empty \n        };\n    }else{\n        task_obj = {\n            task_name               : details.user_incoming.message, \n            user_id                 : current_task.user_id || null,\n            page_id                 : details.to_page_id, \n            from_page_id            : details.page_id,\n            parent_id               : details.task_id, \n            header_template_id      : current_task.header_template_id || null,\n            detail_template_id      : current_task.detail_template_id || null,\n            footer_template_id      : current_task.footer_template_id || null,\n            timeout_id              : current_task.timeout_id || null,\n            location_id             : current_task.location_id || null,\n            child_default_task_id   : current_task.child_default_task_id || null,\n            child_default_task_name : current_task.child_default_task_name || null,\n            date_created            : new Date().toJSON(),\n            type                    : current_task.type || null,\n            status                  : current_task.status || false,\n            category                : current_task.category || null,\n            additional_data_fn      : current_task.additional_data_fn || null,\n            optional_data           : current_task.optional_data || {},\n            required_data           : current_task.required_data || {},\n            offline_expiration_time : current_task.offline_expiration_time || 0,\n            display_if_empty        : current_task.display_if_empty || true \n        };\n    }\n    return task_obj;\n}\n\nfunction get_task_by_name(arr, name){\n    var obj = {} ;\n    for(var i=0; i<arr.length; i++){\n        if(arr[i]._id === name){\n            obj = arr[i]    ;\n        }\n    }\n    \n    return obj ;\n}\n\nfunction get_current_task(arr, task_id){\n    var obj = {} ;\n    for(var i=0; i<arr.length; i++){\n        if(arr[i]._id === task_id){\n            obj = arr[i]    ;\n        }\n    }\n    return obj ;\n}\n\nfunction check_obj(obj){\n   return Object.keys(obj).length ;\n}\n\nfunction generate_page_id(length) {\n    return new Date().getTime();\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 426,
        "y": 543,
        "wires": [
            [
                "e52b0911.cbb018"
            ]
        ]
    },
    {
        "id": "f41c87a4.8fc5c8",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 700,
        "y": 392,
        "wires": []
    },
    {
        "id": "dcd29eda.dbf69",
        "type": "http response",
        "z": "3b9a3280.9d537e",
        "name": "Result",
        "x": 691,
        "y": 433,
        "wires": []
    },
    {
        "id": "7bc9f32a.a6f09c",
        "type": "http in",
        "z": "3b9a3280.9d537e",
        "name": "Detail",
        "url": "/add_detail",
        "method": "post",
        "swaggerDoc": "",
        "x": 70,
        "y": 31,
        "wires": [
            [
                "89c4da2f.3f4e68"
            ]
        ]
    },
    {
        "id": "8cdd1a5b.3ba338",
        "type": "inject",
        "z": "3b9a3280.9d537e",
        "name": "Start",
        "topic": "Start",
        "payload": "{\"access_token\": \"1489486409169.1pjwj8zy69v\",\"task_name\": \"sub_category_task\",\"note\": \"testing task\" ,\"page_id\": 789456,\"from_page_id\": 2}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 81,
        "y": 89,
        "wires": [
            [
                "89c4da2f.3f4e68"
            ]
        ]
    },
    {
        "id": "afb043c.18d09c",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "Details",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 690,
        "y": 480,
        "wires": []
    },
    {
        "id": "65595459.47cbdc",
        "type": "delay",
        "z": "3b9a3280.9d537e",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 109,
        "y": 545,
        "wires": [
            [
                "8f4addc2.a5347"
            ]
        ]
    },
    {
        "id": "e52b0911.cbb018",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "optional_task",
        "rules": [
            {
                "t": "move",
                "p": "optional_task",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 631,
        "y": 559,
        "wires": [
            [
                "843d9e0c.8819e",
                "87580122.66588",
                "a3cd6ad9.5090e8"
            ]
        ]
    },
    {
        "id": "843d9e0c.8819e",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "Optional Task",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 832,
        "y": 601,
        "wires": []
    },
    {
        "id": "313adc4c.440314",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 93,
        "y": 155,
        "wires": [
            [
                "ccdc3936.795c68"
            ]
        ]
    },
    {
        "id": "ccdc3936.795c68",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "details_obj",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "details_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 258,
        "y": 155,
        "wires": [
            [
                "ce10d70a.553b78"
            ]
        ]
    },
    {
        "id": "8b8c9ab7.b4a8e8",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "Timeout Processor",
        "func": "var detail_obj      = msg.payload ,\n    template_arr    = msg.templates,\n    users_arr       = msg.user_obj;\n\nif(compare_dates(detail_obj.due_date)){\n    msg.payload = create_detail_by_timeout_processor();\n}else{\n  msg.apiStatus = {status: 400, msg: \"Due date already passout so cann't be processed details\"};\n}\n\nreturn msg;\n\nfunction compare_dates(due_date){\n    var current_unix_date   = new Date().getTime(),\n        due_unix_date       = new Date(due_date).getTime();\n        \n    if(due_unix_date > current_unix_date){\n        return true ;\n    }else{\n        return false ;\n    }\n}\n\nfunction create_detail_by_timeout_processor(){\n    var detail = JSON.parse(JSON.stringify(detail_obj));  \n    \n    if(detail.timeout !== null){\n        if(check_obj(detail.timeout.timeout_list) > 0){\n            var clone_obj = {\n                task_id                     : detail_obj.task_id ,\n                child_task_id               : detail_obj.child_task_id,\n                user_id                     : detail_obj.user_id,\n                page_id                     : detail_obj.page_id,\n                synchronized                : detail_obj.synchronized,\n                processed                   : detail_obj.processed,\n                status                      : detail_obj.status,\n                read                        : detail_obj.read,\n                display_if_empty            : detail_obj.display_if_empty,\n                date_created                : detail_obj.date_created,\n                due_date                    : detail_obj.due_date,\n                offline_expiration_seconds  : detail_obj.offline_expiration_seconds,\n                priority                    : detail_obj.priority,\n                user_incoming               : detail_obj.user_incoming ,\n                watson_incoming             : detail_obj.watson_incoming,\n                template                    : detail_obj.template,\n                timeout                     : create_timeout_list_obj(detail.timeout, template_arr, users_arr, \"timeout\") ,\n                user_calculated             : create_timeout_list_obj(detail_obj.timeout, template_arr, users_arr, \"user_calculated\"),\n                location                    : detail_obj.location,\n                default                     : detail_obj.default,\n                createdAt                   : detail_obj.createdAt,\n                count                       : detail_obj.count\n            };\n   \n            return clone_obj ;\n        }else{\n            return {} ;\n        }   \n    }else{\n        return {};\n    }\n}\n\nfunction create_timeout_list_obj(timeout_obj, templates, users, type){\n    switch(type){\n        case \"timeout\" : {\n            if(check_obj(timeout_obj.timeout_list) > 1){\n                \n                for(var list in timeout_obj.timeout_list){\n                    if(parseInt(list) !== getAttributeByIndex(timeout_obj.timeout_list, 0)){\n                        timeout_obj.timeout_list[list].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                        timeout_obj.timeout_list[list].message = timeout_obj.timeout_list[list].message_id ? get_template(timeout_obj.timeout_list[list].message_id, templates) : null;\n                        timeout_obj.timeout_list[list].from = timeout_obj.timeout_list[list].from_id ? get_template(timeout_obj.timeout_list[list].from_id, templates) : null;\n                    }\n                }\n                \n                delete timeout_obj.timeout_list[getAttributeByIndex(timeout_obj.timeout_list, 0)];\n                return timeout_obj ;   \n            }else{\n                return {} ;\n            }\n            break;\n        }\n        \n        case \"user_calculated\" : {\n            if(timeout_obj.timeout_list){\n                for(var key in timeout_obj.timeout_list){\n                    if(parseInt(key) == getAttributeByIndex(timeout_obj.timeout_list, 0)){\n                        timeout_obj.timeout_list[key].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[key].delivery_user_ids, users);\n                        timeout_obj.timeout_list[key].template = {\n                            message : timeout_obj.timeout_list[key].message_id ? get_template(timeout_obj.timeout_list[key].message_id, templates) : null ,\n                            from    : timeout_obj.timeout_list[key].from_id ? get_template(timeout_obj.timeout_list[key].from_id, templates) : null\n                        };\n                    }\n                }\n\n                return timeout_obj.timeout_list[getAttributeByIndex(timeout_obj.timeout_list, 0)] ; \n            }else{\n                return {} ; \n            }\n            break;\n        }\n        \n        default: {\n            return {};\n        }\n    }\n}\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}\n\nfunction get_template(id, template){\n    var obj = {} ;\n    if(template !== null){\n        for(var i=0; i< template.length; i++){\n            if(id === template[i]._id){\n                obj = template[i] ;\n            }\n        }    \n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_obj_from_array(id, arr){\n\n    if(typeof id === \"object\"){\n        return id ;    \n    }\n    \n    var obj = {} ;\n    if(arr !== null && arr.length){\n        for(var i=0; i< arr.length; i++){\n            if(arr[i]._id === id){\n                obj[arr[i]._id] = arr[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction getAttributeByIndex(obj, index){\n  var i = 0;\n  for (var attr in obj){\n    if (index === i){\n      return parseInt(attr);\n    }\n    i++;\n  }\n  return null;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 545,
        "y": 730,
        "wires": [
            [
                "fef6332d.0662",
                "567c8943.df9218",
                "d9ae70b8.7f1d1"
            ]
        ]
    },
    {
        "id": "f221c3b4.94472",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "Timeout processor",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 812,
        "y": 789,
        "wires": []
    },
    {
        "id": "c2821303.e3abb",
        "type": "delay",
        "z": "3b9a3280.9d537e",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 114,
        "y": 614,
        "wires": [
            [
                "56201e3c.1f82d"
            ]
        ]
    },
    {
        "id": "2eb2b368.8322ec",
        "type": "function",
        "z": "a38007c3.b0ee68",
        "name": "F to C",
        "func": "msg.payload = (Math.round((msg.payload - 32) * 50 / 9)/10)\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 158,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "f7272181.dd58e",
        "type": "function",
        "z": "a4a278a8.fe0848",
        "name": "Dimmer value to switch",
        "func": "if(msg.payload === 0) {\n    msg.payload = false;\n}\nelse {\n    msg.payload = true;\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 85,
        "wires": [
            []
        ]
    },
    {
        "id": "e6a2312.44f20d",
        "type": "function",
        "z": "61a5aa7a.4c84c4",
        "name": "currState to payload",
        "func": "msg.payload = JSON.parse(msg.payload)\nvar msg2 = {}\nmsg2.payload = msg.payload.currState;\nreturn msg2;\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 289,
        "y": 132,
        "wires": [
            []
        ]
    },
    {
        "id": "fd001b8a.3c2e28",
        "type": "switch",
        "z": "3b9a3280.9d537e",
        "name": "process",
        "property": "flow_status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_RESPONSE",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 346,
        "y": 64,
        "wires": [
            [
                "a41358b2.73b008"
            ],
            [
                "313adc4c.440314"
            ]
        ]
    },
    {
        "id": "ae60b474.b9ff18",
        "type": "function",
        "z": "d9e3488f.8f93b8",
        "name": "create user task",
        "func": "var task_obj = msg.task_obj ;\n    task_arr = msg.task_arr ;\n    \nmsg.payload = {\n\ttask_id \t\t: get_task_obj_from_arr(task_obj, task_arr),\n\tuser_id\t\t\t: task_obj.user_id,\n\tpage_id         : task_obj.page_id,\n\tsynchronized    : false,\n    status          : false, \n\tdate_updated\t: null,\t\n\tparent_id\t\t: task_obj.parent_id,\n\tcount_status\t: {\n\t   active       : true,\n\t   unread       : false,\n\t},\n\tcount\t\t\t: {\n\t    active      : 0,\n\t    unread      : 0,\n\t},\n\tcount_if\t\t: {\n\t    active      : true,\n\t    unread      : false\n\t},\n\ttemplates\t\t: {},\n\ttimeout\t\t\t: {}\n};\nreturn msg;\n\nfunction get_task_obj_from_arr(obj, arr){\n    var data = null ;\n    if(arr.length && arr !== null){\n        for(var i=0; i < arr.length; i++){\n            if( obj.page_id === arr[i].page_id && \n                sanitize(obj.task_name) === sanitize(arr[i].task_name) &&\n                obj.user_id === arr[i].user_id\n            ){\n                data = arr[i]._id ;\n            }\n        }\n    }\n    \n    return data ;\n}\n\nfunction sanitize(data){\n    if(data && typeof data === \"string\"){\n        return data.trim().toString();\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 184,
        "y": 655,
        "wires": [
            [
                "67fb882b.7660e8",
                "1c870585.74aeea"
            ]
        ]
    },
    {
        "id": "5d5a3b7.c20e2c4",
        "type": "delay",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 161,
        "y": 433,
        "wires": [
            [
                "6b13a73d.1a9ce8"
            ]
        ]
    },
    {
        "id": "1c870585.74aeea",
        "type": "cloudant out",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 434,
        "y": 570,
        "wires": []
    },
    {
        "id": "6b4dfa1f.2d3144",
        "type": "cloudant in",
        "z": "d9e3488f.8f93b8",
        "name": "",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 173,
        "y": 543,
        "wires": [
            [
                "bb78e02a.2bc28"
            ]
        ]
    },
    {
        "id": "bb78e02a.2bc28",
        "type": "change",
        "z": "d9e3488f.8f93b8",
        "name": "changer",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 167,
        "y": 601,
        "wires": [
            [
                "ae60b474.b9ff18"
            ]
        ]
    },
    {
        "id": "67fb882b.7660e8",
        "type": "debug",
        "z": "d9e3488f.8f93b8",
        "name": "User task",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 432,
        "y": 624,
        "wires": []
    },
    {
        "id": "b2123a08.b67888",
        "type": "debug",
        "z": "d9e3488f.8f93b8",
        "name": "Create task",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 378,
        "y": 494,
        "wires": []
    },
    {
        "id": "6b13a73d.1a9ce8",
        "type": "change",
        "z": "d9e3488f.8f93b8",
        "name": "changer",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 162,
        "y": 487,
        "wires": [
            [
                "6b4dfa1f.2d3144"
            ]
        ]
    },
    {
        "id": "961414da.90cd38",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "Changer",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 111,
        "y": 843,
        "wires": [
            [
                "34e6e0dc.23e03"
            ]
        ]
    },
    {
        "id": "34e6e0dc.23e03",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "User Task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 262,
        "y": 867,
        "wires": [
            [
                "5aa5a2ef.6f208c"
            ]
        ]
    },
    {
        "id": "5aa5a2ef.6f208c",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "Changer",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "user_task_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 446,
        "y": 868,
        "wires": [
            [
                "c2434c91.73c5a"
            ]
        ]
    },
    {
        "id": "19a36b57.8fdda5",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "update_create_user_task",
        "func": "var detail_obj          = msg.detail_obj ,\n    task_arr            = msg.task_table ,\n    user_arr            = msg.users_arr ,\n    user_task_arr       = msg.user_task_arr ,\n    isCreated           =  isUserTaskCreated(detail_obj.user_id, detail_obj.task_id, user_task_arr);\n\nif(check_obj(isCreated) > 0){\n    msg.payload = update_user_task(detail_obj.user_id, detail_obj.task_id, false, true);\n    return msg;\n}else{\n    msg.payload = {\n    \ttask_id \t\t: detail_obj.task_id,\n    \tuser_id\t\t\t: detail_obj.user_id,\n    \tpage_id         : parseInt(detail_obj.page_id),\n    \tupdate_read     : false,\n    \tupdate_active   : false, \n    \tsynchronized    : true,\n        status          : false, \n    \tdate_updated\t: null,\t\n    \tparent_id\t\t: null,\n    \tcount_status\t: {\n    \t   active       : true,\n    \t   unread       : false,\n    \t},\n    \tcount\t\t\t: {\n    \t    active      : 0,\n    \t    unread      : 0,\n    \t},\n    \tcount_if\t\t: {\n    \t    active      : true,\n    \t    unread      : false\n    \t},\n    \ttemplates\t\t: {},\n    \ttimeout\t\t\t: {}\n    };\n    return msg;\n}\n\n\nfunction update_user_task(user_id, task_id, status, synchronized){\n    var obj = {} ;\n    var user_task = search_user_task_from_table(user_id, task_id);\n\n    if(check_obj(user_task) > 0){\n        user_task.synchronized          = synchronized || true ;\n        user_task.date_updated          = new Date().toJSON();\n        user_task.templates             = detail_obj.template ;\n        user_task.timeout               = detail_obj.timeout ;\n        user_task.count_status.unread   = !JSON.parse(detail_obj.read) ;\n        user_task.page_id               = parseInt(detail_obj.to_page_id) ;\n        user_task.status                = detail_obj.status || false;\n\n        if(!user_task.update_read){\n            if( ( user_task.count_status.unread === true || user_task.count_status.unread === \"true\") && !user_task.count_if.unread ){\n                user_task.count.unread += 1 ;  \n            }\n        }\n    \n        if(!user_task.update_active){\n            if( user_task.count_status.active && user_task.count_if.active){\n                user_task.count.active += 1 ;  \n            }\n        }\n        \n        if(user_task.parent_id) update_user_task(user_id, user_task.parent_id, false, true);\n        \n        user_task.update_read   = true ;\n        user_task.update_active = true ;\n        return user_task;\n    }else{\n        var user_id_to_calculate = calculate_default_user_from_task_table(detail_obj.task_id, task_arr) ;\n        return calculate_default_user(user_id_to_calculate, user_arr);\n    }\n}\n\nfunction search_user_task_from_table(user_id, task_id){\n    var obj = {};\n    if(user_task_arr !== undefined && user_task_arr !== null){\n        for(var i=0; i< user_task_arr.length; i++){\n            if(\n                user_task_arr[i].user_id    === user_id &&\n                user_task_arr[i].task_id    === task_id\n            ){\n                obj = user_task_arr[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction isUserTaskCreated(user_id, task_id, user_task_arr){\n    var obj = {} ;\n    if(user_task_arr !== null && user_task_arr !== undefined){\n        for(var i=0; i < user_task_arr.length; i++){\n            if(\n                user_task_arr[i].task_id === task_id &&\n                user_task_arr[i].user_id === user_id \n            ){\n                obj = user_task_arr[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction calculate_default_user(id, user_arr){\n    var obj = {};\n    if(id !== null && user_arr !== null){\n        for(var i=0; i<user_arr.length; i++){\n            if(id === user_arr[i]._id){\n                delete user_arr[i].access_token ;\n                delete user_arr[i].security_level;\n                delete user_arr[i].converstation_id ;\n                delete user_arr[i].password ;\n                delete user_arr[i].code ;\n                obj = user_arr[i];\n            }\n        }\n    }else{\n        return obj ;\n    }\n    \n    return obj;\n}\n\nfunction calculate_default_user_from_task_table(task_id , arr){\n    var obj = {} ;\n    if(\n        task_id !== undefined && task_id !== null &&\n        arr     !== undefined && arr     !== null  \n    ){\n        for(var i=0; i< arr.length; i++){\n            if(task_id === arr[i]._id){\n                if(arr.defaults !== null && arr.defaults !== undefined ){\n                    obj = arr.defaults.user ;\n                }else{\n                    return obj ;\n                }\n            }\n        }\n    }else{\n        return obj;\n    }\n}\n\nfunction search_user_task_from_table(user_id, task_id){\n    var obj = {};\n    \n    for(var i=0; i< user_task_arr.length; i++){\n        if(\n            user_task_arr[i].user_id    === user_id &&\n            user_task_arr[i].task_id    === task_id\n        ){\n            obj = user_task_arr[i];\n        }\n    }\n    \n    return obj ;\n}\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 613,
        "y": 941,
        "wires": [
            [
                "964de244.07a1a",
                "76c37c35.65d3a4"
            ]
        ]
    },
    {
        "id": "964de244.07a1a",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "User task processor",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 854,
        "y": 880,
        "wires": []
    },
    {
        "id": "a3cd6ad9.5090e8",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "Add to task table",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 839,
        "y": 523,
        "wires": []
    },
    {
        "id": "d9ae70b8.7f1d1",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "Add to details ",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 801,
        "y": 697,
        "wires": []
    },
    {
        "id": "76c37c35.65d3a4",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "Add to user_task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 846,
        "y": 938,
        "wires": []
    },
    {
        "id": "a41358b2.73b008",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "create response",
        "func": "msg.status = 400 ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 554,
        "y": 48,
        "wires": [
            [
                "c7def129.0fdfb"
            ]
        ]
    },
    {
        "id": "6d1dc023.a4902",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Templates list",
        "url": "/get_all_templates",
        "method": "get",
        "swaggerDoc": "",
        "x": 91,
        "y": 296,
        "wires": [
            [
                "fa5b152c.505728"
            ]
        ]
    },
    {
        "id": "c044651d.cc7628",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 485,
        "y": 296,
        "wires": []
    },
    {
        "id": "c7def129.0fdfb",
        "type": "http response",
        "z": "3b9a3280.9d537e",
        "name": "",
        "x": 740,
        "y": 50,
        "wires": []
    },
    {
        "id": "b1a8676a.a88a68",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "get_users",
        "func": "var access_token = msg.form_data.access_token,\n    users        = msg.all_users;\n\nmsg.db_user = get_user_with_ac(access_token, users);\nmsg.task_payload = \"task_name:\"+msg.form_data.task_name ;\nmsg.form_data.user_id       = msg.db_user._id ;\nmsg.form_data.from_user_id  = msg.db_user._id ;\nreturn msg;\n\nfunction get_user_with_ac(ac, users){\n    var obj = {};\n    if(users !== undefined && users !== null){\n        if(users.length){\n            for(var i=0; i < users.length; i++){\n                if(sanitize(ac) === sanitize(users[i].access_token)){\n                    obj = users[i];\n                }\n            }\n        }\n    }\n    return obj;\n}\n\nfunction sanitize(data){\n    if(data && typeof data === \"string\"){\n        return data.trim().toString();\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 727,
        "y": 158,
        "wires": [
            [
                "c4e12bed.db4da8"
            ]
        ]
    },
    {
        "id": "56201e3c.1f82d",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "init loop",
        "func": "var detail_obj = msg.payload ;\n\nif(detail_obj.timeout !== undefined || detail_obj.timeout !== null){\n    msg.timeoutLength = check_obj(detail_obj.timeout.timeout_list) ;    \n}else{\n    msg.timeoutLength = 0;\n}\nmsg.count = 0;\n\nreturn msg;\n\n\nfunction check_obj(obj){\n    if(obj !== undefined && obj !== null && obj !== \"\"){\n        return Object.keys(obj).length ;\n    }else{\n        return 0;\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 391,
        "y": 619,
        "wires": [
            [
                "feb6e5db.5b8b68"
            ]
        ]
    },
    {
        "id": "feb6e5db.5b8b68",
        "type": "switch",
        "z": "3b9a3280.9d537e",
        "name": "counter",
        "property": "count",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "timeoutLength",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 325,
        "y": 736,
        "wires": [
            [
                "8b8c9ab7.b4a8e8"
            ],
            [
                "5257247c.cbfafc"
            ]
        ]
    },
    {
        "id": "5257247c.cbfafc",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "indicator",
        "func": "msg.payload = \"Timeout processor executes sucessfully\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 519,
        "y": 782,
        "wires": [
            [
                "f221c3b4.94472"
            ]
        ]
    },
    {
        "id": "fef6332d.0662",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "count++",
        "func": "msg.count++ ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 481,
        "y": 676,
        "wires": [
            [
                "feb6e5db.5b8b68"
            ]
        ]
    },
    {
        "id": "567c8943.df9218",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 789,
        "y": 745,
        "wires": []
    },
    {
        "id": "207a643.253979c",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "prepare data for user_task",
        "func": "var task_obj = msg.optional_task ;\n    task_arr = msg.payload ;\n\nmsg.payload = {\n\ttask_id \t\t: get_task_obj_from_arr(task_obj, task_arr),\n\tuser_id\t\t\t: task_obj.user_id,\n\tdate_updated\t: null,\t\n\tparent_id\t\t: task_obj.page_id,\n\tcount_status\t: {\n\t   active       : 0,\n\t   unread       : 0,\n\t},\n\tcount\t\t\t: {\n\t    active      : 0,\n\t    unread      : 0,\n\t},\n\tcount_if\t\t: {\n\t    active      : 0,\n\t    unread      : 0\n\t},\n\ttemplates\t\t: {},\n\ttimeout\t\t\t: {},\n\tdefaults                : {\n        parent              : null,\n        next_child          : null,\n        all_children        : null,\n        user                : task_obj.user_id\n    }\n};\nreturn msg;\n\nfunction get_task_obj_from_arr(obj, arr){\n    var data = null ;\n    if(arr.length && arr !== null){\n        for(var i=0; i < arr.length; i++){\n            if( obj.page_id === arr[i].page_id && \n                sanitize(obj.task_name) === sanitize(arr[i].task_name) &&\n                obj.user_id === arr[i].user_id\n            ){\n                data = arr[i]._id ;\n            }\n        }\n    }\n    return data ;\n}\n\nfunction sanitize(data){\n    if(data && typeof data === \"string\"){\n        return data.trim().toString();\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1343,
        "y": 571,
        "wires": [
            [
                "15fa1f6c.25fd71",
                "2491b81f.bb8518"
            ]
        ]
    },
    {
        "id": "2491b81f.bb8518",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "Add to user_task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1462,
        "y": 625,
        "wires": []
    },
    {
        "id": "86859bf3.c76ff8",
        "type": "delay",
        "z": "3b9a3280.9d537e",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 111,
        "y": 734,
        "wires": [
            [
                "961414da.90cd38"
            ]
        ]
    },
    {
        "id": "15fa1f6c.25fd71",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "creating user_task after optional task",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1524,
        "y": 667,
        "wires": []
    },
    {
        "id": "b3663c9c.97a75",
        "type": "delay",
        "z": "3b9a3280.9d537e",
        "name": "",
        "pauseType": "delay",
        "timeout": "2",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 969,
        "y": 564,
        "wires": [
            [
                "354f7585.d9a95a"
            ]
        ]
    },
    {
        "id": "c59e5b3a.8c02c8",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "optional_task",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 812,
        "y": 563,
        "wires": [
            [
                "b3663c9c.97a75"
            ]
        ]
    },
    {
        "id": "354f7585.d9a95a",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "task_table",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 1128,
        "y": 568,
        "wires": [
            [
                "207a643.253979c"
            ]
        ]
    },
    {
        "id": "c2434c91.73c5a",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "task_table",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 615,
        "y": 867,
        "wires": [
            [
                "a0410c5b.dbcbf"
            ]
        ]
    },
    {
        "id": "a0410c5b.dbcbf",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_table",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 111,
        "y": 945,
        "wires": [
            [
                "23020e1a.1fb342"
            ]
        ]
    },
    {
        "id": "23020e1a.1fb342",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "users",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 252,
        "y": 945,
        "wires": [
            [
                "509a6e9c.2c03a"
            ]
        ]
    },
    {
        "id": "509a6e9c.2c03a",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "users_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 942,
        "wires": [
            [
                "19a36b57.8fdda5"
            ]
        ]
    },
    {
        "id": "1254f6b3.9afac9",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "create Detail",
        "func": "var recent_task         = msg.optional_task ,\n    recent_detail       = msg.recent_detail,\n    recent_task         = msg.payload ;\n    \nmsg.payload = create_detail_message_screen(recent_task, recent_detail);\nreturn msg;\n\nfunction create_detail_message_screen(recent_task, recent_detail){\n    recent_detail.task_id           = recent_task[0]._id ;\n    recent_detail.child_task_id     = recent_task[0]._id ;\n    recent_detail.page_id           = recent_detail.to_page_id ;\n    recent_from_page_id             = recent_detail.page_id ;\n    recent_detail.to_page_id        = recent_task[0].page_id || 2 ;    \n    \n    recent_detail.user_incoming     = {} ;\n    recent_detail.watson_incoming   = {} ;\n    return recent_detail ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1138,
        "y": 701,
        "wires": [
            [
                "26810e84.140202",
                "5440a7c3.3849b8"
            ]
        ]
    },
    {
        "id": "87580122.66588",
        "type": "delay",
        "z": "3b9a3280.9d537e",
        "name": "",
        "pauseType": "delay",
        "timeout": "4",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 811,
        "y": 647,
        "wires": [
            [
                "fede9208.077da"
            ]
        ]
    },
    {
        "id": "9d8962c2.9a2ab",
        "type": "cloudant in",
        "z": "3b9a3280.9d537e",
        "name": "task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getTask",
        "index": "get_by_page_id",
        "x": 1159,
        "y": 646,
        "wires": [
            [
                "1254f6b3.9afac9"
            ]
        ]
    },
    {
        "id": "fede9208.077da",
        "type": "change",
        "z": "3b9a3280.9d537e",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "optional_task",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 947,
        "y": 646,
        "wires": [
            [
                "a824ce8e.87719"
            ]
        ]
    },
    {
        "id": "26810e84.140202",
        "type": "debug",
        "z": "3b9a3280.9d537e",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1314,
        "y": 722,
        "wires": []
    },
    {
        "id": "5440a7c3.3849b8",
        "type": "cloudant out",
        "z": "3b9a3280.9d537e",
        "name": "",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1298,
        "y": 667,
        "wires": []
    },
    {
        "id": "640b76f.1a7a188",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Tasks list",
        "url": "/get_all_tasks",
        "method": "get",
        "swaggerDoc": "",
        "x": 83,
        "y": 348,
        "wires": [
            [
                "22484f2f.bb6d9"
            ]
        ]
    },
    {
        "id": "22484f2f.bb6d9",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 299,
        "y": 344,
        "wires": [
            [
                "b107a530.dac408"
            ]
        ]
    },
    {
        "id": "b107a530.dac408",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 483,
        "y": 344,
        "wires": []
    },
    {
        "id": "b5ee00e8.18692",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 491,
        "y": 400,
        "wires": []
    },
    {
        "id": "5a2459bc.be12c8",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 299,
        "y": 403,
        "wires": [
            [
                "b5ee00e8.18692"
            ]
        ]
    },
    {
        "id": "eebe8495.62faa8",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Details list",
        "url": "/get_all_details",
        "method": "get",
        "swaggerDoc": "",
        "x": 82,
        "y": 402,
        "wires": [
            [
                "5a2459bc.be12c8"
            ]
        ]
    },
    {
        "id": "928d835f.dd798",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Delete Detail",
        "url": "/delete_detail",
        "method": "post",
        "swaggerDoc": "",
        "x": 96,
        "y": 474,
        "wires": [
            [
                "28e35d64.8f7cd2"
            ]
        ]
    },
    {
        "id": "28e35d64.8f7cd2",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "condition",
        "func": "var req_body = msg.req.body ;\n\nnode.warn(\"Reached here..........\");\nnode.warn(req_body);\n\nif(req_body === null || req_body === undefined){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"req_body is required.\"};\n}else if(req_body._id === null || req_body._id === undefined){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"id is required to delete detail.\"};\n}else if(req_body.access_token === undefined && req_body.access_token === null && req_body.access_token === \"\"){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"user_id is required to delete detail.\"};\n}else{\n    msg.status = \"API_SUCCESS\";\n    msg.payload     = {_id : req_body._id};\n    msg.detail_id   = req_body._id ;\n    msg.access_token    = {query: \"access_token:\"+req_body.access_token} ;\n    node.warn(\"access_toekn\");\n    node.warn(msg.access_token);\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 262,
        "y": 472,
        "wires": [
            [
                "b0ec03c4.6ef99"
            ]
        ]
    },
    {
        "id": "b0ec03c4.6ef99",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_SUCCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 412,
        "y": 469,
        "wires": [
            [
                "c81ea1aa.d7a9c"
            ],
            [
                "e2e3e5c9.f47188",
                "5716e9f7.1fd3e8"
            ]
        ]
    },
    {
        "id": "e2e3e5c9.f47188",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 556,
        "y": 525,
        "wires": []
    },
    {
        "id": "c81ea1aa.d7a9c",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "detail",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 555,
        "y": 462,
        "wires": [
            [
                "8ec1d3be.4a9bc"
            ]
        ]
    },
    {
        "id": "3b2ea0e7.15de2",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 1408,
        "y": 428,
        "wires": []
    },
    {
        "id": "9ba3f480.b346a8",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "res",
        "func": "var detail_obj = msg.detail_obj;\n    user_obj   = msg.payload[0] ;\n\nif(detail_obj.user_id === user_obj._id){\n    msg.API_STATUS = \"VALID_CONTENT\";\n    msg.payload = {\n        _id                             : detail_obj._id,\n        _rev                            : detail_obj._rev,\n        task_id                         : detail_obj.task_id,\n        child_task_id                   : detail_obj.child_task_id,\n        user_id                         : detail_obj.user_id,\n        from_user_id                    : detail_obj.from_user_id,\n        page_id                         : detail_obj.page_id,\n        from_page_id                    : detail_obj.from_page_id,\n        to_page_id                      : detail_obj.to_page_id,\n        synchronized                    : detail_obj.synchronized,\n        processed                       : detail_obj.processed ,\n        status                          : detail_obj.status ,\n        read                            : detail_obj.read ,\n        display_if_empty                : false ,\n        date_created                    : detail_obj.date_created ,\n        offline_expiration_seconds      : detail_obj.offline_expiration_seconds ,\n        priority                        : detail_obj.priority ,\n        type                            : detail_obj.type,\n        image                           : detail_obj.image ,\n        from_user                       : detail_obj.from_user,\n        user_incoming                   : detail_obj.user_incoming,\n        watson_incoming                 : detail_obj.watson_incoming,\n        template                        : detail_obj.template ,\n        user_calculate                  : detail_obj.user_calculate,\n        location                        : detail_obj.location,\n        default                         : detail_obj.default,\n        createdAt                       : detail_obj.createdAt\n    };\n}else{\n    msg.API_STATUS = \"INVALID_CONTENT\";\n    msg.statusCode = 403 ;\n    msg.api_result = {status: 403, error: false, data: \"You are not authorized to remove record\"};    \n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1004,
        "y": 467,
        "wires": [
            [
                "44a7e793.d5de78"
            ]
        ]
    },
    {
        "id": "5ed6659b.03c98c",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "api_result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1177,
        "y": 435,
        "wires": [
            [
                "3b2ea0e7.15de2",
                "246b98f2.516a08"
            ]
        ]
    },
    {
        "id": "d45bdfe1.6ec55",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "Update record",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1194,
        "y": 333,
        "wires": []
    },
    {
        "id": "1518dd68.3c4743",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Users Task",
        "url": "/get_user_task/:page_id/:user_id",
        "method": "get",
        "swaggerDoc": "",
        "x": 87,
        "y": 530,
        "wires": [
            [
                "88bf9057.51f98"
            ]
        ]
    },
    {
        "id": "88bf9057.51f98",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "params",
        "func": "msg.params = {\n    page_id : msg.req.params.page_id,\n    user_id : msg.req.params.user_id\n};\n\nif(msg.params.page_id === null || msg.params.page_id === \"\"){\n    msg.status  = \"API_VALIDATION_ERR\";\n    msg.payload = {status: 400, error: true, msg: \"Please check `page_id`\"};\n    return msg;\n}else if(msg.params.user_id === null || msg.params.user_id === \"\"){\n    msg.status  = \"API_VALIDATION_ERR\";\n    msg.payload = {status: 400, error: true, msg: \"Please check `user_id`\"};\n    return msg;\n}else{\n    msg.status = \"API_SUCCESS\";\n    return msg;\n}\n\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "x": 246,
        "y": 531,
        "wires": [
            [
                "2fc8a34d.1074ec"
            ]
        ]
    },
    {
        "id": "157970cf.a0728f",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 830,
        "y": 584,
        "wires": []
    },
    {
        "id": "27a5aa33.e225f6",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 851,
        "y": 626,
        "wires": []
    },
    {
        "id": "db82b7e9.c32098",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "User task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 471,
        "y": 582,
        "wires": [
            [
                "5b1af1b0.9e25b"
            ]
        ]
    },
    {
        "id": "5b1af1b0.9e25b",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "calculate userTask",
        "func": "var params          = msg.params ,\n    user_task_arr   = msg.payload ; \nmsg.payload = get_user_task(params, user_task_arr);\n\nreturn msg;\n\n\nfunction get_user_task(params, arr){\n    var obj = {} ;\n    if(check_obj(params) > 0){\n        if(arr !== undefined && arr !== null){\n            for(var i=0; i < arr.length; i++){\n                if(\n                    parseInt(arr[i].page_id) === parseInt(params.page_id) &&\n                    arr[i].user_id === params.user_id \n                ){\n                    obj = arr[i];\n                }\n            }\n        }else{\n            obj.status = 400 ;\n            obj.error  = true ;\n            obj.msg    = \"Unable to fetch user task.\";\n            return obj;    \n        }\n    }else{\n        obj.status = 400 ;\n        obj.error  = true ;\n        obj.msg    = \"Required params like `page_id` and `user_id` to get user_task.\";\n        return obj;\n    }\n    \n    if(check_obj(obj) > 0){\n        return obj;\n    }else{\n        obj.status = 200 ;\n        obj.error  = false ;\n        obj.msg    = \"There is no task associated with this user\";\n        obj.data   = [];\n        return obj;\n    }\n    \n}\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 647,
        "y": 583,
        "wires": [
            [
                "27a5aa33.e225f6",
                "157970cf.a0728f"
            ]
        ]
    },
    {
        "id": "2fc8a34d.1074ec",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_SUCCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 326,
        "y": 586,
        "wires": [
            [
                "db82b7e9.c32098"
            ],
            [
                "a5cbc8d.a6d5b38"
            ]
        ]
    },
    {
        "id": "a5cbc8d.a6d5b38",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 466,
        "y": 636,
        "wires": []
    },
    {
        "id": "dc0515bd.504c68",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Formatted Task",
        "url": "/get_task_names",
        "method": "get",
        "swaggerDoc": "",
        "x": 116,
        "y": 1042,
        "wires": [
            [
                "72bed019.e97e9"
            ]
        ]
    },
    {
        "id": "72bed019.e97e9",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 362,
        "y": 1040,
        "wires": [
            [
                "df53b7d2.08d318"
            ]
        ]
    },
    {
        "id": "df53b7d2.08d318",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "response",
        "func": "var tasks_arr = msg.payload , obj = {} ;\n\nif(tasks_arr === null || tasks_arr === undefined){\n    obj.status = 400 ;\n    obj.error  = true ;\n    obj.msg    = \"Unable to get the tasks\";\n    msg.paylod = obj ;\n}else{\n    if(tasks_arr.length){\n        var tasks = [];\n        for(var i=0; i < tasks_arr.length; i++){\n            tasks.push({\n                id           : tasks_arr[i]._id,\n                task_name    : tasks_arr[i].task_name || \"N/A\"     \n            });\n        }\n        obj.status = 200 ;\n        obj.error  = false ;\n        obj.msg    = \"Record fecthed successfully\";\n        obj.data   = tasks ;\n        msg.payload = obj ;\n    }else{\n        obj.status = 200 ;\n        obj.error  = false ;\n        obj.msg    = \"There is not task present\";\n        msg.paylod = obj ;\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 558,
        "y": 1040,
        "wires": [
            [
                "d1999932.e7a968"
            ]
        ]
    },
    {
        "id": "d1999932.e7a968",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 740,
        "y": 1038,
        "wires": []
    },
    {
        "id": "4123a06.222a66",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "update_detail -- not in use",
        "url": "/update_detail",
        "method": "put",
        "swaggerDoc": "",
        "x": 144,
        "y": 814,
        "wires": [
            [
                "5acf1735.00c968"
            ]
        ]
    },
    {
        "id": "5acf1735.00c968",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "condition",
        "func": "var req_body  = msg.req.body;\n\nif(detail_id === null || detail_id === undefined){\n    msg.status = \"API_VALIDATION_ERR\"   ;\n    msg.payload = {status: 400, error: true, msg: \"detail_id is missing to update record\"};\n}else if(req_body !== undefined && req_body !== null){\n    if(count_obj(req_body) < 0){\n        msg.status = \"API_VALIDATION_ERR\"   ;\n        msg.payload = {status: 400, error: true, msg: \"req_body must to present to update detail\"};    \n    }else{\n        msg.status = \"API_VALIDATION_ERR\"   ;\n        msg.payload = {status: 400, error: true, msg: \"req_body must be a object.\"};    \n    }\n}else{\n    msg.status      = \"API_SUCCESS\";\n    msg.detail_id   = req_body._id ;\n    msg.body        = req_body;\n}\n\nreturn msg;\n\nfunction count_obj(obj){\n    return Object.keys(obj).length ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 263,
        "y": 769,
        "wires": [
            [
                "d77ee050.52188"
            ]
        ]
    },
    {
        "id": "d77ee050.52188",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_SUCCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 395,
        "y": 770,
        "wires": [
            [
                "43e9689a.7afbd8"
            ],
            [
                "3e540348.c1461c"
            ]
        ]
    },
    {
        "id": "3e540348.c1461c",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 510,
        "y": 817,
        "wires": []
    },
    {
        "id": "43e9689a.7afbd8",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "",
        "func": "msg.payload = {_id : msg.detail_id}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 519,
        "y": 763,
        "wires": [
            [
                "ef052bf2.286e88"
            ]
        ]
    },
    {
        "id": "ef052bf2.286e88",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 637,
        "y": 763,
        "wires": [
            [
                "c4c99940.ca2708"
            ]
        ]
    },
    {
        "id": "c4c99940.ca2708",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "",
        "func": "var db_detail_obj = msg.payload ;\n    req_obj       = msg.body ;\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 768,
        "y": 762,
        "wires": [
            [
                "e1a15e47.3c6a6"
            ]
        ]
    },
    {
        "id": "e1a15e47.3c6a6",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 895,
        "y": 810,
        "wires": []
    },
    {
        "id": "39239aa4.ae8f86",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "Change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1182,
        "y": 556,
        "wires": [
            [
                "fd4bca54.23f438"
            ]
        ]
    },
    {
        "id": "fd4bca54.23f438",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 1331,
        "y": 554,
        "wires": [
            [
                "365294ec.37f20c"
            ]
        ]
    },
    {
        "id": "365294ec.37f20c",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "init",
        "func": "var detail          = msg.detail_obj ,\n    user_task_arr   = msg.payload ;       \n\nmsg.calculated_task = get_user_task(detail, user_task_arr);\nmsg.user_task_length = msg.calculated_task.length ;\nmsg.counter = 0 ;\n\nnode.warn(msg.calculated_task);\nnode.warn(msg.calculated_task.length);\nreturn msg;\n\nfunction get_user_task(detail, user_tasks){\n    var tasks = [];\n    if(detail !== null && detail !== undefined){\n        if(user_tasks !== null && user_tasks !== undefined){\n            for(var i=0; i < user_tasks.length; i++){\n                console.log(parseInt(detail.to_page_id));\n                console.log(parseInt(user_tasks[i].page_id));\n                console.log(detail.user_id);\n                console.log(user_tasks[i].user_id);\n                \n                \n                if(\n                    parseInt(detail.to_page_id) === parseInt(user_tasks[i].page_id)  &&\n                    detail.user_id    === user_tasks[i].user_id\n                ){\n                    user_tasks[i].status = false   ;\n                    if(user_tasks[i].count){\n                        user_tasks[i].count.active = 0 ;\n                        user_tasks[i].count.unread = 0 ;\n                    }\n                    tasks.push(user_tasks[i]);  \n                }\n            }\n        }\n    }\n    return tasks ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1471,
        "y": 606,
        "wires": [
            [
                "d335c687.81a508"
            ]
        ]
    },
    {
        "id": "d335c687.81a508",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "user_task_length",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1606,
        "y": 708,
        "wires": [
            [
                "e9b16fbd.58f52"
            ],
            [
                "21047536.37830a"
            ]
        ]
    },
    {
        "id": "e9b16fbd.58f52",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "payload",
        "func": "var user_task_obj = msg.calculated_task[msg.counter] ;\nmsg.payload = {\n  \"_id\": user_task_obj._id,\n  \"_rev\": user_task_obj._rev, \n  \"task_id\": user_task_obj.task_id,\n  \"user_id\": user_task_obj.user_id,\n  \"page_id\": user_task_obj.page_id,\n  \"synchronized\": user_task_obj.synchronized,\n  \"status\": user_task_obj.status,\n  \"date_updated\": user_task_obj.date_updated,\n  \"parent_id\": user_task_obj.parent_id,\n  \"count_status\": user_task_obj.count_status,\n  \"count\": user_task_obj.count,\n  \"count_if\": user_task_obj.count_if,\n  \"templates\": user_task_obj.templates,\n  \"timeout\": user_task_obj.timeout\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1755,
        "y": 705,
        "wires": [
            [
                "28038b9e.d664b4",
                "9f6187c7.343728"
            ]
        ]
    },
    {
        "id": "28038b9e.d664b4",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "counter++",
        "func": "msg.counter++ ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1684,
        "y": 640,
        "wires": [
            [
                "d335c687.81a508"
            ]
        ]
    },
    {
        "id": "21047536.37830a",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "Finish",
        "func": "msg.payload = \"User tasks updated successfully\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1747,
        "y": 745,
        "wires": [
            [
                "2b0b116d.d75cee"
            ]
        ]
    },
    {
        "id": "2b0b116d.d75cee",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1951,
        "y": 747,
        "wires": []
    },
    {
        "id": "9f6187c7.343728",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "user_task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1941,
        "y": 651,
        "wires": []
    },
    {
        "id": "325c4c3.eb40eb4",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "updatedObj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1182,
        "y": 506,
        "wires": [
            [
                "1377accf.f97593"
            ]
        ]
    },
    {
        "id": "1377accf.f97593",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 1321,
        "y": 505,
        "wires": [
            [
                "64366a88.dc8704"
            ]
        ]
    },
    {
        "id": "64366a88.dc8704",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "init",
        "func": "var detail_arr = msg.payload ,\n    detail_obj = msg.updatedObj ;\n\nmsg.filtredArr = getDetailByToPageId(detail_arr, detail_obj);\nmsg.counter = 0;\nmsg.detail_length = msg.filtredArr.length;\nreturn msg;\n\nfunction getDetailByToPageId(arr, obj){\n    var results = [];\n    for(var i=0; i < arr.length; i++){\n        if(parseInt(arr[i].page_id) === parseInt(obj.to_page_id)){\n            results.push(arr[i]);\n        }\n    }\n    return results;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1462,
        "y": 524,
        "wires": [
            [
                "562bf1ae.3ec36"
            ]
        ]
    },
    {
        "id": "562bf1ae.3ec36",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "detail_length",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1604,
        "y": 549,
        "wires": [
            [
                "37795d13.bf9ef2"
            ],
            [
                "cfa5eee7.77022"
            ]
        ]
    },
    {
        "id": "37795d13.bf9ef2",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "payload",
        "func": "msg.payload = msg.filtredArr[msg.counter];\nmsg.payload.display_if_empty = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1803,
        "y": 542,
        "wires": [
            [
                "d1e38600.dd4d58",
                "5902c867.47da38"
            ]
        ]
    },
    {
        "id": "d1e38600.dd4d58",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "counter++",
        "func": "msg.counter++ ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1682,
        "y": 470,
        "wires": [
            [
                "562bf1ae.3ec36"
            ]
        ]
    },
    {
        "id": "5902c867.47da38",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "Update Detail",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1959,
        "y": 508,
        "wires": []
    },
    {
        "id": "cfa5eee7.77022",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "Finish",
        "func": "msg.payload = \"Update all child details as well.\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1795,
        "y": 578,
        "wires": [
            [
                "4c0c30d5.c81f1"
            ]
        ]
    },
    {
        "id": "4c0c30d5.c81f1",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1949,
        "y": 578,
        "wires": []
    },
    {
        "id": "680941b7.3f0d6",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Formatted Users",
        "url": "/get_users",
        "method": "get",
        "swaggerDoc": "",
        "x": 112,
        "y": 894,
        "wires": [
            [
                "5cafb19.b3b295"
            ]
        ]
    },
    {
        "id": "5cafb19.b3b295",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "users",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 337,
        "y": 891,
        "wires": [
            [
                "5fa8c572.597dbc"
            ]
        ]
    },
    {
        "id": "5fa8c572.597dbc",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "response",
        "func": "var users   = msg.payload , updated_user = [];\n\nif(users === null || users === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!users.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: users};\n}else{\n    for(var i=0; i< users.length; i++){\n        updated_user.push({id : users[i]._id, name: users[i].first_name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_user};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 556,
        "y": 890,
        "wires": [
            [
                "40296a0d.f9d2b4"
            ]
        ]
    },
    {
        "id": "40296a0d.f9d2b4",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 737,
        "y": 888,
        "wires": []
    },
    {
        "id": "82b3d811.452e08",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Formatted Timeout",
        "url": "/get_all_timeout",
        "method": "get",
        "swaggerDoc": "",
        "x": 123,
        "y": 949,
        "wires": [
            [
                "9dc9694.382d798"
            ]
        ]
    },
    {
        "id": "9dc9694.382d798",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Timeout",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 350,
        "y": 946,
        "wires": [
            [
                "6547f3fe.49394c"
            ]
        ]
    },
    {
        "id": "6547f3fe.49394c",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "response",
        "func": "var timeout   = msg.payload , updated_timeout = [];\n\nif(timeout === null || timeout === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!timeout.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: timeout};\n}else{\n    for(var i=0; i< timeout.length; i++){\n        updated_timeout.push({id : timeout[i]._id, name: timeout[i].name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_timeout};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 556,
        "y": 943,
        "wires": [
            [
                "5c8c358c.02801c"
            ]
        ]
    },
    {
        "id": "5c8c358c.02801c",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 736,
        "y": 941,
        "wires": []
    },
    {
        "id": "6d573f5a.bef1e",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Formatted location",
        "url": "/get_all_location",
        "method": "get",
        "swaggerDoc": "",
        "x": 125,
        "y": 995,
        "wires": [
            [
                "5ada7917.c34df8"
            ]
        ]
    },
    {
        "id": "5ada7917.c34df8",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Location",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 352,
        "y": 992,
        "wires": [
            [
                "189bb926.855f77"
            ]
        ]
    },
    {
        "id": "189bb926.855f77",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "response",
        "func": "var location   = msg.payload , updated_location = [];\n\nif(location === null || location === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!location.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: location};\n}else{\n    for(var i=0; i< location.length; i++){\n        updated_location.push({id : location[i]._id, name: location[i].location_name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_location};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 553,
        "y": 990,
        "wires": [
            [
                "5084712e.18164"
            ]
        ]
    },
    {
        "id": "5084712e.18164",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 736,
        "y": 991,
        "wires": []
    },
    {
        "id": "a824ce8e.87719",
        "type": "function",
        "z": "3b9a3280.9d537e",
        "name": "recent_task",
        "func": "msg.payload = {\n    query:\"page_id:\"+ check_number(msg.optional_task.page_id),\n    sort:[\"_id<string>\"]\n};\nreturn msg;\n\n\nfunction check_number(n){\n    if(typeof n === \"string\" && n !== \"\"){\n        return parseInt(n);\n    }else{\n        return n ;\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1082,
        "y": 611,
        "wires": [
            [
                "9d8962c2.9a2ab"
            ]
        ]
    },
    {
        "id": "fea269eb.c14618",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Task by Id",
        "url": "/get_task_by/:task_id",
        "method": "get",
        "swaggerDoc": "",
        "x": 92,
        "y": 703,
        "wires": [
            [
                "2c90a94d.4decf6"
            ]
        ]
    },
    {
        "id": "2c90a94d.4decf6",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "condition",
        "func": "var params = msg.req.params;\n\nif(params.task_id !== undefined && params.task_id !== \"\"){\n    msg.API_STATUS = \"API_SUCCESS\";\n    msg.payload    = {_id : params.task_id};\n    return msg;\n}else{\n    msg.API_STATUS = \"API_ERROR\";\n    msg.payload    = {status: 400, error: true, msg: \"Validation error\", data: null};\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 275,
        "y": 703,
        "wires": [
            [
                "1a5e5607.2f0a0a"
            ]
        ]
    },
    {
        "id": "1a5e5607.2f0a0a",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_SUCCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 405,
        "y": 701,
        "wires": [
            [
                "7db3d66e.175c28"
            ],
            [
                "176a8c07.210764"
            ]
        ]
    },
    {
        "id": "176a8c07.210764",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 815,
        "y": 717,
        "wires": []
    },
    {
        "id": "7db3d66e.175c28",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 526,
        "y": 687,
        "wires": [
            [
                "b02a73fd.69344"
            ]
        ]
    },
    {
        "id": "b02a73fd.69344",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "res",
        "func": "if(msg.payload === null){\n    msg.payload = {status: 200, error: false, msg:\"No record found\", data: {}};\n    return msg;\n}else{\n    msg.payload = {status: 200, error: false, msg:\"Record fecthed successfully\", data: msg.payload};\n    return msg;    \n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 651,
        "y": 686,
        "wires": [
            [
                "176a8c07.210764"
            ]
        ]
    },
    {
        "id": "8ec1d3be.4a9bc",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 692,
        "y": 461,
        "wires": [
            [
                "fc41ca86.c75b38"
            ]
        ]
    },
    {
        "id": "ca159d1d.d25c7",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 1002,
        "y": 514,
        "wires": [
            [
                "9ba3f480.b346a8"
            ]
        ]
    },
    {
        "id": "5bdf73aa.a1ae3c",
        "type": "inject",
        "z": "b36c258c.f48c68",
        "name": "start",
        "topic": "start",
        "payload": "start",
        "payloadType": "flow",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 84,
        "y": 394,
        "wires": [
            [
                "37b16c28.badbd4"
            ]
        ]
    },
    {
        "id": "37b16c28.badbd4",
        "type": "function",
        "z": "b36c258c.f48c68",
        "name": "",
        "func": "msg.payload = {\n    query: \"access_token:1491559739601.9v8j0nep470vygb9\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 231,
        "y": 422,
        "wires": [
            [
                "414c1708.25b468"
            ]
        ]
    },
    {
        "id": "414c1708.25b468",
        "type": "cloudant in",
        "z": "b36c258c.f48c68",
        "name": "",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 383,
        "y": 419,
        "wires": [
            [
                "68cf7e0d.648f9"
            ]
        ]
    },
    {
        "id": "68cf7e0d.648f9",
        "type": "debug",
        "z": "b36c258c.f48c68",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 608,
        "y": 467,
        "wires": []
    },
    {
        "id": "fc41ca86.c75b38",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "move",
        "rules": [
            {
                "t": "move",
                "p": "access_token",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 836,
        "y": 460,
        "wires": [
            [
                "ca159d1d.d25c7",
                "d7fc86f2.a4f358"
            ]
        ]
    },
    {
        "id": "44a7e793.d5de78",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "Condition",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "VALID_CONTENT",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1011,
        "y": 417,
        "wires": [
            [
                "d45bdfe1.6ec55",
                "39239aa4.ae8f86",
                "f1cf2a9a.3914a8",
                "82e347f.1fb19b8",
                "325c4c3.eb40eb4"
            ],
            [
                "5ed6659b.03c98c"
            ]
        ]
    },
    {
        "id": "246b98f2.516a08",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1425,
        "y": 377,
        "wires": []
    },
    {
        "id": "f1cf2a9a.3914a8",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "api res",
        "func": "msg.payload = {status: 200, error: false, data: \"Record deleted successfully\"}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1170,
        "y": 389,
        "wires": [
            [
                "59a5d5af.49e60c"
            ]
        ]
    },
    {
        "id": "59a5d5af.49e60c",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 1392,
        "y": 325,
        "wires": []
    },
    {
        "id": "82e347f.1fb19b8",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1182,
        "y": 294,
        "wires": []
    },
    {
        "id": "eeddd1cb.d3c1f",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Update Task",
        "url": "/update_task",
        "method": "post",
        "swaggerDoc": "",
        "x": 108,
        "y": 1118,
        "wires": [
            [
                "3603261a.78605a"
            ]
        ]
    },
    {
        "id": "53b876a.63a0788",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 629,
        "y": 1155,
        "wires": []
    },
    {
        "id": "3603261a.78605a",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "msg.payload",
        "func": "var task_obj = msg.req.body;\n\nmsg.payload = {\n        _id                         : task_obj._id,\n        _rev                        : task_obj._rev,\n        task_name                   : task_obj.task_name,\n        user_id                     : task_obj.user_id,\n        page_id                     : task_obj.page_id,\n        from_page_id                : task_obj.from_page_id,\n        parent_id                   : task_obj.parent_id,\n        header_template_id          : task_obj.header_template_id,\n        detail_template_id          : task_obj.detail_template_id,\n        footer_template_id          : task_obj.footer_template_id,\n        timeout_id                  : task_obj.timeout_id,\n        child_default_task_id       : task_obj.child_default_task_id,\n        child_default_task_name     : task_obj.child_default_task_name,\n        date_created                : task_obj.date_created,\n        type                        : task_obj.type,\n        status                      : task_obj.status,\n        category                    : task_obj.category,\n        additional_data_fn          : task_obj.additional_data_fn,\n        optional_data               : task_obj.optional_data,\n        required_data               : task_obj.required_data,\n        offline_expiration_time     : task_obj.offline_expiration_time,\n        display_if_empty            : task_obj.display_if_empty,\n        image                       : task_obj.image\n    };\n    \nmsg.api_result = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 300,
        "y": 1118,
        "wires": [
            [
                "bce76a51.a086d8",
                "30a70443.cc294c"
            ]
        ]
    },
    {
        "id": "bce76a51.a086d8",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "Update record",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 508,
        "y": 1106,
        "wires": []
    },
    {
        "id": "30a70443.cc294c",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "api result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 487,
        "y": 1159,
        "wires": [
            [
                "53b876a.63a0788"
            ]
        ]
    },
    {
        "id": "781230d2.ba8ef",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Users",
        "url": "/get_all_users",
        "method": "get",
        "swaggerDoc": "",
        "x": 517,
        "y": 91,
        "wires": [
            [
                "1a775952.aabea7"
            ]
        ]
    },
    {
        "id": "1a775952.aabea7",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Users Collections",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 675,
        "y": 142,
        "wires": [
            [
                "8463e60d.def898"
            ]
        ]
    },
    {
        "id": "8463e60d.def898",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 876,
        "y": 142,
        "wires": []
    },
    {
        "id": "caf3d191.e43cf",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Update User",
        "url": "/update_user_info/:user_id",
        "method": "put",
        "swaggerDoc": "",
        "x": 109,
        "y": 1213,
        "wires": [
            [
                "62dfd57.897002c"
            ]
        ]
    },
    {
        "id": "62dfd57.897002c",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "payload",
        "func": "\nif(msg.req.params.user_id !== undefined && msg.req.params.user_id !== null && msg.req.params.user_id !== \"\"){\n    msg.API_STATUS = \"SUCESS\" ;\n    msg.payload = {_id : msg.req.params.user_id};    \n    msg.req_body = msg.req.body;\n    return msg;\n}else{\n    msg.API_STATUS = \"ERROR\" ;\n    msg.api_result = {status: 400, error: true, msg: \"`user_id` is missing\", data: []};\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 260,
        "y": 1213,
        "wires": [
            [
                "cde2cc11.96925"
            ]
        ]
    },
    {
        "id": "5294f6b.d894108",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 924,
        "y": 1259,
        "wires": []
    },
    {
        "id": "ac862531.cdfeb8",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "api result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 778,
        "y": 1259,
        "wires": [
            [
                "5294f6b.d894108"
            ]
        ]
    },
    {
        "id": "23ea141b.8110bc",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "payload",
        "func": "var req_body = msg.req.body;\n    user_obj = msg.payload ;\nmsg.payload = {\n            _id: req_body.user_id,\n            _rev: user_obj._rev,\n            virtual_phone: req_body.phone,\n            email: req_body.email,\n            first_name: req_body.f_name,\n            last_name: req_body.l_name,\n            password: req_body.phone,\n        };\n    node.warn(msg.payload);\nmsg.api_result = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 619,
        "y": 1219,
        "wires": [
            [
                "ac862531.cdfeb8",
                "cbcc8872.c2da48"
            ]
        ]
    },
    {
        "id": "66c4ba2.65ed844",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "User",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 492,
        "y": 1220,
        "wires": [
            [
                "23ea141b.8110bc"
            ]
        ]
    },
    {
        "id": "cbcc8872.c2da48",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 772,
        "y": 1217,
        "wires": []
    },
    {
        "id": "cde2cc11.96925",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "split",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "SUCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 379,
        "y": 1252,
        "wires": [
            [
                "66c4ba2.65ed844"
            ],
            [
                "ac862531.cdfeb8"
            ]
        ]
    },
    {
        "id": "44ad3842.62e8a8",
        "type": "http in",
        "z": "b36c2dc1.25c34",
        "name": "Update short detail",
        "url": "/update_short_details",
        "method": "put",
        "swaggerDoc": "",
        "x": 129,
        "y": 1371,
        "wires": [
            [
                "eeb733fb.99ea5"
            ]
        ]
    },
    {
        "id": "7186c287.a7506c",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "2. access_token",
        "func": "node.warn(JSON.stringify(msg.user_data));\nvar access_token = msg.user_data.access_token;\n\nmsg.payload = {\"access_token\": access_token};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 180,
        "wires": [
            [
                "d86876c3.a368d8"
            ]
        ]
    },
    {
        "id": "41a10368.8822bc",
        "type": "http response",
        "z": "505a09c5.621328",
        "name": "API Result",
        "x": 810,
        "y": 80,
        "wires": []
    },
    {
        "id": "7855dba7.bded24",
        "type": "http in",
        "z": "505a09c5.621328",
        "name": "",
        "url": "/api/gettoken",
        "method": "get",
        "swaggerDoc": "",
        "x": 230,
        "y": 80,
        "wires": [
            [
                "ee5676a9.76c848"
            ]
        ]
    },
    {
        "id": "ee5676a9.76c848",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "generate ac",
        "func": "var rand = function() {\n    return Math.random().toString(36).substr(2); // remove `0.`\n};\nvar time = function() {\n    //return new Date().getTime().toString(36);\n    return new Date().getTime();\n};\n\nvar token = function() {\n    return time()+'.'+rand(); // to make it longer\n};\n\nvar access_token = token();\nvar payload = {\"access_token\": access_token};\nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 80,
        "wires": [
            [
                "41a10368.8822bc"
            ]
        ]
    },
    {
        "id": "c4a9d59c.74eac8",
        "type": "http response",
        "z": "505a09c5.621328",
        "name": "API Result",
        "x": 1030,
        "y": 340,
        "wires": []
    },
    {
        "id": "7803a4ba.36e64c",
        "type": "debug",
        "z": "505a09c5.621328",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 409,
        "y": 287,
        "wires": []
    },
    {
        "id": "d58df840.89ee38",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_output[0], user_data = msg.user_data, payload = {};\nvar code = global.get('code');\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\nif(check_obj(db_data) > 0) {\n    payload = {\n        _id:            db_data._id,\n        _rev:           db_data._rev,\n        access_token:   db_data.access_token,\n        phone:          user_data.phone,\n        security_level: db_data.security_level,\n        code:           code\n    };\n}\nelse {\n    payload = {\n        access_token:   user_data.access_token,\n        phone:          user_data.phone,\n        security_level: 0,\n        code:           code\n    };\n}\n\nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 180,
        "y": 320,
        "wires": [
            [
                "7803a4ba.36e64c",
                "b75807ef.c8af88",
                "426e5187.75c3d"
            ]
        ]
    },
    {
        "id": "61e00bf5.7542f4",
        "type": "http in",
        "z": "505a09c5.621328",
        "name": "",
        "url": "/api/login",
        "method": "get",
        "swaggerDoc": "",
        "x": 110,
        "y": 180,
        "wires": [
            [
                "db69296f.28fea8"
            ]
        ]
    },
    {
        "id": "db69296f.28fea8",
        "type": "change",
        "z": "505a09c5.621328",
        "name": "Move to user_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "user_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 310,
        "y": 180,
        "wires": [
            [
                "7186c287.a7506c"
            ]
        ]
    },
    {
        "id": "d86876c3.a368d8",
        "type": "cloudant in",
        "z": "505a09c5.621328",
        "name": "get user by token",
        "cloudant": "76512216.4472ac",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 730,
        "y": 180,
        "wires": [
            [
                "de85adbc.6754"
            ]
        ]
    },
    {
        "id": "de85adbc.6754",
        "type": "change",
        "z": "505a09c5.621328",
        "name": "Move to db_output",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_output",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 950,
        "y": 180,
        "wires": [
            [
                "476a5d90.6a0424"
            ]
        ]
    },
    {
        "id": "426e5187.75c3d",
        "type": "cloudant out",
        "z": "505a09c5.621328",
        "name": "save user to db",
        "cloudant": "76512216.4472ac",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 420,
        "y": 340,
        "wires": []
    },
    {
        "id": "d00e1b1b.93e768",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "11. return verify page & ac",
        "func": "var response = {\n    \"page_id\":      11,\n    \"access_token\": global.get('access_token')\n};\nresponse.code = global.get('code');//needs to remove later\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 340,
        "wires": [
            [
                "c4a9d59c.74eac8"
            ]
        ]
    },
    {
        "id": "476a5d90.6a0424",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "generate random 4 digits",
        "func": "var code = \"\";\nvar rand = function() {\n    return Math.floor(1000 + Math.random() * 9000);\n};\n\ncode = rand();\n//node.warn('code>>>',code);\nglobal.set('code', code);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 190,
        "y": 260,
        "wires": [
            [
                "d58df840.89ee38"
            ]
        ]
    },
    {
        "id": "c3b5731.5c1fc9",
        "type": "http in",
        "z": "505a09c5.621328",
        "name": "",
        "url": "/api/verify",
        "method": "get",
        "swaggerDoc": "",
        "x": 120,
        "y": 600,
        "wires": [
            [
                "42191b01.3a5b14"
            ]
        ]
    },
    {
        "id": "42191b01.3a5b14",
        "type": "change",
        "z": "505a09c5.621328",
        "name": "Move to request_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "request_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 320,
        "y": 600,
        "wires": [
            [
                "e56e2da1.ba451"
            ]
        ]
    },
    {
        "id": "e56e2da1.ba451",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "2. access_token",
        "func": "var access_token = msg.request_data.access_token;\nglobal.set('access_token', access_token);\nmsg.payload = {\"access_token\": access_token};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 520,
        "y": 600,
        "wires": [
            [
                "f7ec356e.eb9568"
            ]
        ]
    },
    {
        "id": "f5bb01f3.f80ff",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "send sms code",
        "func": "var user_data = msg.user_data;\nvar code = '1234';\ncode = global.get('code');\nvar From = '12145644732';//receive user phone\nFrom = user_data.phone;\n\nmsg.topic = From;\nmsg.payload = code;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 400,
        "wires": [
            [
                "ee02f646.7c1668",
                "7cc810f0.0c08e"
            ]
        ]
    },
    {
        "id": "ee02f646.7c1668",
        "type": "debug",
        "z": "505a09c5.621328",
        "name": "Responded via Twilio",
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1020,
        "y": 440,
        "wires": []
    },
    {
        "id": "7cc810f0.0c08e",
        "type": "twilio out",
        "z": "505a09c5.621328",
        "service": "_ext_",
        "twilio": "9cf87311.0014a",
        "from": "+12317146495",
        "number": "",
        "name": "SMS verify Code",
        "x": 1030,
        "y": 400,
        "wires": []
    },
    {
        "id": "4d261a7f.12c804",
        "type": "inject",
        "z": "505a09c5.621328",
        "name": "SMS verify",
        "topic": "NoteToSelf Code",
        "payload": "1234",
        "payloadType": "num",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 620,
        "y": 400,
        "wires": [
            [
                "f5bb01f3.f80ff"
            ]
        ]
    },
    {
        "id": "b75807ef.c8af88",
        "type": "switch",
        "z": "505a09c5.621328",
        "name": "security_level",
        "property": "payload.security_level",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "1",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 420,
        "y": 400,
        "wires": [
            [
                "d00e1b1b.93e768"
            ],
            [
                "8c38552f.3e1b78"
            ]
        ]
    },
    {
        "id": "8c38552f.3e1b78",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "2. return menu page",
        "func": "var response = {\n    \"page_id\":      2,\n    \"access_token\": global.get('access_token')\n};\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 660,
        "y": 500,
        "wires": [
            [
                "3ea3a102.57f93e"
            ]
        ]
    },
    {
        "id": "3ea3a102.57f93e",
        "type": "http response",
        "z": "505a09c5.621328",
        "name": "API Result",
        "x": 970,
        "y": 500,
        "wires": []
    },
    {
        "id": "f7ec356e.eb9568",
        "type": "cloudant in",
        "z": "505a09c5.621328",
        "name": "get user by token",
        "cloudant": "76512216.4472ac",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 742,
        "y": 600,
        "wires": [
            [
                "b426c1f6.f09e8"
            ]
        ]
    },
    {
        "id": "b426c1f6.f09e8",
        "type": "change",
        "z": "505a09c5.621328",
        "name": "Move to db_user",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_user",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 202,
        "y": 680,
        "wires": [
            [
                "4924a8d8.356e18"
            ]
        ]
    },
    {
        "id": "4924a8d8.356e18",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "check verify code = 1234",
        "func": "var db_data = msg.db_user[0], request_data = msg.request_data;\nvar response = {};\n//node.warn(JSON.stringify(db_data));\n//node.warn(JSON.stringify(request_data));\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\nif(check_obj(db_data) > 0) {\n    var db_code = db_data.code;\n    db_code = \"1234\";\n    if(request_data.code == db_code){\n        response.status = \"success\";\n    }\n    else{\n        response.status = \"fail\";\n        response.msg = \"Invalid Code\";\n    }\n}\nelse{\n    response.status = \"fail\";\n    response.msg = \"Invalid Token\";\n}\n\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 482,
        "y": 680,
        "wires": [
            [
                "74d84c05.9f6ee4"
            ]
        ]
    },
    {
        "id": "b7b07cb6.8ee87",
        "type": "http response",
        "z": "505a09c5.621328",
        "name": "API Result",
        "x": 982,
        "y": 840,
        "wires": []
    },
    {
        "id": "74d84c05.9f6ee4",
        "type": "switch",
        "z": "505a09c5.621328",
        "name": "Status",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "success",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "fail",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 242,
        "y": 760,
        "wires": [
            [
                "45c09b7.5237264"
            ],
            [
                "8e411c33.cb121"
            ]
        ]
    },
    {
        "id": "f46a8552.d393f8",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "2. return menu page",
        "func": "var response = {\n    \"page_id\":  2,\n    \"user_id\":  msg.payload._id,\n    \"status\":   \"valid\"\n};\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 752,
        "y": 780,
        "wires": [
            [
                "b7b07cb6.8ee87"
            ]
        ]
    },
    {
        "id": "5740c095.59b7d",
        "type": "cloudant out",
        "z": "505a09c5.621328",
        "name": "update security level",
        "cloudant": "76512216.4472ac",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 772,
        "y": 720,
        "wires": []
    },
    {
        "id": "45c09b7.5237264",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "Merge data for update",
        "func": "var db_data = msg.db_user[0];\n//node.warn(JSON.stringify(db_data));\n\npayload = {\n    _id:            db_data._id,\n    _rev:           db_data._rev,\n    access_token:   db_data.access_token,\n    phone:          db_data.phone,\n    security_level: 1,\n    code:           db_data.code\n};\n    \nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 472,
        "y": 760,
        "wires": [
            [
                "f46a8552.d393f8",
                "5740c095.59b7d"
            ]
        ]
    },
    {
        "id": "8e411c33.cb121",
        "type": "function",
        "z": "505a09c5.621328",
        "name": "1. return login page",
        "func": "var payload = {\n    \"page_id\":  1,\n    \"status\":   \"invalid\"\n};\nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 472,
        "y": 840,
        "wires": [
            [
                "b7b07cb6.8ee87"
            ]
        ]
    },
    {
        "id": "eeb733fb.99ea5",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "payload",
        "func": "msg.req_body = msg.req.body;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 306,
        "y": 1370,
        "wires": [
            [
                "8bda7451.d16258",
                "8ae121a8.38b74"
            ]
        ]
    },
    {
        "id": "8bda7451.d16258",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "detail_payload",
        "func": "msg.payload = {_id : msg.req_body.detail.id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 494,
        "y": 1334,
        "wires": [
            [
                "b41c8ab4.6685d8"
            ]
        ]
    },
    {
        "id": "8ae121a8.38b74",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "task_payload",
        "func": "msg.payload = {_id: msg.req_body.task.id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 486,
        "y": 1386,
        "wires": [
            [
                "6fbe078c.8dd708"
            ]
        ]
    },
    {
        "id": "b41c8ab4.6685d8",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Details",
        "cloudant": "5281de41.649f",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 643,
        "y": 1334,
        "wires": [
            [
                "aedff6f3.104678"
            ]
        ]
    },
    {
        "id": "6fbe078c.8dd708",
        "type": "cloudant in",
        "z": "b36c2dc1.25c34",
        "name": "Tasks",
        "cloudant": "5281de41.649f",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 645,
        "y": 1388,
        "wires": [
            [
                "13fe9be2.8efc44"
            ]
        ]
    },
    {
        "id": "aedff6f3.104678",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "populate",
        "func": "var detail_obj = msg.payload ;\n    req_body   = msg.req_body;\n    \n    if(check_obj(detail_obj)){\n        msg.isSaved = \"need_to_save\" ;\n        msg.payload = {\n              _id: detail_obj._id,\n              _rev: detail_obj._rev,\n              task_id: detail_obj.task_id,\n              child_task_id: detail_obj.child_task_id,\n              user_id: detail_obj.user_id,\n              from_user_id: detail_obj.from_user_id,\n              page_id: detail_obj.page_id,\n              from_page_id: detail_obj.from_page_id,\n              to_page_id: detail_obj.to_page_id,\n              synchronized: detail_obj.synchronized,\n              processed: detail_obj.processed,\n              status: detail_obj.status,\n              read: detail_obj.read,\n              display_if_empty: detail_obj.display_if_empty,\n              date_created: detail_obj.date_created,\n              offline_expiration_seconds: detail_obj.offline_expiration_seconds,\n              priority: detail_obj.priority,\n              type: detail_obj.type,\n              from_user: detail_obj.from_user,\n              user_incoming: {\n                note: req_body.detail.message,\n                message: req_body.detail.message \n              },\n              watson_incoming: {\n                message: \"Watson response to : \" + req_body.detail.message,\n                response: {}\n              },\n              template: detail_obj.template,\n              timeout: detail_obj.timeout,\n              user_calculate: detail_obj.user_calculate,\n              location: detail_obj.location,\n              default: detail_obj.default,\n              createdAt: detail_obj.createdAt\n            };\n        msg.apiResult = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\n    }else{\n        msg.isSaved = \"need_to_log\";\n        msg.apiResult = {status: 400, error: true, msg: \"Unable to update data\", data: []};\n    }\nreturn msg;\n\nfunction check_obj(obj){\n    return Object.keys(obj).length;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 787,
        "y": 1334,
        "wires": [
            [
                "1462d3bd.6e0bac"
            ]
        ]
    },
    {
        "id": "1462d3bd.6e0bac",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "isSaved",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "need_to_save",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 958,
        "y": 1338,
        "wires": [
            [
                "c63b26ed.7d9658",
                "8389ab5e.dbacb8"
            ],
            [
                "481d2a96.39eb64"
            ]
        ]
    },
    {
        "id": "c63b26ed.7d9658",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "5281de41.649f",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1167,
        "y": 1318,
        "wires": []
    },
    {
        "id": "481d2a96.39eb64",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1186,
        "y": 1360,
        "wires": []
    },
    {
        "id": "13fe9be2.8efc44",
        "type": "function",
        "z": "b36c2dc1.25c34",
        "name": "populate",
        "func": "var task_obj = msg.payload ;\n    req_body   = msg.req_body;\n    \n    if(check_obj(task_obj)){\n        msg.isSaved = \"need_to_save\" ;\n        msg.payload = {\n            _id                         : task_obj._id,\n            _rev                        : task_obj._rev,\n            task_name                   : req_body.task.task_name,\n            user_id                     : task_obj.user_id,\n            page_id                     : task_obj.page_id,\n            from_page_id                : task_obj.from_page_id,\n            parent_id                   : task_obj.parent_id,\n            header_template_id          : task_obj.header_template_id,\n            detail_template_id          : task_obj.detail_template_id,\n            footer_template_id          : task_obj.footer_template_id,\n            timeout_id                  : task_obj.timeout_id,\n            child_default_task_id       : task_obj.child_default_task_id,\n            child_default_task_name     : task_obj.child_default_task_name,\n            date_created                : task_obj.date_created,\n            type                        : task_obj.type,\n            status                      : req_body.status,\n            category                    : task_obj.category,\n            additional_data_fn          : task_obj.additional_data_fn,\n            optional_data               : task_obj.optional_data,\n            required_data               : task_obj.required_data,\n            offline_expiration_time     : task_obj.offline_expiration_time,\n            display_if_empty            : task_obj.display_if_empty,\n            image                       : task_obj.image\n        };\n        msg.apiResult = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\n    }else{\n        msg.isSaved = \"need_to_log\";\n        msg.apiResult = {status: 400, error: true, msg: \"Unable to update task obj\", data: []};\n    }\nreturn msg;\n\nfunction check_obj(obj){\n    return Object.keys(obj).length;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 792,
        "y": 1390,
        "wires": [
            [
                "a44065e9.873ba8"
            ]
        ]
    },
    {
        "id": "a44065e9.873ba8",
        "type": "switch",
        "z": "b36c2dc1.25c34",
        "name": "",
        "property": "isSaved",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "need_to_save",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 955,
        "y": 1381,
        "wires": [
            [
                "b2a0d56f.c35bd8"
            ],
            [
                "481d2a96.39eb64"
            ]
        ]
    },
    {
        "id": "b2a0d56f.c35bd8",
        "type": "cloudant out",
        "z": "b36c2dc1.25c34",
        "name": "",
        "cloudant": "5281de41.649f",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1189,
        "y": 1398,
        "wires": []
    },
    {
        "id": "8389ab5e.dbacb8",
        "type": "change",
        "z": "b36c2dc1.25c34",
        "name": "res",
        "rules": [
            {
                "t": "move",
                "p": "apiResult",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1165,
        "y": 1277,
        "wires": [
            [
                "a3502143.58678"
            ]
        ]
    },
    {
        "id": "a3502143.58678",
        "type": "http response",
        "z": "b36c2dc1.25c34",
        "name": "",
        "x": 1306,
        "y": 1277,
        "wires": []
    },
    {
        "id": "d7fc86f2.a4f358",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1024,
        "y": 573,
        "wires": []
    },
    {
        "id": "ee3e58da.73d358",
        "type": "http in",
        "z": "c80a9dd2.e75c1",
        "name": "",
        "url": "/api/getpage",
        "method": "get",
        "swaggerDoc": "",
        "x": 130,
        "y": 40,
        "wires": [
            [
                "46571991.08ef08"
            ]
        ]
    },
    {
        "id": "46571991.08ef08",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "request_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "request_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 220,
        "y": 120,
        "wires": [
            [
                "fd10684c.bdb418"
            ]
        ]
    },
    {
        "id": "77cb89bd.2042b8",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "get user by token",
        "cloudant": "5e923e83.d5527",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 270,
        "y": 180,
        "wires": [
            [
                "e5da9c71.f4718"
            ]
        ]
    },
    {
        "id": "e5da9c71.f4718",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "db_user",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_user",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 269,
        "y": 244,
        "wires": [
            [
                "450b1c37.751644"
            ]
        ]
    },
    {
        "id": "450b1c37.751644",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "check access token",
        "func": "var user_data = msg.db_user[0];\nvar response = {};\n//node.warn(JSON.stringify(user_data));\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        count++;\n    }\n    return count ;\n}\n\nif(check_obj(user_data) > 0) {//if access token exist\n    var security_level = user_data.security_level;\n    if(!security_level){\n        response.status = \"verify\";\n    }\n    else{\n        response.status = \"valid\";\n    }\n}\nelse{\n    response.status = \"invalid\";\n}\n\nmsg.payload = response;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 480,
        "y": 240,
        "wires": [
            [
                "cf40c8e5.1f9dd8"
            ]
        ]
    },
    {
        "id": "cf40c8e5.1f9dd8",
        "type": "switch",
        "z": "c80a9dd2.e75c1",
        "name": "Status",
        "property": "payload.status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "invalid",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "verify",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "valid",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 3,
        "x": 690,
        "y": 240,
        "wires": [
            [
                "b6a06be7.34a818"
            ],
            [
                "1b7d6a53.4e8eb6"
            ],
            [
                "a11dba74.944348"
            ]
        ]
    },
    {
        "id": "12701435.928c3c",
        "type": "inject",
        "z": "c80a9dd2.e75c1",
        "name": "get table data",
        "topic": "table",
        "payload": "{\"id\": \"11_h\"}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 130,
        "y": 716,
        "wires": [
            [
                "7f5840e4.04827"
            ]
        ]
    },
    {
        "id": "60f7ee46.3744a",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "get data",
        "func": "msg.payload = msg.db_data;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 716,
        "wires": [
            [
                "98698b74.e93ba8",
                "7407a770.f114a8"
            ]
        ]
    },
    {
        "id": "98698b74.e93ba8",
        "type": "http response",
        "z": "c80a9dd2.e75c1",
        "name": "API Result",
        "x": 970,
        "y": 716,
        "wires": []
    },
    {
        "id": "7407a770.f114a8",
        "type": "debug",
        "z": "c80a9dd2.e75c1",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 970,
        "y": 756,
        "wires": []
    },
    {
        "id": "c006cbaa.9b3808",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "get table by id",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "getPage",
        "index": "page_id",
        "x": 500,
        "y": 716,
        "wires": [
            [
                "c4520e08.3f5f4"
            ]
        ]
    },
    {
        "id": "c4520e08.3f5f4",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "db_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "db_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 660,
        "y": 716,
        "wires": [
            [
                "60f7ee46.3744a"
            ]
        ]
    },
    {
        "id": "7f5840e4.04827",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "obj_id",
        "func": "msg.payload = {\"_id\": msg.payload.id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 290,
        "y": 716,
        "wires": [
            [
                "ce68f3c8.15a1",
                "c006cbaa.9b3808"
            ]
        ]
    },
    {
        "id": "ce68f3c8.15a1",
        "type": "debug",
        "z": "c80a9dd2.e75c1",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 490,
        "y": 756,
        "wires": []
    },
    {
        "id": "f53b112e.de6d8",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "task_id",
        "func": "//node.warn(JSON.stringify(msg.detail_data));\nvar detail_data = msg.detail_data;\nmsg.task_payload = {\"_id\": detail_data[0].task_id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 356,
        "wires": [
            [
                "2eca6439.239b7c"
            ]
        ]
    },
    {
        "id": "d0cf4057.e9198",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "search_details",
        "index": "page_id",
        "x": 1050,
        "y": 220,
        "wires": [
            [
                "59a6f508.0e870c"
            ]
        ]
    },
    {
        "id": "59a6f508.0e870c",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "detail_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 210,
        "y": 356,
        "wires": [
            [
                "f53b112e.de6d8"
            ]
        ]
    },
    {
        "id": "a11dba74.944348",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "page_id",
        "func": "msg.payload = {\n    query:\"page_id:\"+ check_number(msg.request_data.page_id),\n    sort:[\"_id<string>\"]\n};\nreturn msg;\n\n\nfunction check_number(n){\n    if(typeof n === \"string\" && n !== \"\"){\n        return parseInt(n);\n    }else{\n        return n ;\n    }\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 880,
        "y": 220,
        "wires": [
            [
                "d0cf4057.e9198"
            ]
        ]
    },
    {
        "id": "2eca6439.239b7c",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "task_payload",
        "rules": [
            {
                "t": "move",
                "p": "task_payload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 356,
        "wires": [
            [
                "e1a6364f.f45ef8"
            ]
        ]
    },
    {
        "id": "e1a6364f.f45ef8",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "search_details",
        "index": "page_id",
        "x": 810,
        "y": 356,
        "wires": [
            [
                "75f40c7e.55bd54"
            ]
        ]
    },
    {
        "id": "75f40c7e.55bd54",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "task_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "task_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 416,
        "wires": [
            [
                "ecf03812.48f8f8"
            ]
        ]
    },
    {
        "id": "ecf03812.48f8f8",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "all templates",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "getPage",
        "index": "page_id",
        "x": 610,
        "y": 416,
        "wires": [
            [
                "683c5742.39f7f8"
            ]
        ]
    },
    {
        "id": "683c5742.39f7f8",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "template_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "template_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 416,
        "wires": [
            [
                "f5e54702.9ac248"
            ]
        ]
    },
    {
        "id": "dfa70542.f2fb98",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "detailObj",
        "func": "//node.warn(JSON.stringify(msg.detail_data));\nvar detail_data = msg.detail_data;\nvar detailObj = [];\n\nfunction get_obj_data(obj1, obj2){\n\tvar obj = {};\n\tfor (var key in obj1) {\n\t\tif(obj2.hasOwnProperty(key))\n\t\t\tobj[key] = obj2[key];\n\t\telse\n\t\t    obj[key] = obj1[key];\n\t}\n\treturn obj;\n}\n//**********    detailObj     *******//\nvar detailRecord = {\n    \"_id\": \t\"\",\n    \"image\":\t\t\"\",\n    \"to_page_id\": \t\"\",\n    \"user_id\": \t\t\"\",\n    \"from_user_id\": \"\",\n\t\"user_incoming\":{},\n    \"watson_incoming\":{},\n    \"type\":         {},\n    \"date_created\": \"\",\n    \"from_user\":    {},\n    \"count\":{\"active\":0, \"unread\":0}\n};\nfor(var d=0; d<detail_data.length; d++){\n    detail_data[d]._id = detail_data[d]._id;\n    detail_data[d].to_page_id = detail_data[d].to_page_id;\n    \n    if(check_isDisplay(detail_data[d].display_if_empty)){\n        detailObj[d] = get_obj_data(detailRecord, detail_data[d]);\n    }else{\n        detail_data.splice(d, 0)    ;\n    }\n}\nmsg.detailObj = removeEmptyArrayElements(detailObj); \nreturn msg;\n\nfunction check_isDisplay(d){\n    if(d === \"true\"){\n        return true ;\n    }else if(d === true){\n        return true ;\n    }else{\n        return false ;\n    }\n}\n\nfunction removeEmptyArrayElements(arr) { \n   if (!isArray(arr)) {\n      return arr;\n   } else {\n       return arr.filter( function(elem) { \n          return elem !== null ;\n       } ).map(removeEmptyArrayElements);\n   }\n}\n\nfunction isArray(obj) {\n    return Object.prototype.toString.call(obj) === '[object Array]';\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 600,
        "y": 476,
        "wires": [
            [
                "3e01db63.255ac4"
            ]
        ]
    },
    {
        "id": "f5e54702.9ac248",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "taskObj",
        "func": "var task_data = msg.task_data;\nvar templateObj = {};\nvar header_template_id = task_data.header_template_id;\nvar detail_template_id = task_data.detail_template_id;\nvar footer_template_id = task_data.footer_template_id;\nvar template_data = msg.template_data;\n\nfor(var ind=0; ind<template_data.length; ind++){\n    if(header_template_id == template_data[ind]._id){\n        templateObj.header = template_data[ind];\n    }\n    if(detail_template_id == template_data[ind]._id){\n        templateObj.detail = template_data[ind];\n    }\n    if(footer_template_id == template_data[ind]._id){\n        templateObj.footer = template_data[ind];\n    }\n}\n\n\nvar taskObj = {\n    \"task_id\":\t\t    task_data._id,\n    \"task_name\":\t\ttask_data.task_name,\n    \"template\": \t\ttemplateObj,\n    \"from_page_id\":\t\t\"\",\n    \"date_created\":     task_data.date_created\n};\n\nmsg.taskObj = taskObj;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 460,
        "wires": [
            [
                "dfa70542.f2fb98"
            ]
        ]
    },
    {
        "id": "61f90ea0.c2877",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "search_details",
        "index": "page_id",
        "x": 650,
        "y": 860,
        "wires": [
            [
                "6d234add.a72654"
            ]
        ]
    },
    {
        "id": "3d0a0f60.d21f5",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "page_id",
        "func": "msg.payload = {\n    query:\"page_id:\"+ msg.request_data.page_id, \n    sort:[\"-_id<string>\"]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 500,
        "y": 860,
        "wires": [
            [
                "61f90ea0.c2877"
            ]
        ]
    },
    {
        "id": "6d234add.a72654",
        "type": "debug",
        "z": "c80a9dd2.e75c1",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 830,
        "y": 864,
        "wires": []
    },
    {
        "id": "2534480e.566668",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "request_data",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "request_data",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 860,
        "wires": [
            [
                "3d0a0f60.d21f5"
            ]
        ]
    },
    {
        "id": "4b4d4938.388e68",
        "type": "inject",
        "z": "c80a9dd2.e75c1",
        "name": "get page data",
        "topic": "table",
        "payload": "{\"page_id\":11}",
        "payloadType": "json",
        "repeat": "",
        "crontab": "",
        "once": false,
        "x": 132,
        "y": 859,
        "wires": [
            [
                "2534480e.566668"
            ]
        ]
    },
    {
        "id": "fd10684c.bdb418",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "access_token",
        "func": "//node.warn(msg);\nvar access_token = msg.request_data.access_token;\nif(!access_token){\n    msg.payload = {\"access_token\": null};\n}\nelse {\n    msg.payload = {\"access_token\": access_token};\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 420,
        "y": 120,
        "wires": [
            [
                "4371ecd0.91cc14"
            ]
        ]
    },
    {
        "id": "4371ecd0.91cc14",
        "type": "switch",
        "z": "c80a9dd2.e75c1",
        "name": "exist?",
        "property": "payload.access_token",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 590,
        "y": 120,
        "wires": [
            [
                "b6a06be7.34a818"
            ],
            [
                "77cb89bd.2042b8"
            ]
        ]
    },
    {
        "id": "b6a06be7.34a818",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "generate ac",
        "func": "var rand = function() {\n    return Math.random().toString(36).substr(2); // remove `0.`\n};\nvar time = function() {\n    //return new Date().getTime().toString(36);\n    return new Date().getTime();\n};\n\nvar token = function() {\n    return time()+'.'+rand(); // to make it longer\n};\n\nvar access_token = token();\nglobal.set('access_token', access_token);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 770,
        "y": 60,
        "wires": [
            [
                "2e725374.8a90fc"
            ]
        ]
    },
    {
        "id": "2e725374.8a90fc",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "page_id=1",
        "func": "msg.request_data.page_id = 1;\n\nmsg.payload = {\n    query:\"page_id:\"+ msg.request_data.page_id, \n    sort:[\"_id<string>\"]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 950,
        "y": 120,
        "wires": [
            [
                "d0cf4057.e9198"
            ]
        ]
    },
    {
        "id": "1b7d6a53.4e8eb6",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "page_id=11",
        "func": "msg.request_data.page_id = 11;\n\nmsg.payload = {\n    query:\"page_id:\"+ msg.request_data.page_id, \n    sort:[\"_id<string>\"]\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 870,
        "y": 180,
        "wires": [
            [
                "d0cf4057.e9198"
            ]
        ]
    },
    {
        "id": "3e01db63.255ac4",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "userObj",
        "func": "var db_user = msg.db_user;\n//node.warn(JSON.stringify(db_user));\nif(typeof db_user == \"undefined\" || !db_user.length) {\n    msg.userObj = {};\n}\nelse{\n    var userObj = {\n        \"user_id\":\t\t\tdb_user[0]._id,\n        \"long_url\": \t\t\"\",\n        \"access_token\":\t\t\"\",\n        \"security_level\":\t\"\",\n        \"phone\":\t\t\t\"\",\n        \"virtual_phone\":\t\"\",\n        \"email\":\t\t\t\"\",\n        \"other\":\t\t\t\"\",\n        \"conversation_id\":\t\"\",\n        \"firstname\": \t\t\"\",\n        \"lastname\": \t\t\"\",\n        \"type\": \t\t    {\"public\":\"public\"},\n        \"image\":\t\t\t\"\",\n    };\n    msg.userObj = get_obj_data(userObj, db_user[0]);\n}\nreturn msg;\n\nfunction get_obj_data(obj1, obj2){\n\tvar obj = obj1;\n\tfor (var key in obj1) {\n\t\tif(obj2.hasOwnProperty(key))\n\t\t\tobj[key] = obj2[key];\n\t}\n\treturn obj;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 500,
        "wires": [
            [
                "1710dc2c.f7b9a4"
            ]
        ]
    },
    {
        "id": "8bbeae36.9387",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "update_create_user_task",
        "func": "var user_task_arr = msg.user_task_arr ,\n    page_id = msg.request_data.page_id,\n    userObj = msg.userObj,\n    taskObj = msg.taskObj,\n    user_task = isUserTaskCreated(userObj, taskObj, user_task_arr);\n    \nif(check_obj(user_task) > 1){\n    msg.payload = update_user_task(userObj.user_id, taskObj.task_id, false, true) ;\n}else{\n    msg.payload = {\n    \ttask_id \t\t: taskObj.task_id,\n    \tuser_id\t\t\t: userObj.user_id,\n    \tpage_id         : parseInt(page_id),\n    \tupdate_read     : false,\n    \tupdate_active   : false, \n    \tsynchronized    : true,\n        status          : false, \n    \tdate_updated\t: null,\t\n    \tparent_id\t\t: null,\n    \tcount_status\t: {\n    \t   active       : true,\n    \t   unread       : false,\n    \t},\n    \tcount\t\t\t: {\n    \t    active      : 0,\n    \t    unread      : 0,\n    \t},\n    \tcount_if\t\t: {\n    \t    active      : true,\n    \t    unread      : false\n    \t},\n    \ttemplates\t\t: {},\n    \ttimeout\t\t\t: {}\n    };\n}\nreturn msg ;\n\nfunction update_user_task(user_id, task_id, status, synchronized){\n    var user_task = search_user_task_from_table(user_id, task_id);\n    user_task.synchronized          = true ;\n    user_task.date_updated          = new Date().toJSON();\n    \n    if(!user_task.update_read){\n        if( ( user_task.count_status.unread === true || user_task.count_status.unread === \"true\") && !user_task.count_if.unread ){\n            user_task.count.unread += 1 ;  \n        }\n    }\n\n    if(!user_task.update_active){\n        if( user_task.count_status.active && user_task.count_if.active){\n            user_task.count.active += 1 ;  \n        }\n    }\n\n    if(user_task.parent_id) update_user_task(user_id, user_task.parent_id, false, true);\n    \n    user_task.update_read   = true ;\n    user_task.update_active = true ;\n    return user_task;\n}\n\nfunction search_user_task_from_table(user_id, task_id){\n    var obj = {};\n    \n    for(var i=0; i< user_task_arr.length; i++){\n        if(\n            user_task_arr[i].user_id    === user_id &&\n            user_task_arr[i].task_id    === task_id\n        ){\n            obj = user_task_arr[i];\n        }\n    }\n    \n    return obj ;\n}\n\nfunction isUserTaskCreated(userObj, taskObj, user_task_arr){\n    var obj = {} ;\n    if(user_task_arr !== null && user_task_arr !== undefined){\n        for(var i=0; i < user_task_arr.length; i++){\n            if(\n                user_task_arr[i].task_id === taskObj.task_id &&\n                user_task_arr[i].user_id === userObj.user_id \n            ){\n                obj = user_task_arr[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction check_obj(obj){\n    return Object.keys(obj).length ;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 739,
        "y": 596,
        "wires": [
            [
                "ca42ebf0.f519c8",
                "4ddbbae7.ff70a4"
            ]
        ]
    },
    {
        "id": "1710dc2c.f7b9a4",
        "type": "cloudant in",
        "z": "c80a9dd2.e75c1",
        "name": "User_Task",
        "cloudant": "5e923e83.d5527",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 391,
        "y": 596,
        "wires": [
            [
                "e7cd8859.436ee8"
            ]
        ]
    },
    {
        "id": "ca42ebf0.f519c8",
        "type": "cloudant out",
        "z": "c80a9dd2.e75c1",
        "name": "Update User Task",
        "cloudant": "5e923e83.d5527",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1025,
        "y": 555,
        "wires": []
    },
    {
        "id": "e7cd8859.436ee8",
        "type": "change",
        "z": "c80a9dd2.e75c1",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "user_task_arr",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 545,
        "y": 596,
        "wires": [
            [
                "8bbeae36.9387"
            ]
        ]
    },
    {
        "id": "4ddbbae7.ff70a4",
        "type": "function",
        "z": "c80a9dd2.e75c1",
        "name": "return page",
        "func": "var page_id = msg.request_data.page_id;\nvar userObj = msg.userObj;\nvar taskObj = msg.taskObj;\nvar detailObj = msg.detailObj;\nvar apiResult = {\n        \"page_id\":  page_id,\n        \"user\":     userObj,\n        \"task\":     taskObj,\n        \"detail\":   detailObj,\n        \"user_task\": msg.payload \n\t};\nif(page_id == 1){\n\tapiResult.access_token = global.get('access_token');\n}\nmsg.payload = apiResult;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1003,
        "y": 598,
        "wires": [
            [
                "13bc99e5.59f2d6",
                "4c58270a.264b88"
            ]
        ]
    },
    {
        "id": "13bc99e5.59f2d6",
        "type": "http response",
        "z": "c80a9dd2.e75c1",
        "name": "API Result",
        "x": 1179,
        "y": 603,
        "wires": []
    },
    {
        "id": "4c58270a.264b88",
        "type": "debug",
        "z": "c80a9dd2.e75c1",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1179,
        "y": 658,
        "wires": []
    },
    {
        "id": "5716e9f7.1fd3e8",
        "type": "debug",
        "z": "b36c2dc1.25c34",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 713,
        "y": 510,
        "wires": []
    },
    {
        "id": "c9c51f27.133f",
        "type": "http in",
        "z": "f92f7e23.5ef5b",
        "name": "cerntral api endpoint",
        "url": "/api_handler",
        "method": "post",
        "swaggerDoc": "",
        "x": 104,
        "y": 207,
        "wires": [
            [
                "ffe0465e.ecbe18"
            ]
        ]
    },
    {
        "id": "ffe0465e.ecbe18",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "spliter",
        "func": "var req_body = msg.req.body;\n\nif(isEmpty(req_body)){\n    msg.API_STATUS = \"API_ERROR\";\n    msg.payload = {status:400, error:true, msg: \"Empty request body cannot be treated.\" ,data:null};\n    return msg.payload ;\n}else{\n    if(isEmpty(req_body.type)){\n        msg.API_STATUS = \"API_ERROR\";\n        msg.payload = {status:400, error:true, msg: \"Api type must be specified\" ,data:null};\n        return msg ;\n    }else{\n        msg.API_STATUS = \"API_SUCCESS\";\n        msg.req_body = req_body;\n        msg.API_TYPE = req_body.type ;\n        return msg;\n    }\n}\n\nfunction isEmpty(obj){\n    if(typeof obj === \"object\"){\n        if( Object.keys(obj).length ){\n            return false;\n        }else{\n            return true;\n        }\n    }else{\n        if( obj ){\n            return false;\n        }else{\n            return ;\n        }\n    }   \n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 113,
        "y": 293,
        "wires": [
            [
                "5dbea6f0.3f56b8"
            ]
        ]
    },
    {
        "id": "5dbea6f0.3f56b8",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_ERROR",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 270,
        "y": 293,
        "wires": [
            [
                "836bb616.a7dbe8"
            ],
            [
                "f216693e.9ea298"
            ]
        ]
    },
    {
        "id": "836bb616.a7dbe8",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 414,
        "y": 199,
        "wires": []
    },
    {
        "id": "f216693e.9ea298",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "API_TYPE",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "get_all_templates",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "get_all_tasks",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "get_all_users",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "get_all_details",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "get_task_by_id",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "delete_detail",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "update_task",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "update_user",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "update_short_detail",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "formatted_user",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "formatted_timeout",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "formatted_location",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "formatted_task",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "outputs": 13,
        "x": 420,
        "y": 435,
        "wires": [
            [
                "60a1e5bf.a8e1dc"
            ],
            [
                "94123576.ed7f58"
            ],
            [
                "9b2a3e9f.177c7"
            ],
            [
                "711d0f5f.69194"
            ],
            [
                "59b293d2.491cfc"
            ],
            [
                "d5b8dab4.ee1138"
            ],
            [
                "2b51ca5e.101f86"
            ],
            [
                "d0fdab6c.42b7d8"
            ],
            [
                "a4c67b92.f623e8"
            ],
            [
                "c22dbe6e.be3c5"
            ],
            [
                "c1e2be84.136b"
            ],
            [
                "4c296a25.9701e4"
            ],
            [
                "925a9a35.fcb608"
            ]
        ]
    },
    {
        "id": "60a1e5bf.a8e1dc",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "get_all_templates",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 687,
        "y": 23,
        "wires": [
            [
                "1055dff7.d20fb"
            ]
        ]
    },
    {
        "id": "94123576.ed7f58",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "get_all_tasks",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 667,
        "y": 68,
        "wires": [
            [
                "c1768b20.bf7808"
            ]
        ]
    },
    {
        "id": "9b2a3e9f.177c7",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "get_all_users",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 669,
        "y": 116,
        "wires": [
            [
                "e98ce4ac.1dbdc8"
            ]
        ]
    },
    {
        "id": "59b293d2.491cfc",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "get_task_by_id",
        "func": "var body = msg.req_body.body;\n\nif(isEmpty(body.task_id)){\n    msg.API_STATUS = \"API_ERROR\";\n    msg.payload    = {status: 400, error: true, msg: \"Please specify `task_id` to get task\", data: null};\n    return msg;\n}else{\n    msg.payload    = {_id : body.task_id};\n    return msg;\n}\n\n\nfunction isEmpty(obj){\n    if(typeof obj === \"object\"){\n        if( Object.keys(obj).length ){\n            return false;\n        }else{\n            return true;\n        }\n    }else{\n        if(obj){\n            return false ;\n        }else{\n            return ;\n        }\n    }   \n}",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 213,
        "wires": [
            [
                "2bf194de.5760ac"
            ]
        ]
    },
    {
        "id": "1055dff7.d20fb",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Templates",
        "cloudant": "",
        "database": "templates",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 875,
        "y": 22,
        "wires": [
            [
                "d1dfc06a.583e"
            ]
        ]
    },
    {
        "id": "c1768b20.bf7808",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 855,
        "y": 69,
        "wires": [
            [
                "1e1a3fd6.c6cdf"
            ]
        ]
    },
    {
        "id": "d1dfc06a.583e",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1040,
        "y": 20,
        "wires": []
    },
    {
        "id": "1e1a3fd6.c6cdf",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1038,
        "y": 68,
        "wires": []
    },
    {
        "id": "e98ce4ac.1dbdc8",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Users",
        "cloudant": "5281de41.649f",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 856,
        "y": 115,
        "wires": [
            [
                "1456d417.1917ac"
            ]
        ]
    },
    {
        "id": "1456d417.1917ac",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1038,
        "y": 110,
        "wires": []
    },
    {
        "id": "2bf194de.5760ac",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_ERROR",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 856,
        "y": 212,
        "wires": [
            [
                "e59d5fb2.ce5c3"
            ],
            [
                "2a779973.a50db6"
            ]
        ]
    },
    {
        "id": "2a779973.a50db6",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "task",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 1037,
        "y": 200,
        "wires": [
            [
                "4fb36bdf.38a834"
            ]
        ]
    },
    {
        "id": "4fb36bdf.38a834",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "res",
        "func": "\n\nif(msg.payload === null){\n    msg.payload = {status: 200, error: false, msg:\"No record found\", data: {}};\n    return msg;\n}else{\n    msg.payload = {status: 200, error: false, msg:\"Record fecthed successfully\", data: msg.payload};\n    return msg;    \n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1171,
        "y": 200,
        "wires": [
            [
                "f04ebdb1.8be77"
            ]
        ]
    },
    {
        "id": "e59d5fb2.ce5c3",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1038,
        "y": 238,
        "wires": []
    },
    {
        "id": "f04ebdb1.8be77",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1326,
        "y": 200,
        "wires": []
    },
    {
        "id": "711d0f5f.69194",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "get_all_details",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 680,
        "y": 166,
        "wires": [
            [
                "3a84151d.56014a"
            ]
        ]
    },
    {
        "id": "3a84151d.56014a",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Details",
        "cloudant": "5281de41.649f",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 857,
        "y": 165,
        "wires": [
            [
                "ce6b2cf3.5c2fc"
            ]
        ]
    },
    {
        "id": "ce6b2cf3.5c2fc",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1039,
        "y": 159,
        "wires": []
    },
    {
        "id": "d5b8dab4.ee1138",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "delete_detail",
        "func": "var req_body = msg.req_body.body ;\n\nif(req_body === null || req_body === undefined){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"req_body is required.\"};\n}else if(req_body._id === null || req_body._id === undefined){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"id is required to delete detail.\"};\n}else if(req_body.access_token === undefined && req_body.access_token === null && req_body.access_token === \"\"){\n    msg.status = \"API_ERROR\";\n    msg.paylod = {status: 400, error: true, type: \"Validation error\", msg: \"user_id is required to delete detail.\"};\n}else{\n    msg.status = \"API_SUCCESS\";\n    msg.payload     = {_id : req_body._id};\n    msg.detail_id   = req_body._id ;\n    msg.access_token    = {query: \"access_token:\"+req_body.access_token} ;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 671,
        "y": 305,
        "wires": [
            [
                "42895935.46c948"
            ]
        ]
    },
    {
        "id": "42895935.46c948",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "status",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "API_SUCCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 811,
        "y": 302,
        "wires": [
            [
                "7af9eb6.c404d14"
            ],
            [
                "47b557a.fc1aca8",
                "250469b1.546436"
            ]
        ]
    },
    {
        "id": "7af9eb6.c404d14",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "detail",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 954,
        "y": 295,
        "wires": [
            [
                "a3dca2ff.1a57f"
            ]
        ]
    },
    {
        "id": "47b557a.fc1aca8",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 955,
        "y": 358,
        "wires": []
    },
    {
        "id": "250469b1.546436",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1112,
        "y": 343,
        "wires": []
    },
    {
        "id": "a3dca2ff.1a57f",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1091,
        "y": 294,
        "wires": [
            [
                "ef37f53.55de108"
            ]
        ]
    },
    {
        "id": "ef37f53.55de108",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "move",
        "rules": [
            {
                "t": "move",
                "p": "access_token",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1235,
        "y": 293,
        "wires": [
            [
                "21569773.f98a88",
                "c77230df.b5a31"
            ]
        ]
    },
    {
        "id": "416c29c4.38fb08",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "Condition",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "VALID_CONTENT",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1410,
        "y": 250,
        "wires": [
            [
                "1d3dcf71.bfba71",
                "9d580bfa.f19ce8",
                "f29c64c7.b69ad8",
                "9a1afe02.92fa",
                "7659a343.825c7c"
            ],
            [
                "b1a09b3.f3e1f68"
            ]
        ]
    },
    {
        "id": "a2d026d2.c282d8",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "res",
        "func": "var detail_obj = msg.detail_obj;\n    user_obj   = msg.payload[0] ;\n\nif(detail_obj.user_id === user_obj._id){\n    msg.API_STATUS = \"VALID_CONTENT\";\n    msg.payload = {\n        _id                             : detail_obj._id,\n        _rev                            : detail_obj._rev,\n        task_id                         : detail_obj.task_id,\n        child_task_id                   : detail_obj.child_task_id,\n        user_id                         : detail_obj.user_id,\n        from_user_id                    : detail_obj.from_user_id,\n        page_id                         : detail_obj.page_id,\n        from_page_id                    : detail_obj.from_page_id,\n        to_page_id                      : detail_obj.to_page_id,\n        synchronized                    : detail_obj.synchronized,\n        processed                       : detail_obj.processed ,\n        status                          : detail_obj.status ,\n        read                            : detail_obj.read ,\n        display_if_empty                : false ,\n        date_created                    : detail_obj.date_created ,\n        offline_expiration_seconds      : detail_obj.offline_expiration_seconds ,\n        priority                        : detail_obj.priority ,\n        type                            : detail_obj.type,\n        image                           : detail_obj.image ,\n        from_user                       : detail_obj.from_user,\n        user_incoming                   : detail_obj.user_incoming,\n        watson_incoming                 : detail_obj.watson_incoming,\n        template                        : detail_obj.template ,\n        user_calculate                  : detail_obj.user_calculate,\n        location                        : detail_obj.location,\n        default                         : detail_obj.default,\n        createdAt                       : detail_obj.createdAt\n    };\n}else{\n    msg.API_STATUS = \"INVALID_CONTENT\";\n    msg.statusCode = 403 ;\n    msg.api_result = {status: 403, error: false, data: \"You are not authorized to remove record\"};    \n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1403,
        "y": 300,
        "wires": [
            [
                "416c29c4.38fb08"
            ]
        ]
    },
    {
        "id": "21569773.f98a88",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_idx_",
        "design": "getUserByToken",
        "index": "access_token",
        "x": 1401,
        "y": 347,
        "wires": [
            [
                "a2d026d2.c282d8"
            ]
        ]
    },
    {
        "id": "c77230df.b5a31",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1423,
        "y": 406,
        "wires": []
    },
    {
        "id": "9d580bfa.f19ce8",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "Change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "detail_obj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1581,
        "y": 389,
        "wires": [
            [
                "30973183.39113e"
            ]
        ]
    },
    {
        "id": "7659a343.825c7c",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "change",
        "rules": [
            {
                "t": "move",
                "p": "payload",
                "pt": "msg",
                "to": "updatedObj",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1581,
        "y": 339,
        "wires": [
            [
                "52d612a4.193b3c"
            ]
        ]
    },
    {
        "id": "b1a09b3.f3e1f68",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "api_result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1576,
        "y": 268,
        "wires": [
            [
                "e709fceb.eef9",
                "84d557da.3564e8"
            ]
        ]
    },
    {
        "id": "f29c64c7.b69ad8",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "api res",
        "func": "msg.payload = {status: 200, error: false, data: \"Record deleted successfully\"}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1569,
        "y": 222,
        "wires": [
            [
                "2bc8eebf.247832"
            ]
        ]
    },
    {
        "id": "1d3dcf71.bfba71",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "Update record",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1593,
        "y": 166,
        "wires": []
    },
    {
        "id": "9a1afe02.92fa",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1581,
        "y": 127,
        "wires": []
    },
    {
        "id": "2bc8eebf.247832",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1791,
        "y": 158,
        "wires": []
    },
    {
        "id": "84d557da.3564e8",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1824,
        "y": 210,
        "wires": []
    },
    {
        "id": "e709fceb.eef9",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1807,
        "y": 261,
        "wires": []
    },
    {
        "id": "52d612a4.193b3c",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "details",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 1720,
        "y": 338,
        "wires": [
            [
                "726feb1e.9a21d4"
            ]
        ]
    },
    {
        "id": "30973183.39113e",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 1730,
        "y": 387,
        "wires": [
            [
                "ed58352b.774948"
            ]
        ]
    },
    {
        "id": "726feb1e.9a21d4",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "init",
        "func": "var detail_arr = msg.payload ,\n    detail_obj = msg.updatedObj ;\n\nmsg.filtredArr = getDetailByToPageId(detail_arr, detail_obj);\nmsg.counter = 0;\nmsg.detail_length = msg.filtredArr.length;\nreturn msg;\n\nfunction getDetailByToPageId(arr, obj){\n    var results = [];\n    for(var i=0; i < arr.length; i++){\n        if(parseInt(arr[i].page_id) === parseInt(obj.to_page_id)){\n            results.push(arr[i]);\n        }\n    }\n    return results;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1861,
        "y": 357,
        "wires": [
            [
                "d134688d.0c9fe8"
            ]
        ]
    },
    {
        "id": "ed58352b.774948",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "init",
        "func": "var detail          = msg.detail_obj ,\n    user_task_arr   = msg.payload ;       \n\nmsg.calculated_task = get_user_task(detail, user_task_arr);\nmsg.user_task_length = msg.calculated_task.length ;\nmsg.counter = 0 ;\n\nnode.warn(msg.calculated_task);\nnode.warn(msg.calculated_task.length);\nreturn msg;\n\nfunction get_user_task(detail, user_tasks){\n    var tasks = [];\n    if(detail !== null && detail !== undefined){\n        if(user_tasks !== null && user_tasks !== undefined){\n            for(var i=0; i < user_tasks.length; i++){\n                console.log(parseInt(detail.to_page_id));\n                console.log(parseInt(user_tasks[i].page_id));\n                console.log(detail.user_id);\n                console.log(user_tasks[i].user_id);\n                \n                \n                if(\n                    parseInt(detail.to_page_id) === parseInt(user_tasks[i].page_id)  &&\n                    detail.user_id    === user_tasks[i].user_id\n                ){\n                    user_tasks[i].status = false   ;\n                    if(user_tasks[i].count){\n                        user_tasks[i].count.active = 0 ;\n                        user_tasks[i].count.unread = 0 ;\n                    }\n                    tasks.push(user_tasks[i]);  \n                }\n            }\n        }\n    }\n    return tasks ;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1870,
        "y": 439,
        "wires": [
            [
                "35bb4ce.b1c27b4"
            ]
        ]
    },
    {
        "id": "35bb4ce.b1c27b4",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "user_task_length",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2005,
        "y": 541,
        "wires": [
            [
                "e2436282.35331"
            ],
            [
                "e524c629.1a6498"
            ]
        ]
    },
    {
        "id": "a24542f7.0b405",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "counter++",
        "func": "msg.counter++ ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2083,
        "y": 473,
        "wires": [
            [
                "35bb4ce.b1c27b4"
            ]
        ]
    },
    {
        "id": "e2436282.35331",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "var user_task_obj = msg.calculated_task[msg.counter] ;\nmsg.payload = {\n  \"_id\": user_task_obj._id,\n  \"_rev\": user_task_obj._rev, \n  \"task_id\": user_task_obj.task_id,\n  \"user_id\": user_task_obj.user_id,\n  \"page_id\": user_task_obj.page_id,\n  \"synchronized\": user_task_obj.synchronized,\n  \"status\": user_task_obj.status,\n  \"date_updated\": user_task_obj.date_updated,\n  \"parent_id\": user_task_obj.parent_id,\n  \"count_status\": user_task_obj.count_status,\n  \"count\": user_task_obj.count,\n  \"count_if\": user_task_obj.count_if,\n  \"templates\": user_task_obj.templates,\n  \"timeout\": user_task_obj.timeout\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2154,
        "y": 538,
        "wires": [
            [
                "a24542f7.0b405",
                "11414ad3.1a3a45"
            ]
        ]
    },
    {
        "id": "e524c629.1a6498",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "Finish",
        "func": "msg.payload = \"User tasks updated successfully\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2146,
        "y": 578,
        "wires": [
            [
                "27883eca.3bd9c2"
            ]
        ]
    },
    {
        "id": "d134688d.0c9fe8",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "detail_length",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 2003,
        "y": 382,
        "wires": [
            [
                "b495f1f5.4c003"
            ],
            [
                "1b08a329.d0bb6d"
            ]
        ]
    },
    {
        "id": "859c29cf.0b4818",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "counter++",
        "func": "msg.counter++ ;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2081,
        "y": 303,
        "wires": [
            [
                "d134688d.0c9fe8"
            ]
        ]
    },
    {
        "id": "b495f1f5.4c003",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "msg.payload = msg.filtredArr[msg.counter];\nmsg.payload.display_if_empty = false;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2202,
        "y": 375,
        "wires": [
            [
                "859c29cf.0b4818",
                "89761101.c6376"
            ]
        ]
    },
    {
        "id": "1b08a329.d0bb6d",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "Finish",
        "func": "msg.payload = \"Update all child details as well.\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2194,
        "y": 411,
        "wires": [
            [
                "1e4f7c75.322f34"
            ]
        ]
    },
    {
        "id": "1e4f7c75.322f34",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 2348,
        "y": 411,
        "wires": []
    },
    {
        "id": "89761101.c6376",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "Update Detail",
        "cloudant": "",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 2358,
        "y": 341,
        "wires": []
    },
    {
        "id": "11414ad3.1a3a45",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "user_task",
        "cloudant": "",
        "database": "user_task",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 2340,
        "y": 484,
        "wires": []
    },
    {
        "id": "27883eca.3bd9c2",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 2350,
        "y": 580,
        "wires": []
    },
    {
        "id": "326427aa.a9d868",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1188,
        "y": 468,
        "wires": []
    },
    {
        "id": "9694d12f.52758",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "var task_obj = msg.req_body.body;\n\nmsg.payload = {\n        _id                         : task_obj._id,\n        _rev                        : task_obj._rev,\n        task_name                   : task_obj.task_name,\n        user_id                     : task_obj.user_id,\n        page_id                     : task_obj.page_id,\n        from_page_id                : task_obj.from_page_id,\n        parent_id                   : task_obj.parent_id,\n        header_template_id          : task_obj.header_template_id,\n        detail_template_id          : task_obj.detail_template_id,\n        footer_template_id          : task_obj.footer_template_id,\n        timeout_id                  : task_obj.timeout_id,\n        child_default_task_id       : task_obj.child_default_task_id,\n        child_default_task_name     : task_obj.child_default_task_name,\n        date_created                : task_obj.date_created,\n        type                        : task_obj.type,\n        status                      : task_obj.status,\n        category                    : task_obj.category,\n        additional_data_fn          : task_obj.additional_data_fn,\n        optional_data               : task_obj.optional_data,\n        required_data               : task_obj.required_data,\n        offline_expiration_time     : task_obj.offline_expiration_time,\n        display_if_empty            : task_obj.display_if_empty,\n        image                       : task_obj.image\n    };\n    \nmsg.api_result = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 837,
        "y": 430,
        "wires": [
            [
                "b5488ba0.9acff8",
                "65321c88.c1aa74"
            ]
        ]
    },
    {
        "id": "b5488ba0.9acff8",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "Update record",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1067,
        "y": 419,
        "wires": []
    },
    {
        "id": "65321c88.c1aa74",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "api result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1046,
        "y": 472,
        "wires": [
            [
                "326427aa.a9d868"
            ]
        ]
    },
    {
        "id": "1944ec9a.221e33",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "var req_body = msg.req_body.body;\n\nif(req_body.user_id !== undefined && req_body.user_id !== null && req_body.user_id !== \"\"){\n    msg.API_STATUS = \"SUCESS\" ;\n    msg.payload = {_id : req_body.user_id};    \n    msg.req_body = req_body;\n    return msg;\n}else{\n    msg.API_STATUS = \"ERROR\" ;\n    msg.api_result = {status: 400, error: true, msg: \"`user_id` is missing\", data: []};\n    return msg;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 544,
        "wires": [
            [
                "ef3c7018.a5eda"
            ]
        ]
    },
    {
        "id": "ace79893.9c7368",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1601,
        "y": 501,
        "wires": []
    },
    {
        "id": "256cf926.7ca836",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "api result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1448,
        "y": 538,
        "wires": [
            [
                "ace79893.9c7368"
            ]
        ]
    },
    {
        "id": "802ed7cc.d89488",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "var req_body = msg.req.body;\n    user_obj = msg.payload ;\n    \nmsg.payload = {\n            _id: req_body.user_id,\n            _rev: user_obj._rev,\n            virtual_phone: req_body.phone,\n            email: req_body.email,\n            first_name: req_body.f_name,\n            last_name: req_body.l_name,\n            password: req_body.phone,\n        };\n    node.warn(msg.payload);\nmsg.api_result = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1277,
        "y": 520,
        "wires": [
            [
                "256cf926.7ca836",
                "b96fbcf7.1d07f"
            ]
        ]
    },
    {
        "id": "c7407d1e.fba15",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "User",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 1134,
        "y": 521,
        "wires": [
            [
                "802ed7cc.d89488"
            ]
        ]
    },
    {
        "id": "b96fbcf7.1d07f",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1436,
        "y": 491,
        "wires": []
    },
    {
        "id": "ef3c7018.a5eda",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "split",
        "property": "API_STATUS",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "SUCESS",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 982,
        "y": 543,
        "wires": [
            [
                "c7407d1e.fba15"
            ],
            [
                "2025316c.ba62ce"
            ]
        ]
    },
    {
        "id": "c2ee108c.52629",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "payload",
        "func": "msg.req_body = msg.req_body.body;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 868,
        "y": 644,
        "wires": [
            [
                "c7f66400.f4fd48",
                "e061da39.d04d38"
            ]
        ]
    },
    {
        "id": "c7f66400.f4fd48",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "detail_payload",
        "func": "msg.payload = {_id : msg.req_body.detail.id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1053,
        "y": 647,
        "wires": [
            [
                "666be3dd.e32f2c"
            ]
        ]
    },
    {
        "id": "e061da39.d04d38",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "task_payload",
        "func": "msg.payload = {_id: msg.req_body.task.id};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1045,
        "y": 699,
        "wires": [
            [
                "19aec329.d9c15d"
            ]
        ]
    },
    {
        "id": "666be3dd.e32f2c",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Details",
        "cloudant": "5281de41.649f",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 1202,
        "y": 647,
        "wires": [
            [
                "8fdfebc8.fbc008"
            ]
        ]
    },
    {
        "id": "19aec329.d9c15d",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Tasks",
        "cloudant": "5281de41.649f",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_id_",
        "design": "",
        "index": "",
        "x": 1204,
        "y": 701,
        "wires": [
            [
                "48225967.e72a88"
            ]
        ]
    },
    {
        "id": "8fdfebc8.fbc008",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "populate",
        "func": "var detail_obj = msg.payload ;\n    req_body   = msg.req_body;\n    \n    if(check_obj(detail_obj)){\n        msg.isSaved = \"need_to_save\" ;\n        msg.payload = {\n              _id: detail_obj._id,\n              _rev: detail_obj._rev,\n              task_id: detail_obj.task_id,\n              child_task_id: detail_obj.child_task_id,\n              user_id: detail_obj.user_id,\n              from_user_id: detail_obj.from_user_id,\n              page_id: detail_obj.page_id,\n              from_page_id: detail_obj.from_page_id,\n              to_page_id: detail_obj.to_page_id,\n              synchronized: detail_obj.synchronized,\n              processed: detail_obj.processed,\n              status: detail_obj.status,\n              read: detail_obj.read,\n              display_if_empty: detail_obj.display_if_empty,\n              date_created: detail_obj.date_created,\n              offline_expiration_seconds: detail_obj.offline_expiration_seconds,\n              priority: detail_obj.priority,\n              type: detail_obj.type,\n              from_user: detail_obj.from_user,\n              user_incoming: {\n                note: req_body.detail.message,\n                message: req_body.detail.message \n              },\n              watson_incoming: {\n                message: \"Watson response to : \" + req_body.detail.message,\n                response: {}\n              },\n              template: detail_obj.template,\n              timeout: detail_obj.timeout,\n              user_calculate: detail_obj.user_calculate,\n              location: detail_obj.location,\n              default: detail_obj.default,\n              createdAt: detail_obj.createdAt\n            };\n        msg.apiResult = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\n    }else{\n        msg.isSaved = \"need_to_log\";\n        msg.apiResult = {status: 400, error: true, msg: \"Unable to update data\", data: []};\n    }\nreturn msg;\n\nfunction check_obj(obj){\n    return Object.keys(obj).length;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1346,
        "y": 647,
        "wires": [
            [
                "ee0ba115.742f5"
            ]
        ]
    },
    {
        "id": "ee0ba115.742f5",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "isSaved",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "need_to_save",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1517,
        "y": 651,
        "wires": [
            [
                "d2a60912.6699d8",
                "5dd39800.2e5158"
            ],
            [
                "aac86e92.d8096"
            ]
        ]
    },
    {
        "id": "d2a60912.6699d8",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "5281de41.649f",
        "database": "details",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1726,
        "y": 631,
        "wires": []
    },
    {
        "id": "aac86e92.d8096",
        "type": "debug",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "active": true,
        "console": "false",
        "complete": "false",
        "x": 1745,
        "y": 673,
        "wires": []
    },
    {
        "id": "48225967.e72a88",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "populate",
        "func": "var task_obj = msg.payload ;\n    req_body   = msg.req_body;\n    \n    if(check_obj(task_obj)){\n        msg.isSaved = \"need_to_save\" ;\n        msg.payload = {\n            _id                         : task_obj._id,\n            _rev                        : task_obj._rev,\n            task_name                   : req_body.task.task_name,\n            user_id                     : task_obj.user_id,\n            page_id                     : task_obj.page_id,\n            from_page_id                : task_obj.from_page_id,\n            parent_id                   : task_obj.parent_id,\n            header_template_id          : task_obj.header_template_id,\n            detail_template_id          : task_obj.detail_template_id,\n            footer_template_id          : task_obj.footer_template_id,\n            timeout_id                  : task_obj.timeout_id,\n            child_default_task_id       : task_obj.child_default_task_id,\n            child_default_task_name     : task_obj.child_default_task_name,\n            date_created                : task_obj.date_created,\n            type                        : task_obj.type,\n            status                      : req_body.status,\n            category                    : task_obj.category,\n            additional_data_fn          : task_obj.additional_data_fn,\n            optional_data               : task_obj.optional_data,\n            required_data               : task_obj.required_data,\n            offline_expiration_time     : task_obj.offline_expiration_time,\n            display_if_empty            : task_obj.display_if_empty,\n            image                       : task_obj.image\n        };\n        msg.apiResult = {status: 200, error: false, msg: \"Record udpated successfully\", data: msg.payload};\n    }else{\n        msg.isSaved = \"need_to_log\";\n        msg.apiResult = {status: 400, error: true, msg: \"Unable to update task obj\", data: []};\n    }\nreturn msg;\n\nfunction check_obj(obj){\n    return Object.keys(obj).length;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1351,
        "y": 703,
        "wires": [
            [
                "c8be7aac.4a99a8"
            ]
        ]
    },
    {
        "id": "c8be7aac.4a99a8",
        "type": "switch",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "property": "isSaved",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "need_to_save",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "outputs": 2,
        "x": 1514,
        "y": 694,
        "wires": [
            [
                "23d8bed6.749602"
            ],
            [
                "aac86e92.d8096"
            ]
        ]
    },
    {
        "id": "23d8bed6.749602",
        "type": "cloudant out",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "5281de41.649f",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "payonly": true,
        "operation": "insert",
        "x": 1748,
        "y": 711,
        "wires": []
    },
    {
        "id": "5dd39800.2e5158",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "res",
        "rules": [
            {
                "t": "move",
                "p": "apiResult",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1724,
        "y": 590,
        "wires": [
            [
                "884a48e1.7b2b48"
            ]
        ]
    },
    {
        "id": "884a48e1.7b2b48",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1865,
        "y": 590,
        "wires": []
    },
    {
        "id": "2b51ca5e.101f86",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "update_task",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 671,
        "y": 431,
        "wires": [
            [
                "9694d12f.52758"
            ]
        ]
    },
    {
        "id": "d0fdab6c.42b7d8",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "update_user",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 673,
        "y": 545,
        "wires": [
            [
                "1944ec9a.221e33"
            ]
        ]
    },
    {
        "id": "a4c67b92.f623e8",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "update_short_detail",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 693,
        "y": 644,
        "wires": [
            [
                "c2ee108c.52629"
            ]
        ]
    },
    {
        "id": "2025316c.ba62ce",
        "type": "change",
        "z": "f92f7e23.5ef5b",
        "name": "api result",
        "rules": [
            {
                "t": "move",
                "p": "api_result",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1145,
        "y": 572,
        "wires": [
            [
                "ef3e62f3.cf1d4"
            ]
        ]
    },
    {
        "id": "ef3e62f3.cf1d4",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1273,
        "y": 571,
        "wires": []
    },
    {
        "id": "cd24fff7.8d256",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "cloudant": "",
        "database": "task_table",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 899,
        "y": 920,
        "wires": [
            [
                "ad57da4b.9d5328"
            ]
        ]
    },
    {
        "id": "ad57da4b.9d5328",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "response",
        "func": "var tasks_arr = msg.payload , obj = {} ;\n\nif(tasks_arr === null || tasks_arr === undefined){\n    obj.status = 400 ;\n    obj.error  = true ;\n    obj.msg    = \"Unable to get the tasks\";\n    msg.paylod = obj ;\n}else{\n    if(tasks_arr.length){\n        var tasks = [];\n        for(var i=0; i < tasks_arr.length; i++){\n            tasks.push({\n                id           : tasks_arr[i]._id,\n                task_name    : tasks_arr[i].task_name || \"N/A\"     \n            });\n        }\n        obj.status = 200 ;\n        obj.error  = false ;\n        obj.msg    = \"Record fecthed successfully\";\n        obj.data   = tasks ;\n        msg.payload = obj ;\n    }else{\n        obj.status = 200 ;\n        obj.error  = false ;\n        obj.msg    = \"There is not task present\";\n        msg.paylod = obj ;\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1095,
        "y": 920,
        "wires": [
            [
                "edfc12a7.60cc9"
            ]
        ]
    },
    {
        "id": "edfc12a7.60cc9",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1277,
        "y": 918,
        "wires": []
    },
    {
        "id": "7dff7314.52f13c",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "users",
        "cloudant": "",
        "database": "users",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 874,
        "y": 771,
        "wires": [
            [
                "d08dd552.17b7c8"
            ]
        ]
    },
    {
        "id": "d08dd552.17b7c8",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "response",
        "func": "var users   = msg.payload , updated_user = [];\n\nif(users === null || users === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!users.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: users};\n}else{\n    for(var i=0; i< users.length; i++){\n        updated_user.push({id : users[i]._id, name: users[i].first_name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_user};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1093,
        "y": 770,
        "wires": [
            [
                "6df4d166.3b3a8"
            ]
        ]
    },
    {
        "id": "6df4d166.3b3a8",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1274,
        "y": 768,
        "wires": []
    },
    {
        "id": "117ffdc1.99e1a2",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Timeout",
        "cloudant": "",
        "database": "timeout",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 887,
        "y": 826,
        "wires": [
            [
                "e2e1bce8.51af2"
            ]
        ]
    },
    {
        "id": "e2e1bce8.51af2",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "response",
        "func": "var timeout   = msg.payload , updated_timeout = [];\n\nif(timeout === null || timeout === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!timeout.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: timeout};\n}else{\n    for(var i=0; i< timeout.length; i++){\n        updated_timeout.push({id : timeout[i]._id, name: timeout[i].name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_timeout};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1093,
        "y": 823,
        "wires": [
            [
                "67103d4c.0cb244"
            ]
        ]
    },
    {
        "id": "67103d4c.0cb244",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1273,
        "y": 821,
        "wires": []
    },
    {
        "id": "bcff8182.2d0bd",
        "type": "cloudant in",
        "z": "f92f7e23.5ef5b",
        "name": "Location",
        "cloudant": "",
        "database": "location",
        "service": "PkTwilioConv-cloudantNoSQLDB",
        "search": "_all_",
        "design": "",
        "index": "",
        "x": 889,
        "y": 872,
        "wires": [
            [
                "1d35d988.9ab836"
            ]
        ]
    },
    {
        "id": "1d35d988.9ab836",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "response",
        "func": "var location   = msg.payload , updated_location = [];\n\nif(location === null || location === undefined){\n    msg.payload = {status: 400, error: true, msg: \"Validation error\", data: []};\n}else if(!location.length){\n    msg.payload = {status: 200, error: false, msg: \"No record found\", data: location};\n}else{\n    for(var i=0; i< location.length; i++){\n        updated_location.push({id : location[i]._id, name: location[i].location_name || 'N/A'});\n    }\n    msg.payload = {status: 200, error: false, msg: \"Record fetched successfully\", data: updated_location};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1090,
        "y": 870,
        "wires": [
            [
                "7819182d.b1e918"
            ]
        ]
    },
    {
        "id": "7819182d.b1e918",
        "type": "http response",
        "z": "f92f7e23.5ef5b",
        "name": "",
        "x": 1273,
        "y": 871,
        "wires": []
    },
    {
        "id": "c22dbe6e.be3c5",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "formatted_user",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 686,
        "y": 765,
        "wires": [
            [
                "7dff7314.52f13c"
            ]
        ]
    },
    {
        "id": "c1e2be84.136b",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "formatted_timeout",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 693,
        "y": 820,
        "wires": [
            [
                "117ffdc1.99e1a2"
            ]
        ]
    },
    {
        "id": "4c296a25.9701e4",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "formatted_location",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 693,
        "y": 873,
        "wires": [
            [
                "bcff8182.2d0bd"
            ]
        ]
    },
    {
        "id": "925a9a35.fcb608",
        "type": "function",
        "z": "f92f7e23.5ef5b",
        "name": "formatted_task",
        "func": "\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 682,
        "y": 923,
        "wires": [
            [
                "cd24fff7.8d256"
            ]
        ]
    }
]
