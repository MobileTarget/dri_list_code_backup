[{"id":"13884b4a.5dde85","type":"tab","label":"Details without auth"},{"id":"d281277d.6b8258","type":"function","z":"13884b4a.5dde85","name":"setup","func":"msg.task_payload = {query : \"task_name:\" + msg.payload.task_name } ;\nmsg.form_data = msg.payload ;\nreturn msg;\n","outputs":1,"noerr":0,"x":223,"y":67,"wires":[["5d0ef5e7.a91bbc"]]},{"id":"775b14bc.40363c","type":"function","z":"13884b4a.5dde85","name":"merge","func":"var form_data           = msg.form_data, \n    big_watson_object   = msg.big_record_watson,\n    big_watson_override = {} ,\n    timeout_arr         = msg.timeout_arr,\n    location_arr        = msg.location_arr,\n    template_arr        = msg.templates_arr,\n    users_arr           = msg.user_arr,\n    task_arr            = msg.task_arr,\n    details_arr         = msg.details_obj;\n    \n    if(check_obj(big_watson_object) > 0){\n        if(big_watson_object.child_default_name !== null){\n            msg.default_child_task_name = big_watson_object.task.child_default_task_name ;\n            big_watson_override = update_big_watson(form_data, big_watson_object, task_arr);\n            msg.payload = create_details_obj(form_data, big_watson_override.task);    \n            return msg;    \n        }else{\n            big_watson_override = update_big_watson(form_data, big_watson_object, task_arr);\n            msg.payload = create_details_obj(form_data, big_watson_override.task);    \n            return msg;    \n        }\n    }else{\n        msg.payload = {err: true, message: \"There is no big_record_tables added with task_name.\"};\n    }\n    \nreturn msg;\n\nfunction update_big_watson(form_data, big_watson, task_table){\n    big_watson.task.detail.user_id                  = form_data.user_id || null;\n    big_watson.task.detail.from_user_id             = get_from_user_id(form_data, big_watson) ;\n    big_watson.task.detail.user_incoming.message    = form_data.note || null ;\n    big_watson.task.task_name                       = form_data.task_name || null ;\n    big_watson.task.detail.page_id                  = big_watson.page_id || generate_page_id(6) ;\n    big_watson.task.task_id                         = get_task_by_name(form_data.task_name, task_table)._id ;\n    \n    return big_watson ;\n}\n\nfunction create_details_obj(form, big_watson_obj){\n\n    var big_record_table = {} , \n        details = {},\n        task_obj = get_obj(big_watson_obj.task_id, task_arr);\n        temp_detail = check_obj(get_detail_obj(big_watson_obj.task_id, details_arr)) > 0 ? get_detail_obj(big_watson_obj.task_id, details_arr) : big_watson_obj.detail;\n\n    //create big_record_table object populating big_watson_obj\n    big_record_table.task                           = task_obj;\n    big_record_table.detail                         = temp_detail;\n    big_record_table.detail.timeout                 = create_timeout_list_obj( get_obj_from_array(task_obj.timeout_id, timeout_arr), template_arr, users_arr, \"timeout\" );\n    big_record_table.detail.location                = task_obj.location_id ;\n    big_record_table.detail.child_defaults_task     = task_obj.task_name || task_obj._id ;\n    big_record_table.detail.from_user               = get_from_user(temp_detail.from_user_id, users_arr);\n    \n    //create details object which is further going to save and return in api response .\n    details.page_id         = temp_detail.page_id ;\n    details.user            = get_obj(form.user_id, users_arr);\n    details.task            = big_record_table.task;\n    details.task.template   = big_watson_obj.template;\n    details.detail          = big_record_table.detail ;\n    details.defaults        = {\n        parent              : null,\n        allchildren         : null\n    };\n    details.count           = {\n        active              : 0,\n        unread              : 0,\n        date                : new Date().toJSON()\n    };\n    \n    return details ;\n}\n\nfunction create_timeout_list_obj(timeout_obj, templates, users, type){\n    switch(type){\n        case \"timeout\" : {\n            if(check_obj(timeout_obj.timeout_list) > 1){\n                for(var list in timeout_obj.timeout_list){\n                    if(timeout_obj.timeout_list[list] && list !== \"0\"){\n                        timeout_obj.timeout_list[list].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                        timeout_obj.timeout_list[list].message = timeout_obj.timeout_list[list].message_id ? get_template(timeout_obj.timeout_list[list].message_id, templates) : null;\n                        timeout_obj.timeout_list[list].from = timeout_obj.timeout_list[list].from_id ? get_template(timeout_obj.timeout_list[list].from_id, templates) : null;\n                    }\n                }\n                return timeout_obj ;   \n            }else{\n                return {} ;\n            }\n            break;\n        }\n        \n        case \"user_calculated\" : {\n            if(timeout_obj.timeout_list){\n                for(var key in timeout_obj.timeout_list){\n                    if(key == \"0\"){\n                        timeout_obj.timeout_list[key].delivery_user_ids = get_obj_from_array(timeout_obj.timeout_list[key].delivery_user_ids, users);\n                        timeout_obj.timeout_list[key].template = {\n                            message : timeout_obj.timeout_list[key].message_id ? get_template(timeout_obj.timeout_list[key].message_id, templates) : null ,\n                            from    : timeout_obj.timeout_list[key].from_id ? get_template(timeout_obj.timeout_list[key].from_id, templates) : null\n                        };\n                    }\n                }\n                return timeout_obj.timeout_list[\"0\"] ; \n            }else{\n                return {} ; \n            }\n            break;\n        }\n        \n        default: {\n            return {};\n        }\n    }\n}\n\nfunction get_obj(id, arr){\n    var obj = {};\n    if(id !==null && arr !== null){\n        for(var i=0; i<arr.length; i++){\n            if(id === arr[i]._id){\n                obj = arr[i];\n            }\n        }\n    }else{\n        return obj;\n    }\n    \n    return obj ;\n}\n\nfunction get_location_obj(ids, locations){\n    var obj = {};\n    \n    if(ids){\n        ids = ids.split(',');\n    }\n    \n    if(locations !== null){\n        for(var i=0; i< locations.length; i++){\n            if(ids.indexOf(sanitize(locations[i]._id)) > 0){\n                obj[locations[i]._id] = locations[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_template(id, template){\n    var obj = {} ;\n    if(template !== null){\n        for(var i=0; i< template.length; i++){\n            if(sanitize(id) === sanitize(template[i]._id)){\n                obj = template[i] ;\n            }\n        }    \n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_obj_from_array(id, arr){\n    var obj = {} ;\n    if(arr !== null && arr.length){\n        for(var i=0; i< arr.length; i++){\n            if(sanitize(arr[i]._id) === sanitize(id)){\n                obj[arr[i]._id] = arr[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction get_task_by_name(name, arr){\n    var data = {} ;\n    \n    if(name !== null){\n        if(arr !== null && arr.length){\n            for(var i=0; i< arr.length; i++){\n                if(sanitize(arr[i].task_name) === sanitize(name)){\n                    data = arr[i] ;\n                }\n            }\n            return data ;\n        }else{\n            return data ;\n        }\n    }else{\n        return data ;\n    }\n}\n\nfunction get_detail_obj(page_id, details){\n    var detail_obj = {} ;\n    \n    if(page_id !== null && details !== null){\n        if(details.length){\n            for(var i=0; i, details.length ; i++){\n                if(page_id === details[i].page_id){\n                    detail_obj = details[i] ;\n                }\n            }\n        }else{\n            return detail_obj;\n        }\n    }else{\n        return detail_obj;\n    }\n    \n    return detail_obj;\n}\n\nfunction get_from_user(id, user_arr){\n    var obj = {};\n    if(id !== null && user_arr !== null){\n        for(var i=0; i<user_arr.length; i++){\n            if(id === user_arr[i]._id){\n                delete user_arr[i].access_token ;\n                delete user_arr[i].security_level;\n                delete user_arr[i].converstation_id ;\n                delete user_arr[i].password ;\n                delete user_arr[i].code ;\n                obj[user_arr[i]._id] = user_arr[i];\n            }\n        }\n    }else{\n        return obj ;\n    }\n    \n    return obj;\n}\n\n\nfunction get_from_user_id(form, big_watson){\n    var from_user_id = null ;\n    if(form.from_user_id){\n        from_user_id = form.from_user_id ;\n    }else if(big_watson.from_user_id){\n        from_user_id = big_watson.from_user_id ;\n    }else {\n        from_user_id = form.user_id ;\n    }\n    \n    return from_user_id ;\n}\n\nfunction sanitize(data){\n    if(data && typeof data === \"string\"){\n        return data.trim().toString();\n    }\n}\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        if(obj[keys]){\n            count++ ;\n        }\n    }\n    return count ;\n}\n\nfunction generate_page_id(length) {\n    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));\n}\n","outputs":1,"noerr":0,"x":547,"y":438,"wires":[["2bc5f489.7045cc","476ce57e.ae4aec","a8f462aa.a129a","e573432b.bacb3"]]},{"id":"5d0ef5e7.a91bbc","type":"change","z":"13884b4a.5dde85","name":"big_record","rules":[{"t":"move","p":"task_payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":373,"y":67,"wires":[["6571a0f8.c3654"]]},{"id":"6571a0f8.c3654","type":"cloudant in","z":"13884b4a.5dde85","name":"templates","cloudant":"","database":"templates","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":535,"y":68,"wires":[["8776449.806d0b8"]]},{"id":"8776449.806d0b8","type":"change","z":"13884b4a.5dde85","name":"temp obj","rules":[{"t":"move","p":"payload","pt":"msg","to":"templates_arr","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":686,"y":67,"wires":[["f3aaa1ce.664a5"]]},{"id":"3e0141d8.e12ade","type":"cloudant in","z":"13884b4a.5dde85","name":"user","cloudant":"","database":"users","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":145,"y":216,"wires":[["fa7db015.727b2"]]},{"id":"fa7db015.727b2","type":"change","z":"13884b4a.5dde85","name":"user obj","rules":[{"t":"move","p":"payload","pt":"msg","to":"user_arr","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":318,"y":205,"wires":[["ee9bebbc.5071b8"]]},{"id":"ee9bebbc.5071b8","type":"cloudant in","z":"13884b4a.5dde85","name":"task","cloudant":"","database":"task_table","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":481,"y":165,"wires":[["7286932.b64e56c"]]},{"id":"7286932.b64e56c","type":"change","z":"13884b4a.5dde85","name":"task_obj","rules":[{"t":"move","p":"payload","pt":"msg","to":"task_arr","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":656,"y":161,"wires":[["23f80327.1626bc"]]},{"id":"be17bf1e.fd12c","type":"function","z":"13884b4a.5dde85","name":"input","func":"msg.payload  = msg.form_data.note || \"the lean statup\";\nmsg.params = {\n    workspace_id : \"42015e53-bdb9-4a23-87b5-f382d5e12dbb\",\n    username     : \"4db58c57-6d89-4382-9d34-c4044b5fce11\",\n    password     : \"eG0ctZRJO42s\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":121,"y":375,"wires":[["588003e3.8cde1c"]]},{"id":"588003e3.8cde1c","type":"watson-conversation-v1","z":"13884b4a.5dde85","name":"Watson","workspaceid":"42015e53-bdb9-4a23-87b5-f382d5e12dbb","multiuser":false,"context":true,"x":312,"y":367,"wires":[["e2b0b806.034d38"]]},{"id":"e2b0b806.034d38","type":"change","z":"13884b4a.5dde85","name":"watson output","rules":[{"t":"move","p":"payload","pt":"msg","to":"watson_output","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":498,"y":350,"wires":[["9499cf7d.153d8"]]},{"id":"58a2a626.cffed8","type":"function","z":"13884b4a.5dde85","name":"create_optional_task","func":"msg.optional_task = create_optonal_task(msg.payload, msg.task_arr, msg.default_child_task_name);\nreturn msg ;\n\n\nfunction get_last_entry(details){\n    return details[details.length - 1];\n}\n\nfunction create_optonal_task(details, task_obj, child_default_task_name){\n    var default_task = get_task_by_name(task_obj, child_default_task_name);\n        current_task = get_current_task(task_obj, details.task_id) ;\n        task_obj = {} ;\n\n    if(check_obj(default_task) > 0){\n        task_obj = {\n            task_name:                  child_default_task_name + \"_\" + new Date().getTime(), \n            user_id:                    default_task.user_id || null,\n            header_template_id:         default_task.header_template_id || current_task.header_template_id,\n            details_template_id:        default_task.details_template_id || current_task.details_template_id,\n            footer_template_id:         default_task.footer_template_id || current_task.footer_template_id,\n            timeout_id:                 default_task.timeout_id || current_task.timeout_id,\n            location_id:                default_task.location_id || current_task.location_id,\n            child_default_task_id:      null,\n            child_default_task_name :   null,\n            date_created:               new Date().toJSON(),\n            type:                       default_task.type || current_task.type,\n            status:                     default_task.status || current_task.status,\n            category:                   default_task.category || current_task.category,\n            additional_data_fn:         default_task.additional_data_fn || current_task.additional_data_fn,\n            optional_data:              default_task.optional_data || current_task.optional_data,\n            required_data:              default_task.required_data || current_task.required_data,\n            offline_expiration_time:    default_task.offline_expiration_time || current_task.offline_expiration_time,\n            display_if_empty:           default_task.display_if_empty || current_task.display_if_empty \n        };\n    }else{\n        task_obj = {\n            task_name:                  child_default_task_name + \"_\" + new Date().getTime(), \n            user_id:                    current_task.user_id || null,\n            header_template_id:         current_task.header_template_id || null,\n            details_template_id:        current_task.details_template_id || null,\n            footer_template_id:         current_task.footer_template_id || null,\n            timeout_id:                 current_task.timeout_id || null,\n            location_id:                current_task.location_id || null,\n            child_default_task_id:      null,\n            child_default_task_name:    null,\n            date_created:               new Date().toJSON(),\n            type:                       current_task.type || null,\n            status:                     current_task.status || \"active\",\n            category:                   current_task.category || null,\n            additional_data_fn:         current_task.additional_data_fn || null,\n            optional_data:              current_task.optional_data || {},\n            required_data:              current_task.required_data || {},\n            offline_expiration_time:    current_task.offline_expiration_time || 0,\n            display_if_empty:           current_task.display_if_empty || true \n        };\n    }\n    return task_obj;\n}\n\nfunction get_task_by_name(arr, name){\n    var obj = {} ;\n    for(var i=0; i<arr.length; i++){\n        if(arr[i].task_name === name){\n            obj = arr[i]    ;\n        }\n    }\n    return obj ;\n}\n\nfunction get_current_task(arr, task_id){\n    var obj = {} ;\n    for(var i=0; i<arr.length; i++){\n        if(arr[i]._id === task_id){\n            obj = arr[i]    ;\n        }\n    }\n    return obj ;\n}\n\nfunction check_obj(obj){\n    var count = 0; \n    for(var keys in obj){\n        if(obj[keys]){\n            count++ ;\n        }\n    }\n    return count ;\n}\n","outputs":1,"noerr":0,"x":555,"y":496,"wires":[["fc0377eb.eec6d8"]]},{"id":"a8f462aa.a129a","type":"cloudant out","z":"13884b4a.5dde85","name":"","cloudant":"","database":"details","service":"PkTwilioConv-cloudantNoSQLDB","payonly":true,"operation":"insert","x":771,"y":388,"wires":[]},{"id":"476ce57e.ae4aec","type":"http response","z":"13884b4a.5dde85","name":"Result","x":770,"y":431,"wires":[]},{"id":"8e9f5257.3b9e4","type":"http in","z":"13884b4a.5dde85","name":"Detail","url":"/add_detail","method":"post","swaggerDoc":"","x":64,"y":22,"wires":[["d281277d.6b8258"]]},{"id":"fea6d8da.fa3578","type":"inject","z":"13884b4a.5dde85","name":"Start","topic":"Start","payload":"{  \t\"user_id\": \"5f490c0ae2ee7321dc891a3e59bd64c6\",  \t\"task_name\": \"task_w_create_task\",  \t\"from_user_id\": \"23d5c58422026c68269cd6e9ac22ca4a\" , \"note\": \"the lean startup\" }","payloadType":"json","repeat":"","crontab":"","once":false,"x":84,"y":91,"wires":[["d281277d.6b8258"]]},{"id":"2bc5f489.7045cc","type":"debug","z":"13884b4a.5dde85","name":"","active":true,"console":"false","complete":"false","x":789,"y":467,"wires":[]},{"id":"39e4eae6.384e36","type":"cloudant out","z":"13884b4a.5dde85","name":"","cloudant":"","database":"task_table","service":"PkTwilioConv-cloudantNoSQLDB","payonly":true,"operation":"insert","x":796,"y":539,"wires":[]},{"id":"e573432b.bacb3","type":"delay","z":"13884b4a.5dde85","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":371,"y":515,"wires":[["58a2a626.cffed8"]]},{"id":"fc0377eb.eec6d8","type":"change","z":"13884b4a.5dde85","name":"optional_task","rules":[{"t":"move","p":"optional_task","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":617,"y":539,"wires":[["f954a87d.174628","39e4eae6.384e36"]]},{"id":"f954a87d.174628","type":"debug","z":"13884b4a.5dde85","name":"Optional Task","active":true,"console":"false","complete":"payload","x":805,"y":584,"wires":[]},{"id":"47ab3c46.203cd4","type":"cloudant in","z":"13884b4a.5dde85","name":"timeout","cloudant":"","database":"timeout","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":311,"y":281,"wires":[["ebac711c.a447f"]]},{"id":"ebac711c.a447f","type":"change","z":"13884b4a.5dde85","name":"timeout","rules":[{"t":"move","p":"payload","pt":"msg","to":"timeout_arr","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":482,"y":248,"wires":[["65d0a3e9.71a63c"]]},{"id":"23f80327.1626bc","type":"cloudant in","z":"13884b4a.5dde85","name":"locations","cloudant":"","database":"location","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":806,"y":159,"wires":[["8bb10e9.0a5abf"]]},{"id":"8bb10e9.0a5abf","type":"change","z":"13884b4a.5dde85","name":"loc_arr","rules":[{"t":"move","p":"payload","pt":"msg","to":"location_arr","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":138,"y":295,"wires":[["47ab3c46.203cd4"]]},{"id":"65d0a3e9.71a63c","type":"cloudant in","z":"13884b4a.5dde85","name":"Details","cloudant":"","database":"details","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":648,"y":246,"wires":[["2687b3fd.c92eec"]]},{"id":"2687b3fd.c92eec","type":"change","z":"13884b4a.5dde85","name":"details","rules":[{"t":"move","p":"payload","pt":"msg","to":"details_obj","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":793,"y":228,"wires":[["be17bf1e.fd12c"]]},{"id":"ccb4fcb6.f9a24","type":"function","z":"13884b4a.5dde85","name":"big_record_watson","func":"var form_data       = msg.form_data ,\n    user_obj        = get_obj(form_data.user_id, msg.user_arr),\n    templates       = msg.templates_arr,\n    timeout         = msg.timeout_arr,\n    locations       = msg.location_arr ,\n    task_arr        = msg.task_arr ,\n    watson_output   = msg.watson_output,\n    big_record      = {},\n    task_by_name_obj= msg.task_by_name;\n    page_id         = generate_page_id(6);\n    \n \n//from the below code is working for the create record case.\nbig_record.task_name        = form_data.task_name;\nbig_record.page_id          = page_id ;\nbig_record.user_id          = user_obj._id;\nbig_record.phone            = user_obj.virtual_phone;\nbig_record.access_token     = user_obj.access_token;\nbig_record.note             = form_data.note || \"the lean startup\" ;\nbig_record.task             = create_task_obj(form_data, msg.user_arr, templates, locations, task_arr, timeout, watson_output);\n\nmsg.big_record_watson = big_record ;\nreturn msg;\n\nfunction create_task_obj(form, users_arr, templates, locations, task_arr, timeout, watson_output){\n    var task_obj = get_task_from_arr(task_by_name_obj);\n    \n    var task ={\n        task_id                     : task_obj._id ,\n        user_id                     : task_obj.user_id ,\n        task_name                   : task_obj.name ,\n        header_template_id          : get_obj(task_obj.header_template_id, templates) ,\n        detail_template_id          : get_obj(task_obj.details_template_id, templates) ,\n        footer_template_id          : get_obj(task_obj.footer_template_id, templates) ,\n        timeout_id                  : task_obj.timeout_id ,\n        location_ids                : task_obj.location_ids ? get_all_loc_obj(task_obj.location_ids) : null,\n        child_defaults_task_id      : task_obj.child_default_task_id || null ,\n        child_default_task_name     : task_obj.child_default_task_name || null, \n        date_created                : task_obj.date_created || new Date().toJSON() ,\n        category                    : task_obj.category || null ,\n        status                      : task_obj.status || null ,\n        additional_data_fn          : task_obj.additional_data_fn || null,\n        optional_data               : task_obj.optional_data || {},\n        required_data               : task_obj.required_data || {} ,\n        offline_expiration_seconds  : task_obj.offline_expiration_time || 0,\n        display_if_empty            : task_obj.display_if_empty || true ,\n        type                        : {\n            public                  : task_obj.type || \"public\"\n        },\n        image                       : task_obj.image || form.image || \"https://upload.wikimedia.org/wikipedia/commons/2/26/512pxIcon-sunset_photo_not_found.png\" ,\n        child_defaults_task         : form.child_defaults_task || null ,\n        template                    : {\n            header                  : get_obj(task_obj.header_template_id, templates),\n            detail                  : get_obj(task_obj.details_template_id, templates),\n            footer                  : get_obj(task_obj.footer_template_id, templates)\n        } ,\n        detail                      : create_detail_obj(form, users_arr, templates, locations, task_obj, timeout, watson_output)\n    } ;\n    \n    return task ;\n}\n\nfunction create_detail_obj(form, users, templates, locations, task_obj, timeout, watson_output){\n    var detail = {\n        task_id                     : task_obj._id,\n        child_task_id               : task_obj.child_default_task_id,\n        user_id                     : get_obj(form.user_id, users), \n        from_user_id                : get_obj(form.from_user_id, users),\n        page_id                     : page_id,\n        synchronized                : true,\n        processed                   : true,\n        status                      : \"active\",\n        read                        : true,\n        display_if_empty            : true,\n        date_created                : new Date().toJSON(),\n        due_date                    : new Date().toJSON(),\n        offline_expiration_seconds  : 0,\n        priority                    : 1,\n        user_incoming               : {\n            note                    : form.note || \"the lean startup\"\n        },\n        watson_incoming             : {\n            message                 : \"watson_response_to: \" + form.note ,\n            output                  : watson_output.output\n        },\n        timeout                     : create_timeout_obj(timeout, users),\n        location                    : task_obj.location_ids ? get_all_loc_obj(task_obj.location_ids) : null,\n        defaults: {\n            parent                  : {},\n            next_child              : {},\n            children                : {}\n        }\n    };\n    return detail ;\n}\n\nfunction get_obj(id, arr){\n    var obj = {} ;\n    if(id && arr.length){\n        for(var i=0; i<arr.length; i++){\n            if(sanitize(id) === sanitize(arr[i]._id)){\n                obj = arr[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction get_task_from_arr(arr){\n    if(arr !== null){\n        if(arr.length){\n            return arr[arr.length - 1];\n        }else{\n            return arr ;\n        }    \n    }\n}\n\nfunction get_all_loc_obj(arr){\n    var obj = {};\n    if(arr !== null){\n        for(var i=0; i< arr.length; i++){\n            if(arr[i]){\n                obj[arr[i]._id] = arr[i] ;\n            }\n        }\n        return obj ;\n    }else{\n        return obj ;\n    }\n}\n\nfunction create_timeout_obj(timeout_obj, users){\n    if(check_obj(timeout_obj.timeout_list) > 0){\n        for(var list in timeout_obj.timeout_list){\n            if(timeout_obj.timeout_list[list]){\n                timeout_obj.timeout_list[list].users = get_delivery_user_ids(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                timeout_obj.timeout_list[list].delivery_user_ids = get_delivery_user_ids(timeout_obj.timeout_list[list].delivery_user_ids, users);\n                timeout_obj.timeout_list[list].template = {\n                    message: {},\n                    from   : {}\n                };\n                timeout_obj.timeout_list[list].defaults = {\n                    parent                  : {},\n                    next_child              : {},\n                    children                : {}\n                };\n            }\n        }\n        return timeout_obj ;   \n    }else{\n        return {} ;\n    }\n}\n\nfunction get_delivery_user_ids(ids, users){\n    var obj = {};\n    if(ids !== null){\n        ids = ids.split(',');\n    }\n    \n    if(users.length){\n        for(var i=0; i< users.length; i++){\n            if(ids.indexOf(users[i]._id) > -1 ){\n                delete users[i].password ;\n                obj[users[i]._id] = users[i];\n            }\n        }\n    }\n    return obj ;\n}\n\nfunction check_obj(obj){\n    var count = 0;\n    for(var keys in obj){\n        if(obj[keys]){\n            count++ ;\n        }\n    }\n    return count ;\n}\n\nfunction sanitize(data){\n    if(data){\n        return data.trim().toString();\n    }\n}\n\nfunction generate_page_id(length) {\n    return Math.floor(Math.pow(10, length-1) + Math.random() * (Math.pow(10, length) - Math.pow(10, length-1) - 1));\n}","outputs":1,"noerr":0,"x":345,"y":435,"wires":[["775b14bc.40363c"]]},{"id":"9499cf7d.153d8","type":"function","z":"13884b4a.5dde85","name":"task name","func":"if(msg.form_data){\n    if(msg.form_data.task_name){\n        msg.payload = {\n            query : \"task_name:\" + msg.form_data.task_name\n        } ;\n    }else{\n        msg.payload = {\n            query: \"\" \n        };\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":674,"y":318,"wires":[["51c9eaa5.8f17c4"]]},{"id":"51c9eaa5.8f17c4","type":"cloudant in","z":"13884b4a.5dde85","name":"by task name","cloudant":"","database":"task_table","service":"PkTwilioConv-cloudantNoSQLDB","search":"_idx_","design":"getTask","index":"searchTask","x":837,"y":318,"wires":[["f950adc6.ebcc1"]]},{"id":"f950adc6.ebcc1","type":"change","z":"13884b4a.5dde85","name":"task_by_name","rules":[{"t":"move","p":"payload","pt":"msg","to":"task_by_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":135,"y":446,"wires":[["ccb4fcb6.f9a24"]]},{"id":"f3aaa1ce.664a5","type":"cloudant in","z":"13884b4a.5dde85","name":"details","cloudant":"","database":"details","service":"PkTwilioConv-cloudantNoSQLDB","search":"_all_","design":"","index":"","x":830,"y":70,"wires":[["cd5514c.e6aebe8"]]},{"id":"cd5514c.e6aebe8","type":"change","z":"13884b4a.5dde85","name":"details_obj","rules":[{"t":"move","p":"payload","pt":"msg","to":"details_obj","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":219,"y":132,"wires":[["3e0141d8.e12ade"]]}]
